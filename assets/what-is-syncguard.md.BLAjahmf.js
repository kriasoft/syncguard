import{_ as i,c as a,o as t,aj as e}from"./chunks/framework.Bbpi2Fiw.js";const c=JSON.parse('{"title":"What is SyncGuard?","description":"","frontmatter":{},"headers":[],"relativePath":"what-is-syncguard.md","filePath":"what-is-syncguard.md","lastUpdated":1764705171000}'),n={name:"what-is-syncguard.md"};function l(h,s,r,p,k,o){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="what-is-syncguard" tabindex="-1">What is SyncGuard? <a class="header-anchor" href="#what-is-syncguard" aria-label="Permalink to ‚ÄúWhat is SyncGuard?‚Äù">‚Äã</a></h1><p>SyncGuard is a distributed lock library for TypeScript that prevents race conditions in distributed systems. It provides a simple API for coordinating access to shared resources using Redis, PostgreSQL, or Firestore as the backend.</p><h2 id="the-problem-race-conditions-in-distributed-systems" tabindex="-1">The Problem: Race Conditions in Distributed Systems <a class="header-anchor" href="#the-problem-race-conditions-in-distributed-systems" aria-label="Permalink to ‚ÄúThe Problem: Race Conditions in Distributed Systems‚Äù">‚Äã</a></h2><p>When multiple services or processes work on the same resource, race conditions happen:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå Without locks: payment processed twice</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">paymentId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> payment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(paymentId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (payment.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> chargeCard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(payment.amount); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Process 1 charges</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(paymentId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;completed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Process 2 also charges!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Two instances read <code>status: &#39;pending&#39;</code> simultaneously. Both charge the card. Oops.</p><div class="danger custom-block"><p class="custom-block-title">Why Database Transactions Aren&#39;t Enough</p><p>Database transactions don&#39;t help when the work involves external APIs (payment processors, emails, webhooks) or spans multiple databases.</p></div><h2 id="the-solution-distributed-locks" tabindex="-1">The Solution: Distributed Locks <a class="header-anchor" href="#the-solution-distributed-locks" aria-label="Permalink to ‚ÄúThe Solution: Distributed Locks‚Äù">‚Äã</a></h2><p>SyncGuard ensures only one process executes the critical section:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { createLock } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;syncguard/firestore&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(db);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚úÖ With locks: only one process wins</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> payment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(paymentId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (payment.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> chargeCard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(payment.amount);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(paymentId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;completed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`payment:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">paymentId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>The <code>lock()</code> function is a high-level wrapper for simple &quot;run-this-exclusively&quot; tasks. For more advanced use cases like rate limiting or conditional locking, you can use the core <code>backend</code> object directly.</p><p>The first process acquires the lock. Others wait or retry. Your customer gets charged once.</p><h2 id="key-features" tabindex="-1">Key Features <a class="header-anchor" href="#key-features" aria-label="Permalink to ‚ÄúKey Features‚Äù">‚Äã</a></h2><ul><li>üî¢ <strong>Fencing tokens</strong> ‚Äî Monotonic counters prevent stale lock holders from corrupting data (see <a href="/syncguard/fencing">Fencing Tokens</a>)</li><li>üßπ <strong>Automatic cleanup</strong> ‚Äî TTL-based expiration means locks release even if your process crashes</li><li>üîê <strong>Ownership tracking</strong> ‚Äî Each lock gets a unique ID; only the owner can release or extend it</li><li>üîÑ <strong>Backend flexibility</strong> ‚Äî Use Redis for speed, PostgreSQL for relational database infrastructure, or Firestore for serverless‚Äîsame API, same guarantees</li><li>üîÅ <strong>Smart retries</strong> ‚Äî Exponential backoff with jitter handles contention automatically</li><li>üíô <strong>TypeScript-first</strong> ‚Äî Compile-time type safety with capability inference</li></ul><h2 id="when-to-use-syncguard" tabindex="-1">When to Use SyncGuard <a class="header-anchor" href="#when-to-use-syncguard" aria-label="Permalink to ‚ÄúWhen to Use SyncGuard‚Äù">‚Äã</a></h2><h3 id="‚úÖ-perfect-for" tabindex="-1">‚úÖ Perfect For <a class="header-anchor" href="#‚úÖ-perfect-for" aria-label="Permalink to ‚Äú‚úÖ Perfect For‚Äù">‚Äã</a></h3><p><strong>Preventing duplicate processing</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Ensure job runs exactly once across workers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processJob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(jobId), { key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`job:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">jobId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><p><strong>Idempotency enforcement</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Webhook received multiple times? Handle once</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleWebhook</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(eventId), { key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`webhook:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">eventId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><p><strong>Rate limiting</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// One request per user per minute</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`rate:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">userId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result.ok) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Rate limit exceeded&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>Scheduled tasks</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Daily report generated by any instance, but only once</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateDailyReport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cron:daily-report&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Resource coordination</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Prevent concurrent deploys</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> deployToProduction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), { key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy:prod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><h2 id="when-not-to-use-syncguard" tabindex="-1">When NOT to Use SyncGuard <a class="header-anchor" href="#when-not-to-use-syncguard" aria-label="Permalink to ‚ÄúWhen NOT to Use SyncGuard‚Äù">‚Äã</a></h2><h3 id="‚ùå-anti-patterns" tabindex="-1">‚ùå Anti-Patterns <a class="header-anchor" href="#‚ùå-anti-patterns" aria-label="Permalink to ‚Äú‚ùå Anti-Patterns‚Äù">‚Äã</a></h3><div class="warning custom-block"><p class="custom-block-title">High-Frequency Operations</p><p>Don&#39;t use locks for every API request or database query. Network round-trip per lock acquisition adds latency (~1-50ms). Consider optimistic concurrency or database locks instead.</p></div><p><strong>Short critical sections</strong></p><ul><li>If your critical section is faster than acquiring the lock, you&#39;re doing it wrong</li><li>Example: incrementing a Redis counter (use <code>INCR</code> instead)</li></ul><p><strong>Within database transactions</strong></p><ul><li>Database transactions already provide isolation</li><li>Locks are for coordinating work <em>outside</em> a single database</li></ul><p><strong>As a queue replacement</strong></p><ul><li>Locks coordinate access, they don&#39;t distribute work</li><li>Use Redis Streams, SQS, Pub/Sub, etc. for job queues</li></ul><p><strong>Long-running workflows without extension</strong></p><ul><li>Locks expire via TTL (default: 30s)</li><li>For long tasks, use <code>backend.extend()</code> periodically or break into smaller steps</li></ul><h2 id="how-it-works" tabindex="-1">How It Works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to ‚ÄúHow It Works‚Äù">‚Äã</a></h2><ol><li><strong>Acquire</strong>: Request lock with unique key (e.g., <code>payment:123</code>)</li><li><strong>Execute</strong>: Run your critical section while holding the lock</li><li><strong>Release</strong>: Free the lock for others (or let TTL expire automatically)</li></ol><div class="info custom-block"><p class="custom-block-title">Atomic Operations Guarantee</p><p>SyncGuard uses atomic operations (Lua scripts for Redis, transactions for PostgreSQL and Firestore) to ensure:</p><ul><li>No race window between checking and acquiring</li><li>Ownership verified before release/extend (see ADR-003)</li><li>Monotonic fence tokens for stale lock protection</li></ul><p><strong>Deep dive</strong>: See <a href="https://github.com/kriasoft/syncguard/blob/main/docs/specs/interface.md" target="_blank" rel="noreferrer">docs/specs/interface.md</a> for TOCTOU protection requirements and atomicity guarantees.</p></div>`,40)])])}const g=i(n,[["render",l]]);export{c as __pageData,g as default};
