import{_ as s,c as e,o as a,aj as n}from"./chunks/framework.Bbpi2Fiw.js";const o=JSON.parse('{"title":"ADR-008 Compile-Time Fencing Contract","description":"","frontmatter":{},"headers":[],"relativePath":"adr/008-compile-time-fencing.md","filePath":"adr/008-compile-time-fencing.md","lastUpdated":1764705171000}'),t={name:"adr/008-compile-time-fencing.md"};function l(r,i,h,p,k,c){return a(),e("div",null,[...i[0]||(i[0]=[n(`<h1 id="adr-008-compile-time-fencing-contract" tabindex="-1">ADR-008 Compile-Time Fencing Contract <a class="header-anchor" href="#adr-008-compile-time-fencing-contract" aria-label="Permalink to “ADR-008 Compile-Time Fencing Contract”">​</a></h1><p><strong>Status:</strong> Accepted <strong>Date:</strong> 2025-10 <strong>Tags:</strong> typescript, api-design, type-safety</p><h2 id="problem" tabindex="-1">Problem <a class="header-anchor" href="#problem" aria-label="Permalink to “Problem”">​</a></h2><p>The specification claimed &quot;TypeScript knows fence exists&quot; for Redis/Firestore, yet the type system required optional fence fields, forcing runtime assertions (<code>expectFence</code>/<code>hasFence</code>) even when backends guaranteed fencing support.</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>Parameterize result types by capabilities so fence is <strong>required</strong> when <code>supportsFencing: true</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AcquireOk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;supportsFencing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extends</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Fence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {});</span></span></code></pre></div><ul><li>Direct access to <code>result.fence</code> for fencing backends—no assertions needed</li><li>Keep only <code>hasFence()</code> for generic code accepting unknown backends</li></ul><h2 id="alternatives-brief" tabindex="-1">Alternatives (brief) <a class="header-anchor" href="#alternatives-brief" aria-label="Permalink to “Alternatives (brief)”">​</a></h2><ul><li>Optional fence everywhere — runtime assertions required, poor DX</li><li>Separate backend types — API complexity, code duplication</li></ul><h2 id="impact" tabindex="-1">Impact <a class="header-anchor" href="#impact" aria-label="Permalink to “Impact”">​</a></h2><ul><li>Positive: Zero boilerplate, type safety, cleaner API, delivers promised ergonomics</li><li>Negative/Risks: Breaking change—<code>AcquireResult</code> becomes generic</li></ul><h2 id="links" tabindex="-1">Links <a class="header-anchor" href="#links" aria-label="Permalink to “Links”">​</a></h2><ul><li>Code/Docs: <code>common/types.ts</code>, <code>docs/specs/interface.md</code></li><li>Related ADRs: None</li></ul>`,14)])])}const g=s(t,[["render",l]]);export{o as __pageData,g as default};
