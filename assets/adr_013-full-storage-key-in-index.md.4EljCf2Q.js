import{_ as r,c as i,o as a,aj as t}from"./chunks/framework.Bbpi2Fiw.js";const p=JSON.parse('{"title":"ADR-013 Store Full Storage Key in Reverse Index","description":"","frontmatter":{},"headers":[],"relativePath":"adr/013-full-storage-key-in-index.md","filePath":"adr/013-full-storage-key-in-index.md","lastUpdated":1764705171000}'),n={name:"adr/013-full-storage-key-in-index.md"};function o(s,e,l,c,d,u){return a(),i("div",null,[...e[0]||(e[0]=[t('<h1 id="adr-013-store-full-storage-key-in-reverse-index" tabindex="-1">ADR-013 Store Full Storage Key in Reverse Index <a class="header-anchor" href="#adr-013-store-full-storage-key-in-reverse-index" aria-label="Permalink to “ADR-013 Store Full Storage Key in Reverse Index”">​</a></h1><p><strong>Status:</strong> Accepted <strong>Date:</strong> 2025-10 <strong>Tags:</strong> redis, correctness, truncation</p><h2 id="problem" tabindex="-1">Problem <a class="header-anchor" href="#problem" aria-label="Permalink to “Problem”">​</a></h2><p>Redis reverse mapping stored the original user key, but release/extend reconstructed the lock key via <code>{prefix}:{originalKey}</code>. When key truncation occurred (per ADR-006), reconstruction produced a different key than the truncated form used during acquire—breaking TOCTOU protection.</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>The reverse index MUST store the full computed storage key (post-truncation), not the original user key. Eliminate key reconstruction entirely.</p><ul><li>Index always returns exactly the key used during acquire</li><li>Works under all conditions—truncated or not</li><li>Removes reconstruction logic from scripts</li></ul><h2 id="alternatives-brief" tabindex="-1">Alternatives (brief) <a class="header-anchor" href="#alternatives-brief" aria-label="Permalink to “Alternatives (brief)”">​</a></h2><ul><li>Fix reconstruction logic — still fragile, future changes risk re-breaking</li><li>Disable truncation for index — doesn&#39;t solve mismatch</li><li>Separate truncation for index — complexity explosion</li></ul><h2 id="impact" tabindex="-1">Impact <a class="header-anchor" href="#impact" aria-label="Permalink to “Impact”">​</a></h2><ul><li>Positive: Eliminates correctness bug, simplifies scripts, testable truncation path</li><li>Negative/Risks: Breaking change for index format (acceptable pre-1.0)</li></ul><h2 id="links" tabindex="-1">Links <a class="header-anchor" href="#links" aria-label="Permalink to “Links”">​</a></h2><ul><li>Code/Docs: <code>redis/scripts.ts</code>, <code>redis/operations/*.ts</code></li><li>Related ADRs: ADR-003 (ownership verification), ADR-006 (key truncation)</li></ul>',13)])])}const f=r(n,[["render",o]]);export{p as __pageData,f as default};
