import{_ as i,c as t,o as a,aj as r}from"./chunks/framework.Bbpi2Fiw.js";const f=JSON.parse('{"title":"ADR-014 Defensive Detection of Duplicate LockId Documents (Firestore)","description":"","frontmatter":{},"headers":[],"relativePath":"adr/014-firestore-duplicate-detection.md","filePath":"adr/014-firestore-duplicate-detection.md","lastUpdated":1764705171000}'),o={name:"adr/014-firestore-duplicate-detection.md"};function s(n,e,l,c,d,p){return a(),t("div",null,[...e[0]||(e[0]=[r('<h1 id="adr-014-defensive-detection-of-duplicate-lockid-documents-firestore" tabindex="-1">ADR-014 Defensive Detection of Duplicate LockId Documents (Firestore) <a class="header-anchor" href="#adr-014-defensive-detection-of-duplicate-lockid-documents-firestore" aria-label="Permalink to “ADR-014 Defensive Detection of Duplicate LockId Documents (Firestore)”">​</a></h1><p><strong>Status:</strong> Accepted <strong>Date:</strong> 2025-10 <strong>Tags:</strong> firestore, defensive-programming, consistency</p><h2 id="problem" tabindex="-1">Problem <a class="header-anchor" href="#problem" aria-label="Permalink to “Problem”">​</a></h2><p>Firestore lacks database-level unique indexes. The library queries by lockId using <code>.limit(1)</code>, which returns an arbitrary document when duplicates exist. Bugs, migrations, or manual interventions could create duplicates that go undetected.</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>Add defensive duplicate detection for Firestore lockId queries:</p><ul><li>Remove <code>.limit(1)</code> from lockId queries to enable detection</li><li>When <code>querySnapshot.docs.length &gt; 1</code>, treat as internal inconsistency</li><li>Log warning with context (not error—defensive measure)</li><li>MAY delete expired duplicates; SHOULD fail-safe on live duplicates</li><li>Applies to release, extend, and lookup operations</li></ul><h2 id="alternatives-brief" tabindex="-1">Alternatives (brief) <a class="header-anchor" href="#alternatives-brief" aria-label="Permalink to “Alternatives (brief)”">​</a></h2><ul><li>Keep .limit(1) — duplicates remain invisible</li><li>Fail hard on duplicates — too aggressive for defensive check</li></ul><h2 id="impact" tabindex="-1">Impact <a class="header-anchor" href="#impact" aria-label="Permalink to “Impact”">​</a></h2><ul><li>Positive: Catches data inconsistencies, operational visibility, safe cleanup</li><li>Negative/Risks: Negligible—indexed queries are fast, duplicates shouldn&#39;t exist</li></ul><h2 id="links" tabindex="-1">Links <a class="header-anchor" href="#links" aria-label="Permalink to “Links”">​</a></h2><ul><li>Code/Docs: <code>firestore/operations/*.ts</code>, <code>docs/specs/firestore-backend.md</code></li><li>Related ADRs: ADR-003 (ownership verification)</li></ul>',13)])])}const h=i(o,[["render",s]]);export{f as __pageData,h as default};
