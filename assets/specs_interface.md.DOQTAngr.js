import{_ as i,c as e,o as a,aj as n}from"./chunks/framework.Bbpi2Fiw.js";const c=JSON.parse('{"title":"Common Lock Interface Specification","description":"","frontmatter":{},"headers":[],"relativePath":"specs/interface.md","filePath":"specs/interface.md","lastUpdated":1764705171000}'),t={name:"specs/interface.md"};function l(r,s,h,o,p,k){return a(),e("div",null,[...s[0]||(s[0]=[n(`<h1 id="common-lock-interface-specification" tabindex="-1">Common Lock Interface Specification <a class="header-anchor" href="#common-lock-interface-specification" aria-label="Permalink to “Common Lock Interface Specification”">​</a></h1><p>This document defines the core interface and behavioral requirements that all SyncGuard backend implementations must follow.</p><hr><h2 id="document-structure" tabindex="-1">Document Structure <a class="header-anchor" href="#document-structure" aria-label="Permalink to “Document Structure”">​</a></h2><p>This specification uses a <strong>normative vs rationale</strong> pattern:</p><ul><li><strong>Requirements</strong> sections contain MUST/SHOULD/MAY/NEVER statements defining the contract</li><li><strong>Rationale &amp; Notes</strong> sections provide background, design decisions, and operational guidance</li></ul><p><strong>Backend Delta Pattern:</strong></p><p>Backend-specific specifications (redis-backend.md, postgres-backend.md, firestore-backend.md) extend this common interface specification. To enhance machine-parseability and prevent agent drift:</p><ul><li>Backend specs MUST restate key inherited requirements (e.g., authoritative expiresAtMs) in their operation requirement sections</li><li>Restatements provide explicit MUST/SHOULD bullets in normative tables for agent parsing</li><li>Cross-references to this specification (e.g., &quot;see ADR-010&quot;) provide rationale without redundancy</li><li>This pattern ensures agents can verify compliance from backend-specific operation tables alone</li></ul><hr><h2 id="core-constants" tabindex="-1">Core Constants <a class="header-anchor" href="#core-constants" aria-label="Permalink to “Core Constants”">​</a></h2><h3 id="requirements" tabindex="-1">Requirements <a class="header-anchor" href="#requirements" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Maximum key length after Unicode NFC normalization and UTF-8 encoding</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MAX_KEY_LENGTH_BYTES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 512</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backend defaults - used by all backend implementations</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BACKEND_DEFAULTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 30 seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Note: For retry configuration, see the lock() helper function.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backends do not implement retries - they perform single-attempt operations only.</span></span></code></pre></div><ul><li>Backends MUST validate user-supplied key length after <code>key.normalize(&#39;NFC&#39;)</code> and UTF-8 encoding</li><li>User keys exceeding <code>MAX_KEY_LENGTH_BYTES</code> MUST throw <code>LockError(&#39;InvalidArgument&#39;)</code></li><li>This limit applies to the user-supplied key before any backend-specific prefixing or namespacing</li><li>Validation MUST occur before any lock operations (acquire, isLocked, etc.)</li></ul><h3 id="rationale-notes" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why 512 bytes</strong>: Balances expressiveness with DoS protection. Prevents resource exhaustion from excessively large keys while accommodating complex namespacing patterns.</p><p><strong>Why normalize first</strong>: Unicode NFC normalization ensures consistent byte length calculations across platforms and prevents ambiguous key matching.</p><hr><h2 id="storage-key-generation" tabindex="-1">Standardized Storage Key Generation <a class="header-anchor" href="#storage-key-generation" aria-label="Permalink to “Standardized Storage Key Generation”">​</a></h2><h3 id="requirements-1" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-1" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>NORMATIVE IMPLEMENTATION</strong>: See <code>makeStorageKey()</code> in <code>common/crypto.ts</code></p><p>All backends MUST use the canonical <code>makeStorageKey()</code> function from common utilities. Custom implementations are FORBIDDEN.</p><p><strong>Hash Truncation Algorithm</strong> (when key exceeds backend limits):</p><ol><li><strong>Compute SHA-256</strong>: Hash the full prefixed key <code>&lt;prefix + &#39;:&#39; + normalizedKey&gt;</code> using SHA-256 (produces 256-bit/32-byte digest)</li><li><strong>Truncate to 128 bits</strong>: Take the <strong>first 16 bytes</strong> of the SHA-256 digest (big-endian byte order)</li><li><strong>Encode as base64url</strong>: Convert the 16-byte truncated digest to base64url encoding (no padding) → 22 characters</li><li><strong>Construct storage key</strong>: Combine as <code>&lt;prefix + &#39;:&#39; + base64url_hash&gt;</code> or just <code>&lt;base64url_hash&gt;</code> if no prefix</li></ol><p><strong>Collision Resistance</strong>: The 128-bit truncated digest provides ~2.8e-39 collision probability at 10^9 distinct keys.</p><p><strong>Function Characteristics:</strong></p><ul><li><strong>Byte-accurate limits</strong>: Measures UTF-8 byte length, not string length</li><li><strong>Reserve capacity</strong>: Accounts for derived key suffixes (fence, index) via <code>reserveBytes</code> parameter</li><li><strong>Namespace-safe</strong>: Hashes full prefixed key to prevent cross-prefix collisions</li><li><strong>Deterministic</strong>: Same inputs always produce same output</li><li><strong>Compact encoding</strong>: Base64url format (22 chars for 128-bit hash vs. 32 for hex)</li><li><strong>Defensive normalization</strong>: Applies Unicode NFC normalization for canonical hashing</li><li><strong>Fail-fast validation</strong>: Throws if prefix + reserve makes valid keys impossible</li></ul><p><strong>Backend-Specific Parameters:</strong></p><ul><li><strong>Redis</strong>: 26 bytes reserve (<code>&quot;:id:&quot; (4) + lockId (22) = 26</code>) for dual-key storage pattern</li><li><strong>Firestore</strong>: 0 bytes reserve (independent document IDs for all key types)</li><li>See <code>RESERVE_BYTES</code> and <code>BACKEND_LIMITS</code> constants in <code>common/constants.ts</code></li></ul><p><strong>Storage Key Limits:</strong></p><p>When the prefixed storage key <code>prefix:userKey</code> exceeds the backend&#39;s storage limit, backends MUST apply the standardized hash-truncation scheme. Backends MUST throw <code>LockError(&#39;InvalidArgument&#39;)</code> only if even the truncated form exceeds the backend&#39;s absolute limit (e.g., prefix too long).</p><h3 id="rationale-notes-1" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-1" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why centralized function</strong>: Single implementation ensures cross-backend consistency. Prevents subtle bugs from implementation drift.</p><p><strong>Why hash truncation</strong>: Allows predictable behavior across backends. Same user key produces same storage key regardless of backend, enabling consistent testing and debugging.</p><p><strong>Why reserve bytes</strong>: Different backends have different derived key patterns. Redis needs suffix space for index keys, Firestore uses independent document IDs. Reserve parameter makes this explicit.</p><hr><h2 id="fence-key-derivation" tabindex="-1">Two-Step Fence Key Derivation Pattern <a class="header-anchor" href="#fence-key-derivation" aria-label="Permalink to “Two-Step Fence Key Derivation Pattern”">​</a></h2><h3 id="requirements-2" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-2" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>NORMATIVE SPECIFICATION</strong>: To ensure 1:1 mapping between lock keys and fence counters, ALL backends MUST use this two-step derivation pattern:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Step 1: Compute base storage key for the lock</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> baseKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  prefix,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  normalizedUserKey,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  backendLimit,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  reserveBytes,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Step 2: Derive fence key from the base storage key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fenceKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  prefix,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  \`fence:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  backendLimit,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  reserveBytes,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>Critical Requirement</strong>: Fence keys MUST be derived from the <strong>base storage key</strong> (not directly from the user key).</p><p><strong>Application</strong>: This pattern applies to:</p><ul><li><strong>Main lock keys</strong>: Direct use of <code>baseKey = makeStorageKey(prefix, userKey, limit, reserve)</code></li><li><strong>Reverse index keys</strong>: <code>indexKey = makeStorageKey(prefix, &#39;id:\${lockId}&#39;, limit, reserve)</code> (independent of baseKey)</li><li><strong>Fence counter keys</strong>: <code>fenceKey = makeStorageKey(prefix, &#39;fence:\${baseKey}&#39;, limit, reserve)</code> (derived from baseKey)</li></ul><p><strong>Backend Implementation Mandate</strong>: All backend specifications reference this normative pattern; backends MUST NOT implement custom key derivation logic.</p><h3 id="rationale-notes-2" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-2" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why two-step derivation</strong>: Ensures that when truncation occurs, both lock and fence keys hash the user key identically. This guarantees each distinct user key maps to a unique fence counter.</p><p><strong>Without this pattern</strong>: Different user keys could map to the same fence counter when hash truncation occurs, violating the monotonicity guarantee for fencing tokens.</p><p><strong>1:1 mapping guarantee</strong>: Critical for fence token correctness. Each resource must have its own independent counter to maintain strict ordering.</p><hr><h2 id="public-types-normative" tabindex="-1">Public Types (Normative) <a class="header-anchor" href="#public-types-normative" aria-label="Permalink to “Public Types (Normative)”">​</a></h2><p>This section defines the <strong>normative type shapes</strong> for SyncGuard&#39;s public API. These types establish the contract that all implementations MUST follow.</p><p><strong>TypeScript Reference Implementation</strong>: See <code>common/types.ts</code> for the canonical TypeScript definitions that implement this specification.</p><h3 id="hash-identifier-format" tabindex="-1">Hash Identifier Format <a class="header-anchor" href="#hash-identifier-format" aria-label="Permalink to “Hash Identifier Format”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Hash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 24-character hex string (96-bit non-cryptographic hash)</span></span></code></pre></div><p><strong>Requirements:</strong></p><ul><li><strong>Algorithm</strong>: Triple-hash (3×32-bit) for 96-bit collision resistance</li><li><strong>Encoding</strong>: Lowercase hexadecimal, exactly 24 characters</li><li><strong>Normalization</strong>: Input MUST be Unicode NFC normalized before hashing</li><li><strong>Collision Probability</strong>: ~6.3e-12 at 10^9 distinct keys</li><li><strong>Canonical Implementation</strong>: <code>hashKey()</code> in <code>common/crypto.ts</code></li><li><strong>Use Case</strong>: Sanitized identifiers for telemetry, logging, and UI (non-cryptographic)</li></ul><p><strong>Security Note</strong>: This is a <strong>non-cryptographic hash</strong> for observability only. Do NOT use for security-sensitive collision resistance.</p><hr><h3 id="lock-information-types" tabindex="-1">Lock Information Types <a class="header-anchor" href="#lock-information-types" aria-label="Permalink to “Lock Information Types”">​</a></h3><h4 id="lockinfo-sanitized-output" tabindex="-1">LockInfo (Sanitized Output) <a class="header-anchor" href="#lockinfo-sanitized-output" aria-label="Permalink to “LockInfo (Sanitized Output)”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  keyHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 24-char hex hash of the key</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockIdHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 24-char hex hash of the lockId</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Unix timestamp (milliseconds)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  acquiredAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Unix timestamp (milliseconds)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Fence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Present when C[&quot;supportsFencing&quot;] === true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Requirements:</strong></p><ul><li>All <code>lookup()</code> operations MUST return this sanitized shape (never raw keys/lockIds)</li><li><code>keyHash</code> and <code>lockIdHash</code> MUST be computed via <code>hashKey()</code> from <code>common/crypto.ts</code></li><li><code>expiresAtMs</code> and <code>acquiredAtMs</code> MUST be Unix timestamps in milliseconds</li><li><code>fence</code> MUST be included if and only if <code>backend.capabilities.supportsFencing === true</code></li><li>Returns <code>null</code> for both expired and not-found locks (no distinction in public API)</li></ul><p><strong>Rationale</strong>: Prevents accidental logging of sensitive identifiers. Security-first design with compile-time guarantees.</p><hr><h4 id="lockinfodebug-raw-identifiers-for-debugging" tabindex="-1">LockInfoDebug (Raw Identifiers for Debugging) <a class="header-anchor" href="#lockinfodebug-raw-identifiers-for-debugging" aria-label="Permalink to “LockInfoDebug (Raw Identifiers for Debugging)”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockInfoDebug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Raw user-provided key (SENSITIVE)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Raw lock identifier (SENSITIVE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Requirements:</strong></p><ul><li>Available ONLY via <code>getByKeyRaw()</code> and <code>getByIdRaw()</code> helper functions (NOT from <code>backend.lookup()</code>)</li><li>MUST include all fields from <code>LockInfo&lt;C&gt;</code> plus raw identifiers</li><li><strong>SECURITY WARNING</strong>: Contains sensitive data - use only for debugging/diagnostics</li></ul><p><strong>Rationale</strong>: Explicit opt-in for raw data access. Prevents accidental exposure in production logs.</p><hr><h3 id="telemetry-event-types" tabindex="-1">Telemetry Event Types <a class="header-anchor" href="#telemetry-event-types" aria-label="Permalink to “Telemetry Event Types”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockEvent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;acquire&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;release&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;extend&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;isLocked&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lookup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ok&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fail&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  keyHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Present when operation involves a key</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockIdHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Present when operation involves a lockId</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  reason</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;locked&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;expired&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;not-found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Raw key (only when includeRaw permits)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Raw lockId (only when includeRaw permits)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>Requirements:</strong></p><ul><li>Emitted by <code>withTelemetry()</code> decorator when telemetry is enabled</li><li><code>type</code> MUST be one of the five core operations</li><li><code>result</code> MUST be either &quot;ok&quot; (success) or &quot;fail&quot; (failure)</li><li><code>keyHash</code>/<code>lockIdHash</code> computed lazily only when telemetry active (zero-cost when disabled)</li><li><code>reason</code> field semantics: <ul><li><strong>&quot;locked&quot;</strong>: Acquire failed due to contention (key already held)</li><li><strong>&quot;expired&quot;</strong>: Operation failed because lock expired before mutation</li><li><strong>&quot;not-found&quot;</strong>: Operation failed because lock doesn&#39;t exist</li></ul></li><li><code>key</code> and <code>lockId</code> raw fields MUST only be present when <code>includeRaw</code> configuration permits</li><li>Telemetry callbacks MUST NOT be awaited; errors MUST NOT affect lock operations (async isolation)</li></ul><p><strong>Operation-Specific Reason Values:</strong></p><table tabindex="0"><thead><tr><th>Operation</th><th>Success (<code>ok: true</code>)</th><th>Failure (<code>ok: false</code>) Reasons</th></tr></thead><tbody><tr><td><code>acquire</code></td><td>No reason</td><td><code>&quot;locked&quot;</code></td></tr><tr><td><code>release</code></td><td>No reason</td><td><code>&quot;expired&quot;</code> | <code>&quot;not-found&quot;</code></td></tr><tr><td><code>extend</code></td><td>No reason</td><td><code>&quot;expired&quot;</code> | <code>&quot;not-found&quot;</code></td></tr><tr><td><code>isLocked</code></td><td>No reason</td><td>No reason (boolean result)</td></tr><tr><td><code>lookup</code></td><td>No reason</td><td>No reason (null result)</td></tr></tbody></table><p><strong>Rationale</strong>:</p><ul><li>Detailed reasons for operational monitoring without cluttering public API</li><li>&quot;expired&quot; vs &quot;not-found&quot; distinction helps diagnose cleanup lag vs logic errors</li><li>Zero-cost abstraction when telemetry disabled (no hash computation overhead)</li></ul><hr><h2 id="backend-capabilities" tabindex="-1">Backend Capabilities <a class="header-anchor" href="#backend-capabilities" aria-label="Permalink to “Backend Capabilities”">​</a></h2><h3 id="requirements-3" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-3" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backend capability declaration for type-safe feature detection</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  supportsFencing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Whether backend generates fence tokens</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  timeAuthority</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;server&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;client&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Time authority model used</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>All backends MUST declare their capabilities for compile-time type safety and runtime introspection.</p><h3 id="rationale-notes-3" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-3" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Compile-time benefits</strong>: TypeScript can enforce presence/absence of optional fields (e.g., fence tokens) based on capabilities.</p><p><strong>Runtime introspection</strong>: Applications can query capabilities to adapt behavior or provide appropriate warnings.</p><hr><h2 id="lockbackend-interface" tabindex="-1">LockBackend Interface <a class="header-anchor" href="#lockbackend-interface" aria-label="Permalink to “LockBackend Interface”">​</a></h2><h3 id="requirements-4" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-4" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Base operation types for consistent parameter patterns</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyOp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Readonly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockOp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Readonly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Lookup operation types</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyLookup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// O(1) direct access</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OwnershipLookup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// reverse lookup + verification</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  acquire</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyOp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttlMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AcquireResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  release</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockOp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ReleaseResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  extend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockOp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttlMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ExtendResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  isLocked</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyOp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** Lookup lock information by key (direct O(1) access) */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyLookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** Lookup lock information by lockId (reverse lookup + verification) */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OwnershipLookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Implementation signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KeyLookup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OwnershipLookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> capabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Readonly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Required capability introspection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Lookup Invariants:</strong></p><ul><li>Always returns sanitized data (keyHash/lockIdHash, never raw keys/lockIds)</li><li>Consistent return shape regardless of lookup method (key vs lockId)</li><li>Prevents accidental logging of sensitive identifiers</li><li>Includes expiresAtMs and acquiredAtMs timestamps (Unix ms)</li><li>Includes fence when backend.capabilities.supportsFencing === true</li><li>Returns null for both expired and not-found locks (no distinction)</li><li>For raw key/lockId access, use <code>getByKeyRaw()</code>/<code>getByIdRaw()</code> helper functions</li></ul><p><strong>CRITICAL SANITIZATION REQUIREMENT:</strong></p><ul><li>Implementations MUST sanitize data before returning from public lookup() methods</li><li>Internal/raw transport (e.g., Lua script returns, internal JSON) is an implementation detail</li><li>Raw keys/lockIds MUST NEVER surface to users through the public API</li><li>Only sanitized keyHash/lockIdHash via hashKey() may be exposed</li><li>Violation of this requirement is a security and API contract failure</li></ul><h3 id="rationale-notes-4" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-4" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why discriminated overloads</strong>: Provides compile-time safety and better IntelliSense. TypeScript enforces correct parameter combinations.</p><p><strong>Why sanitized by default</strong>: Prevents accidental logging of sensitive identifiers. Security-first design.</p><p><strong>Why lookup is required</strong>: Essential for ownership checking, diagnostics, and operational monitoring. Not an optional feature.</p><hr><h2 id="result-types" tabindex="-1">Result Types <a class="header-anchor" href="#result-types" aria-label="Permalink to “Result Types”">​</a></h2><h3 id="requirements-5" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-5" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Success or Contention only (acquisition timeout throws LockError)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AcquireOk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;supportsFencing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extends</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Fence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AcquireResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AcquireOk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">      ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">      reason</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;locked&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Simplified release/extend results</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReleaseResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// release success never includes expiresAtMs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lock was absent (expired or never existed)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ExtendResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// expiresAtMs required for heartbeat scheduling</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lock was absent (expired or never existed)</span></span></code></pre></div><p><strong>Fence Token Compile-Time Guarantee</strong>: Fence tokens are required in the type system when <code>backend.capabilities.supportsFencing === true</code>. All v1 backends (Redis, PostgreSQL, Firestore) provide fencing tokens. Non-fencing backends are out of scope for v1.</p><p><strong>Time fields:</strong> All core types use <code>expiresAtMs</code> / <code>acquiredAtMs</code> (Unix ms) for consistency and wire/JSON optimization. Helper utilities MAY provide Date conversion when convenient for consumers.</p><p><strong>Simplified Semantics:</strong> With lockId-only operations, ownership conflicts cannot occur since each lockId maps to exactly one key via reverse mapping. Failed operations indicate the lock was absent for any reason.</p><h3 id="rationale-notes-5" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-5" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why compile-time fence</strong>: Eliminates runtime assertions for backends that always provide fencing. Better developer experience.</p><p><strong>Why simplified results</strong>: Public API focuses on success/failure. Internal conditions (expired vs not-found) tracked cheaply for telemetry but not exposed in primary API.</p><p><strong>Why expiresAtMs in extend</strong>: Critical for heartbeat scheduling. Callers need to know exact expiry to schedule next extend operation.</p><hr><h2 id="resource-management-optional" tabindex="-1">Resource Management (Optional) <a class="header-anchor" href="#resource-management-optional" aria-label="Permalink to “Resource Management (Optional)”">​</a></h2><p>Acquire results MAY implement <code>AsyncDisposable</code> for automatic cleanup with <code>await using</code> syntax (Node.js ≥20).</p><h3 id="requirements-6" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-6" aria-label="Permalink to “Requirements”">​</a></h3><ul><li>Disposal MUST be idempotent (safe to call multiple times)</li><li>Disposal MUST NOT throw (errors routed to optional <code>onReleaseError</code> callback)</li><li>When <code>ok: true</code>: disposal delegates to <code>release({ lockId })</code></li><li>When <code>ok: false</code>: disposal is a no-op</li></ul><h3 id="handle-methods" tabindex="-1">Handle Methods <a class="header-anchor" href="#handle-methods" aria-label="Permalink to “Handle Methods”">​</a></h3><p>Successful acquisitions (<code>ok: true</code>) provide handle methods for manual control:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DisposableLockHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ReleaseResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  extend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttlMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ExtendResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [Symbol.asyncDispose]()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>Both <code>release()</code> and <code>extend()</code> accept optional <code>AbortSignal</code> for operation cancellation</li><li>Signal parameters maintain API consistency with backend methods (<code>release(opts: LockOp)</code>, <code>extend(opts: LockOp &amp; { ttlMs })</code>)</li><li>Methods forward signals to backend operations for responsive cancellation</li><li>Per-operation signal control enables independent cancellation of different operations</li></ul><h3 id="configuration" tabindex="-1">Configuration <a class="header-anchor" href="#configuration" aria-label="Permalink to “Configuration”">​</a></h3><p>Error callbacks can be configured at two levels:</p><ul><li><strong>Backend-level</strong>: <code>createBackend({ onReleaseError })</code> - applies to <code>await using</code> disposal</li><li><strong>Lock-level</strong>: <code>lock({ onReleaseError })</code> - applies to <code>lock()</code> helper cleanup</li></ul><p>These are independent configurations for different usage patterns. See <code>common/disposable.ts</code> for usage examples.</p><h3 id="runtime-support" tabindex="-1">Runtime Support <a class="header-anchor" href="#runtime-support" aria-label="Permalink to “Runtime Support”">​</a></h3><p><code>await using</code> requires Node.js ≥20. For older runtimes, use <code>try/finally</code> patterns.</p><h3 id="rationale-notes-6" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-6" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why optional</strong>: Additive feature that doesn&#39;t change existing contracts. Enhances DX without breaking compatibility.</p><p><strong>Why dual configuration</strong>: Backend-level suits low-level <code>await using</code> API; lock-level suits high-level <code>lock()</code> helper. Users typically choose one pattern.</p><p><strong>Why idempotent</strong>: Safe disposal on all code paths, including early returns and exceptions.</p><hr><h2 id="fence-token-format" tabindex="-1">Fence Token Format <a class="header-anchor" href="#fence-token-format" aria-label="Permalink to “Fence Token Format”">​</a></h2><h3 id="requirements-7" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-7" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fencing token types</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fixed-width decimal strings with lexicographic ordering</span></span></code></pre></div><p><strong>Format Contract:</strong></p><ul><li>15-digit zero-padded decimal strings (e.g., &quot;000000000000001&quot;)</li><li>Higher fence values are lexicographically larger strings</li><li>Use direct string comparison: <code>fenceA &gt; fenceB</code>, <code>fenceA === fenceB</code></li><li>All backends use identical 15-digit zero-padded format</li></ul><p><strong>Overflow Enforcement:</strong></p><ul><li>Backends MUST throw LockError(&quot;Internal&quot;) if fence &gt; <code>FENCE_THRESHOLDS.MAX</code></li><li>Backends MUST log warnings via <code>logFenceWarning()</code> when fence &gt; <code>FENCE_THRESHOLDS.WARN</code></li><li>Canonical threshold values are defined in <code>common/constants.ts</code> as <code>FENCE_THRESHOLDS.MAX</code> and <code>FENCE_THRESHOLDS.WARN</code></li></ul><p><strong>Rationale:</strong> Fence format and overflow guard are defined by ADR-004; this document normatively references that ADR.</p><h3 id="fence-token-usage-patterns" tabindex="-1">Fence Token Usage Patterns <a class="header-anchor" href="#fence-token-usage-patterns" aria-label="Permalink to “Fence Token Usage Patterns”">​</a></h3><h4 id="✅-correct-usage" tabindex="-1">✅ Correct Usage <a class="header-anchor" href="#✅-correct-usage" aria-label="Permalink to “✅ Correct Usage”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Compare fence tokens using lexicographic string comparison</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// IMPORTANT: Don&#39;t parse - compare as strings only (per ADR-004)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceB;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> same</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceB;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> older</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceB;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Store/transmit as strings (JSON-safe, no precision loss)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lastFence&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fence);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> api.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ fence });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Sort fences lexicographically</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sortedFences</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fences.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Lexicographic = chronological order</span></span></code></pre></div><h4 id="❌-avoid-these-patterns" tabindex="-1">❌ Avoid These Patterns <a class="header-anchor" href="#❌-avoid-these-patterns" aria-label="Permalink to “❌ Avoid These Patterns”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// DON&#39;T: Parse as numbers (not needed and may lose precision)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> num</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parseInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fence); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ Unnecessary</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// DON&#39;T: Modify the format (breaks ordering)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> trimmed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ Breaks comparison</span></span></code></pre></div><h3 id="rationale-notes-7" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-7" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why strings</strong>: JSON-safe, cross-language compatible, no precision loss. All platforms can compare strings lexicographically.</p><p><strong>Why 15 digits</strong>: Guarantees full safety within Lua&#39;s 53-bit precision (2^53-1 ≈ 9.007e15). Provides 10^15 capacity = ~31.7 years at 1M locks/sec.</p><p><strong>Why lexicographic</strong>: Simplest possible API. One comparison rule instead of helper functions. Matches developer intuition.</p><p><strong>See ADR-004</strong> for complete rationale on format choice and precision safety requirements.</p><hr><h2 id="time-authority" tabindex="-1">Unified Time Handling and Liveness Predicate <a class="header-anchor" href="#time-authority" aria-label="Permalink to “Unified Time Handling and Liveness Predicate”">​</a></h2><h3 id="requirements-8" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-8" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>Critical Requirement</strong>: All backends MUST use the unified liveness predicate with internal constants to ensure consistent behavior across implementations.</p><p><strong>Single Liveness Predicate:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// common/time-predicates.ts - single source of truth</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  toleranceMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expiresAtMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nowMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> toleranceMs;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Time source helpers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateRedisServerTimeMs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  timeTuple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    parseInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(timeTuple[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(timeTuple[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Unified time tolerance constant (not user-configurable)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// **NORMATIVE SOURCE**: This constant is the single source of truth for time tolerance.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// All backend specifications and ADRs reference this definition.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TIME_TOLERANCE_MS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1000ms - safe for all backends and time authorities</span></span></code></pre></div><p><strong>Authoritative ExpiresAtMs in Mutations:</strong></p><p>All backend mutation operations (acquire, extend) MUST return server-authoritative <code>expiresAtMs</code> computed from the backend&#39;s designated time source. Backends MUST NOT approximate expiry time using client-side calculations (e.g., <code>Date.now() + ttlMs</code>). This ensures:</p><ul><li><strong>Accurate heartbeat scheduling</strong>: Callers can schedule next extend operation based on authoritative server time</li><li><strong>Time authority consistency</strong>: All timestamps originate from the same time source (server or client) declared in <code>capabilities.timeAuthority</code></li><li><strong>No approximation drift</strong>: Eliminates accumulating errors from repeated client-side calculations</li></ul><p><strong>Time Authority Models:</strong></p><p>Backends use different time sources but the same liveness predicate with internal constants:</p><h4 id="server-time-authority-redis" tabindex="-1">Server Time Authority (Redis) <a class="header-anchor" href="#server-time-authority-redis" aria-label="Permalink to “Server Time Authority (Redis)”">​</a></h4><ul><li><strong>Time Source</strong>: Redis server time via <code>redis.call(&#39;TIME&#39;)</code></li><li><strong>Tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> constant above (single source of truth)</li><li><strong>Consistency</strong>: High - single time source eliminates most clock drift</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Redis implementation pattern</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  isLive,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  calculateRedisServerTimeMs,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  TIME_TOLERANCE_MS,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TIME&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateRedisServerTimeMs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(time);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> live</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(storedExpiresAtMs, nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="client-time-authority-firestore" tabindex="-1">Client Time Authority (Firestore) <a class="header-anchor" href="#client-time-authority-firestore" aria-label="Permalink to “Client Time Authority (Firestore)”">​</a></h4><ul><li><strong>Time Source</strong>: Client time via <code>Date.now()</code></li><li><strong>Tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> constant above (single source of truth)</li><li><strong>Requirements</strong>: NTP synchronization recommended for production</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Firestore implementation pattern</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> live</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(storedExpiresAtMs, nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>Consistent Behavior Across Backends:</strong></p><p>All backends use <code>TIME_TOLERANCE_MS</code> for identical liveness semantics:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Consistent behavior - both backends use TIME_TOLERANCE_MS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redisBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses TIME_TOLERANCE_MS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> firestoreBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createFirestoreBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses TIME_TOLERANCE_MS</span></span></code></pre></div><h3 id="time-implementation-requirements" tabindex="-1">Implementation Requirements <a class="header-anchor" href="#time-implementation-requirements" aria-label="Permalink to “Implementation Requirements”">​</a></h3><ul><li><strong>Single Predicate</strong>: ALL backends MUST use <code>isLive()</code> from <code>common/time-predicates.ts</code> across ALL operations</li><li><strong>No Custom Logic</strong>: Custom time logic implementations are FORBIDDEN</li><li><strong>Unified Tolerance</strong>: Backends MUST use <code>TIME_TOLERANCE_MS</code> constant from <code>common/time-predicates.ts</code></li><li><strong>Capability Declaration</strong>: Backends MUST expose <code>timeAuthority</code> in capabilities</li><li><strong>Time Consistency</strong>: All timestamps MUST use the backend&#39;s designated time authority</li><li><strong>Cross-Backend Testing</strong>: Test suites MUST verify identical outcomes with unified tolerance</li></ul><h3 id="rationale-notes-8" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-8" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why unified tolerance</strong>: Eliminates confusion. &quot;Strict&quot; mode was misleading - didn&#39;t mean the same thing across backends. See ADR-005 for detailed rationale.</p><p><strong>Why single predicate</strong>: Prevents implementation drift. Ensures all backends make identical liveness decisions given same timestamps.</p><p><strong>Why not user-configurable</strong>: Operational consistency and testing simplicity outweigh flexibility. Expert users can fork if needed.</p><hr><h2 id="time-authority-tradeoffs" tabindex="-1">Time Authority Tradeoffs <a class="header-anchor" href="#time-authority-tradeoffs" aria-label="Permalink to “Time Authority Tradeoffs”">​</a></h2><p>Different backends use different time authorities, each with distinct operational characteristics. This section provides guidance for choosing and operating backends based on time authority models.</p><h3 id="comparison-matrix" tabindex="-1">Comparison Matrix <a class="header-anchor" href="#comparison-matrix" aria-label="Permalink to “Comparison Matrix”">​</a></h3><table tabindex="0"><thead><tr><th>Aspect</th><th>Redis (Server Time)</th><th>Firestore (Client Time)</th></tr></thead><tbody><tr><td><strong>Time Source</strong></td><td>Redis server <code>TIME</code> command</td><td>Client <code>Date.now()</code></td></tr><tr><td><strong>Consistency</strong></td><td>High - single time source</td><td>Lower - multi-client clocks</td></tr><tr><td><strong>Clock Skew Risk</strong></td><td>Minimal - single server clock</td><td>Significant - requires NTP</td></tr><tr><td><strong>NTP Requirements</strong></td><td>None - client clocks irrelevant</td><td><strong>CRITICAL</strong> - all clients MUST sync</td></tr><tr><td><strong>Determinism</strong></td><td>Full - all clients see same time</td><td>Variable - depends on client sync</td></tr><tr><td><strong>Single Point of Failure</strong></td><td>Redis server clock</td><td>Distributed - each client independent</td></tr><tr><td><strong>Clock Sync Monitoring</strong></td><td>Optional - low risk</td><td><strong>MANDATORY</strong> - fail deployments on drift</td></tr><tr><td><strong>Ideal Use Cases</strong></td><td>High consistency, controlled environments</td><td>Distributed clients, NTP-synced fleets</td></tr><tr><td><strong>When to Avoid</strong></td><td>Redis cluster clock issues (rare)</td><td>Unreliable NTP, IoT/edge devices</td></tr></tbody></table><h3 id="operational-checklists" tabindex="-1">Operational Checklists <a class="header-anchor" href="#operational-checklists" aria-label="Permalink to “Operational Checklists”">​</a></h3><h4 id="redis-server-time-authority-operations" tabindex="-1">Redis (Server Time Authority) Operations <a class="header-anchor" href="#redis-server-time-authority-operations" aria-label="Permalink to “Redis (Server Time Authority) Operations”">​</a></h4><p><strong>Pre-Production:</strong></p><ul><li>✅ Verify Redis server has stable system clock</li><li>✅ Monitor Redis server time via health checks (optional but recommended)</li><li>✅ Document Redis server timezone and time source for ops team</li></ul><p><strong>Production Monitoring:</strong></p><ul><li>✅ Alert on Redis server restarts (time continuity check)</li><li>✅ Monitor lock acquisition/release patterns for anomalies</li><li>✅ No client-side clock monitoring needed</li></ul><p><strong>Migration Considerations:</strong></p><ul><li>✅ When moving to Redis cluster, verify all nodes use synchronized time</li><li>✅ Test lock behavior during Redis failover scenarios</li></ul><p><strong>Failure Scenarios &amp; Mitigations:</strong></p><ul><li><strong>Redis server clock jumps backward</strong>: Locks may appear expired prematurely <ul><li><em>Mitigation</em>: Use NTP on Redis server, monitor system time jumps</li></ul></li><li><strong>Redis server clock drift</strong>: Lock expiry becomes less predictable <ul><li><em>Mitigation</em>: Standard NTP sync on Redis host (typical target: ±100 ms accuracy)</li></ul></li><li><strong>Clock sync issues in Redis cluster</strong>: Different nodes disagree on lock state <ul><li><em>Mitigation</em>: Ensure cluster nodes share time source, test failover behavior</li></ul></li></ul><h4 id="firestore-client-time-authority-operations" tabindex="-1">Firestore (Client Time Authority) Operations <a class="header-anchor" href="#firestore-client-time-authority-operations" aria-label="Permalink to “Firestore (Client Time Authority) Operations”">​</a></h4><p><strong>Pre-Production:</strong></p><ul><li>✅ <strong>MANDATORY</strong>: Deploy NTP synchronization on ALL clients</li><li>✅ <strong>MANDATORY</strong>: Implement NTP sync monitoring in deployment pipeline per <a href="./firestore-backend#firestore-clock-sync-requirements">Firestore Clock Synchronization Requirements</a></li><li>✅ <strong>MANDATORY</strong>: Add application health checks to detect clock skew</li><li>✅ Test lock behavior with simulated clock skew scenarios</li></ul><p><strong>Production Monitoring:</strong></p><ul><li>✅ <strong>CRITICAL</strong>: Monitor client clock drift via system metrics per <a href="./firestore-backend#firestore-clock-sync-requirements">Firestore Clock Synchronization Requirements</a></li><li>✅ Track lock contention patterns (may indicate clock skew issues)</li><li>✅ Monitor lock acquisition failures and correlate with client time drift</li></ul><p><strong>Migration Considerations:</strong></p><ul><li>✅ When adding new client types, verify NTP support and sync quality</li><li>✅ Test multi-region deployments with simulated clock skew</li><li>✅ Consider Redis backend if client time sync cannot be guaranteed</li></ul><p><strong>Failure Scenarios &amp; Mitigations:</strong></p><ul><li><strong>Client clock skew exceeds safety margin</strong>: Lock safety violations, race conditions <ul><li><em>Mitigation</em>: MANDATORY NTP sync, deployment checks per <a href="./firestore-backend#firestore-clock-sync-requirements">Firestore Clock Synchronization Requirements</a></li></ul></li><li><strong>One client&#39;s clock ahead</strong>: May see other clients&#39; locks as expired early <ul><li><em>Mitigation</em>: TIME_TOLERANCE_MS (1000 ms) provides safety margin; enforce operational policy ladder</li></ul></li><li><strong>One client&#39;s clock behind</strong>: May fail to acquire locks when they&#39;re actually free <ul><li><em>Mitigation</em>: Clock monitoring alerts per operational policy, automated remediation</li></ul></li><li><strong>NTP service outage</strong>: Gradual clock drift across clients <ul><li><em>Mitigation</em>: Monitor NTP health, alert on sync failures, consider Redis fallback</li></ul></li></ul><h3 id="backend-selection-guidelines" tabindex="-1">Backend Selection Guidelines <a class="header-anchor" href="#backend-selection-guidelines" aria-label="Permalink to “Backend Selection Guidelines”">​</a></h3><p><strong>Choose Redis (Server Time) when:</strong></p><ul><li>You need maximum consistency and deterministic lock behavior</li><li>All clients connect to same Redis instance/cluster</li><li>You control the Redis server environment</li><li>Client-side time sync is unreliable or unavailable</li><li>Simplicity in operations is a priority</li></ul><p><strong>Choose Firestore (Client Time) when:</strong></p><ul><li>You already use Firestore and can guarantee NTP sync across all clients</li><li>You need globally distributed lock backend</li><li>You have robust NTP infrastructure and monitoring</li><li>Your deployment pipeline can enforce clock sync requirements</li><li>You can afford the operational overhead of client clock monitoring</li></ul><p><strong>When time authority might fail - consider these alternatives:</strong></p><ul><li><strong>Redis server clock issues</strong>: Switch to Redis Cluster with time-synced nodes</li><li><strong>Unreliable client NTP</strong>: Switch to Redis backend for centralized time authority</li><li><strong>Global distribution needs</strong>: Use Firestore with strict NTP requirements</li><li><strong>Hybrid approach</strong>: Use Redis for high-consistency locks, Firestore for lower-stakes coordination</li></ul><hr><h2 id="telemetry-semantics" tabindex="-1">Telemetry and Observability (Optional) <a class="header-anchor" href="#telemetry-semantics" aria-label="Permalink to “Telemetry and Observability (Optional)”">​</a></h2><h3 id="requirements-9" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-9" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>Telemetry Model</strong>: Telemetry is <strong>opt-in</strong> via the <code>withTelemetry()</code> decorator. Core backends do NOT emit events or compute hashes. When telemetry is enabled, the decorator wraps backend operations and emits <code>LockEvent</code> for monitoring and diagnostics.</p><p><strong>Enabling Telemetry</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { withTelemetry } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;syncguard/common&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(config);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> telemetryBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> withTelemetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  includeRaw: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// default: only emit sanitized hashes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Core Backend Responsibilities</strong>: Backends MAY track internal conditions (expired vs not-found) when cheaply available but SHOULD NOT compute hashes or construct event payloads. This internal tracking is consumed by the telemetry decorator when enabled.</p><p><strong>Internal Condition Tracking (Best-Effort):</strong></p><p>Backends MAY track internal conditions cheaply for consumption by telemetry decorators:</p><table tabindex="0"><thead><tr><th>Internal Condition</th><th>Public API Result</th><th>Available for Telemetry</th></tr></thead><tbody><tr><td>Success</td><td><code>{ ok: true }</code></td><td>Always</td></tr><tr><td>Observable expiry</td><td><code>{ ok: false }</code></td><td>When cheaply detectable → <code>&quot;expired&quot;</code></td></tr><tr><td>Not found/other</td><td><code>{ ok: false }</code></td><td>When cheaply detectable → <code>&quot;not-found&quot;</code></td></tr><tr><td>Unknown/ambiguous</td><td><code>{ ok: false }</code></td><td>No detail provided</td></tr></tbody></table><p><strong>Important</strong>: Backends MUST NOT perform additional I/O solely to distinguish failure reasons.</p><p><strong>Implementation Guidance:</strong></p><ul><li><strong>Core Backends</strong>: Return simple <code>{ ok: boolean }</code> results, track cheap internal details</li><li><strong>Telemetry Decorator</strong>: Wraps backend via <code>withTelemetry()</code>, emits events with hashes and reasons when configured</li><li><strong>Async Isolation</strong>: Event callbacks within the decorator MUST NOT be awaited; errors MUST NOT affect lock operations</li></ul><h3 id="rationale-notes-9" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-9" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why opt-in</strong>: Zero-cost abstraction when disabled. No performance impact for applications that don&#39;t need telemetry.</p><p><strong>Why decorator pattern</strong>: Clean separation of concerns. Core backends focus on correctness, telemetry is a composable layer.</p><p><strong>Benefits When Enabled:</strong></p><ul><li><strong>&quot;expired&quot; events</strong>: Indicate cleanup lag or time synchronization issues</li><li><strong>&quot;not-found&quot; events</strong>: Indicate normal cleanup, ownership conflicts, or missing locks</li><li><strong>Zero-cost abstraction</strong>: No performance impact when telemetry is disabled</li></ul><p><strong>See ADR-007</strong> for complete rationale on opt-in telemetry design.</p><hr><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to “Error Handling”">​</a></h2><h3 id="requirements-10" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-10" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// System errors and acquisition timeouts throw LockError</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> code</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ServiceUnavailable&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;AuthFailed&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;InvalidArgument&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;RateLimited&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;NetworkTimeout&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // raised by backend/network operations due to network/backend timeouts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;AcquisitionTimeout&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // raised only by lock() helper when its retry loop exceeds timeoutMs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Aborted&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // raised when operation is cancelled via AbortSignal</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Internal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cause</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> code);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;LockError&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="error-handling-patterns" tabindex="-1">Error Handling Patterns <a class="header-anchor" href="#error-handling-patterns" aria-label="Permalink to “Error Handling Patterns”">​</a></h3><p>SyncGuard provides multiple complementary mechanisms for error handling. Choose the patterns that match your application&#39;s needs.</p><h4 id="pattern-1-simple-error-handling" tabindex="-1">Pattern 1: Simple Error Handling <a class="header-anchor" href="#pattern-1-simple-error-handling" aria-label="Permalink to “Pattern 1: Simple Error Handling”">​</a></h4><p>For basic applications, use try/catch for acquisition errors and the <code>onReleaseError</code> callback for disposal errors:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await using</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onReleaseError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to release lock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        error: err,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lockId: ctx.lockId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        key: ctx.key,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        source: ctx.source,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Critical section</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to acquire lock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      code: err.code,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      message: err.message,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>⚠️ Important: Disposal Errors and <code>using</code>/<code>await using</code></strong></p><p>When using <code>using</code> or <code>await using</code>, disposal errors (including timeouts and cleanup failures) are routed to the <code>onReleaseError</code> callback. The disposal process itself never throws to avoid disrupting your application&#39;s control flow.</p><p><strong>Default Error Handling Behavior (NEW):</strong></p><p>SyncGuard now provides a <strong>safe-by-default</strong> error handler that prevents silent disposal failures:</p><ul><li><strong>Development</strong> (<code>NODE_ENV !== &#39;production&#39;</code>): Disposal errors are logged to <code>console.error</code></li><li><strong>Production</strong>: Silent by default to avoid log noise; enable via <code>SYNCGUARD_DEBUG=true</code> environment variable</li><li><strong>Security</strong>: Default logs omit sensitive data (key, lockId) to prevent accidental PII exposure</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default behavior - errors are observable without explicit callback</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await using</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ key, ttlMs });</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Development: Disposal errors logged to console.error</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Production: Silent unless SYNCGUARD_DEBUG=true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Recommended: Provide custom callback in production for proper observability</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await using</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onReleaseError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // This callback receives:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // - Release failures during disposal</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // - Timeout errors (if disposeTimeoutMs configured)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // - Network errors during cleanup</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Disposal failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      error: err.message,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      lockId: ctx.lockId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      key: ctx.key,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      source: ctx.source,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">increment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;syncguard.disposal.error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { source: ctx.source });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// If disposal fails, onReleaseError is called but this code continues normally</span></span></code></pre></div><p><strong>Production Best Practice:</strong> Always configure a custom <code>onReleaseError</code> callback integrated with your logging and metrics infrastructure. The default callback is a safety net for development and should not be relied upon in production systems.</p><h4 id="pattern-2-centralized-observability-with-telemetry" tabindex="-1">Pattern 2: Centralized Observability with Telemetry <a class="header-anchor" href="#pattern-2-centralized-observability-with-telemetry" aria-label="Permalink to “Pattern 2: Centralized Observability with Telemetry”">​</a></h4><p>For production systems, wrap your backend with <code>withTelemetry()</code> to capture all lock operations in a centralized monitoring system:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { withTelemetry } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;syncguard/common&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> withTelemetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redisBackend, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Send to your metrics/logging system</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">recordLockOperation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event.type, event.result);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event.result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fail&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Lock operation failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        operation: event.type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        reason: event.reason,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        keyHash: event.keyHash,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lockIdHash: event.lockIdHash,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  includeRaw: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Only emit sanitized hashes (default)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// All operations are now automatically instrumented</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await using</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  onReleaseError: globalErrorHandler,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Telemetry captures all operations with zero overhead when disabled.</strong></p><h4 id="pattern-3-global-error-handler" tabindex="-1">Pattern 3: Global Error Handler <a class="header-anchor" href="#pattern-3-global-error-handler" aria-label="Permalink to “Pattern 3: Global Error Handler”">​</a></h4><p>Define a reusable error handler for consistent error logging across your application:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Global error handler</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> globalErrorHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OnReleaseError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Lock release failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    error: err.message,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    code: err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Unknown&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lockId: ctx.lockId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    key: ctx.key,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    source: ctx.source,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Emit metric</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">increment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lock.release.error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    source: ctx.source,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    code: err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;unknown&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Use across your application</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redis, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  onReleaseError: globalErrorHandler,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Or per-lock basis</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await using</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  onReleaseError: globalErrorHandler,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="pattern-4-manual-control-with-result-checking" tabindex="-1">Pattern 4: Manual Control with Result Checking <a class="header-anchor" href="#pattern-4-manual-control-with-result-checking" aria-label="Permalink to “Pattern 4: Manual Control with Result Checking”">​</a></h4><p>For fine-grained control, use the manual API and check result objects:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;resource:123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Handle contention</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Lock contention&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;resource:123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    reason: result.reason,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;retry-later&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Critical section</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> releaseResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ lockId: result.lockId });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">releaseResult.ok) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Release failed - lock was absent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { lockId: result.lockId });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="disposal-timeout-behavior" tabindex="-1">Disposal Timeout Behavior <a class="header-anchor" href="#disposal-timeout-behavior" aria-label="Permalink to “Disposal Timeout Behavior”">​</a></h4><p>Configure <code>disposeTimeoutMs</code> at the backend level to abort slow disposal operations:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redis, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  disposeTimeoutMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Abort disposal after 5 seconds</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onReleaseError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;NetworkTimeout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Disposal timeout exceeded&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        timeoutMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lockId: ctx.lockId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await using</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// If disposal takes &gt;5s, it&#39;s aborted and onReleaseError is called</span></span></code></pre></div><p><strong>Note:</strong> Most applications should rely on backend client timeout settings. Only use <code>disposeTimeoutMs</code> for disposal-specific timeout behavior.</p><h4 id="error-handling-decision-matrix" tabindex="-1">Error Handling Decision Matrix <a class="header-anchor" href="#error-handling-decision-matrix" aria-label="Permalink to “Error Handling Decision Matrix”">​</a></h4><table tabindex="0"><thead><tr><th>Use Case</th><th>Recommended Pattern</th><th>Why</th></tr></thead><tbody><tr><td>Simple application</td><td>Pattern 1 (try/catch + onReleaseError)</td><td>Minimal setup, covers all error paths</td></tr><tr><td>Production monitoring</td><td>Pattern 2 (withTelemetry)</td><td>Centralized observability, zero overhead when disabled</td></tr><tr><td>Multiple lock sites</td><td>Pattern 3 (global handler)</td><td>Consistent error handling across codebase</td></tr><tr><td>Fine-grained control</td><td>Pattern 4 (manual API)</td><td>Explicit result checking, no implicit behavior</td></tr><tr><td>High reliability</td><td>Pattern 2 + Pattern 3</td><td>Telemetry for monitoring + global handler for errors</td></tr></tbody></table><h3 id="troubleshooting-guide" tabindex="-1">Troubleshooting Guide <a class="header-anchor" href="#troubleshooting-guide" aria-label="Permalink to “Troubleshooting Guide”">​</a></h3><p><strong>Not seeing disposal errors?</strong></p><ul><li>✅ Check that <code>onReleaseError</code> is configured (backend-level or lock-level)</li><li>✅ Verify the callback is actually being invoked (add console.log)</li><li>✅ Remember: <code>ok: false</code> results are normal (lock expired) - only system errors trigger callback</li></ul><p><strong>Disposal taking too long?</strong></p><ul><li>✅ Configure <code>disposeTimeoutMs</code> at backend level</li><li>✅ Check backend client timeout settings (Redis socket timeout, PostgreSQL query timeout)</li><li>✅ Monitor network latency to backend service</li></ul><p><strong>Want to see all lock activity?</strong></p><ul><li>✅ Use <code>withTelemetry()</code> to wrap your backend</li><li>✅ Configure <code>onEvent</code> callback to send to your logging/metrics system</li><li>✅ Enable <code>includeRaw: true</code> only for debugging (exposes sensitive identifiers)</li></ul><h3 id="centralized-error-mapping" tabindex="-1">Centralized Error Mapping <a class="header-anchor" href="#centralized-error-mapping" aria-label="Permalink to “Centralized Error Mapping”">​</a></h3><p>All backends MUST implement consistent error mapping to prevent implementation drift. Use these exact mappings:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Error mapping standard - backends MUST implement consistent classification</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ErrorMappingStandard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Classification rules for LockError codes (MUST throw LockError)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  mappingRules</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    ServiceUnavailable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Network failures, service unavailable, connection issues, infrastructure timeouts, transaction conflicts (ABORTED)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    AuthFailed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authentication failures, authorization denied, credential issues&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    InvalidArgument</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Malformed requests, invalid parameters, data validation failures&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    RateLimited</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Rate limiting responses, quota exceeded, throttling&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    NetworkTimeout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Client-side timeouts, network timeouts, operation timeouts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    AcquisitionTimeout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Retry loop exceeded timeoutMs (generated by auto API only)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    Aborted</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Operation cancelled via AbortSignal (user-initiated cancellation)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    Internal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Unexpected backend errors, unclassified system failures, unknown conditions (includes rare backend limit scenarios)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Domain outcome reasons for telemetry (exact strings required for events)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  telemetryReasons</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;expired&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;not-found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MUST use only these strings for *-failed events</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  acquisitionReasons</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;locked&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MUST use only this string for acquire contention</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Backend Implementation Requirements:</strong></p><ul><li>Backends MUST map their specific errors according to the classification rules above</li><li>Error mapping should follow the spirit of each category rather than exact string matching</li><li>Backend specs SHOULD include mapping examples but focus on error categories</li><li>Use this standard to ensure consistent error handling across all implementations</li></ul><h3 id="error-reporting" tabindex="-1">Error Reporting <a class="header-anchor" href="#error-reporting" aria-label="Permalink to “Error Reporting”">​</a></h3><ul><li><strong>Lock Contention</strong>: Return <code>{ ok: false, reason: &quot;locked&quot; }</code> from acquire operations</li><li><strong>Acquisition Timeout</strong>: Throw <code>LockError(&quot;AcquisitionTimeout&quot;)</code> when retry loop exceeds <code>timeoutMs</code></li><li><strong>System Failures</strong>: Throw <code>LockError</code> with descriptive message and specific error code</li><li><strong>Mutation Failures</strong>: Return simplified <code>{ ok: false }</code> from release/extend operations</li><li><strong>Release Failures</strong>: Use <code>onReleaseError</code> callback for system errors during release</li><li><strong>Error Context</strong>: Include relevant context (key, lockId, cause) in LockError instances</li><li><strong>Retry Strategy</strong>: The lock() helper implements configurable retry with exponential backoff and jitter. Backends do not implement retries.</li><li><strong>Observability</strong>: When wrapped by <code>withTelemetry()</code>, emit <code>LockEvent</code> for monitoring and diagnostics, with detailed telemetry reasons preserved in events</li></ul><h3 id="rationale-notes-10" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-10" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why centralized mapping</strong>: Prevents drift between backends. Ensures users get consistent error codes for equivalent failures.</p><p><strong>Why contention as result</strong>: Domain outcome, not system error. Allows callers to handle gracefully without try/catch.</p><p><strong>Why throw for system errors</strong>: Exceptional conditions that typically require retry or intervention. Natural error propagation in async code.</p><hr><h2 id="storage-requirements" tabindex="-1">Storage Requirements <a class="header-anchor" href="#storage-requirements" aria-label="Permalink to “Storage Requirements”">​</a></h2><h3 id="requirements-11" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-11" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>Reverse Mapping</strong>: All backends MUST provide a mechanism to atomically resolve <code>lockId → key</code> for the lifetime of each lock. This capability is established at acquisition and used by <code>release</code> and <code>extend</code> operations to atomically load the key from <code>lockId</code> for ownership verification.</p><p><strong>CRITICAL: TOCTOU Protection</strong>: To prevent Time-of-Check-Time-of-Use race conditions, ALL <code>release</code> and <code>extend</code> operations MUST execute these steps atomically within a single transaction/script:</p><ol><li><strong>Resolve mapping</strong>: Load the key from lockId via reverse mapping</li><li><strong>Validate state</strong>: Verify lock exists and is not expired</li><li><strong>Perform mutation</strong>: Delete (release) or update TTL (extend)</li></ol><p><strong>Implementation Options</strong>: Backends MAY implement this requirement through:</p><ul><li><strong>Explicit mapping</strong>: Separate <code>lockId → key</code> storage (e.g., Redis index keys)</li><li><strong>Indexed queries</strong>: Database queries on indexed <code>lockId</code> fields (e.g., Firestore single-field index)</li></ul><p>The chosen approach MUST support atomic ownership verification within the same transaction/script as the mutation operation.</p><h3 id="rationale-notes-11" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-11" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why reverse mapping required</strong>: Enables keyless API design where <code>lockId</code> serves as sufficient handle for all lock operations. Callers don&#39;t need to track which key corresponds to which lock.</p><p><strong>Race Condition Example</strong>: Without atomicity, between steps 1-2 and step 3, another process could expire/delete the original lock and acquire a new lock on the same key, causing the first process to accidentally operate on the wrong lock.</p><p><strong>Why implementation flexibility</strong>: Different storage systems have different strengths. Redis excels at dual-key patterns, Firestore at indexed queries. Both work correctly with proper atomicity.</p><hr><h2 id="operation-requirements" tabindex="-1">Operation Requirements <a class="header-anchor" href="#operation-requirements" aria-label="Permalink to “Operation Requirements”">​</a></h2><h3 id="acquire-operation-requirements" tabindex="-1">Acquire Operation Requirements <a class="header-anchor" href="#acquire-operation-requirements" aria-label="Permalink to “Acquire Operation Requirements”">​</a></h3><ul><li><strong>Atomicity</strong>: Operations MUST be atomic (transaction/script/CAS) with <strong>no race window</strong> between setting ownership and TTL. Single round-trip is RECOMMENDED but not REQUIRED.</li><li><strong>Lock ID Generation</strong>: MUST use 16 bytes of cryptographically strong randomness from a CSPRNG (e.g., <code>crypto.getRandomValues()</code>). Lock IDs MUST be base64url encoded strings with exactly 22 characters (16 bytes of entropy). No timestamp fallback. If the runtime lacks a secure RNG, SyncGuard MUST provide one.</li><li><strong>Lock ID Validation</strong>: Backends MUST validate <code>lockId</code> format in all operations (release, extend, lookup) and throw <code>LockError(&quot;InvalidArgument&quot;)</code> for malformed lockIds. Valid format: exactly 22 base64url characters matching <code>^[A-Za-z0-9_-]{22}$</code>.</li><li><strong>TTL Handling</strong>: Respect <code>config.ttlMs</code> for automatic expiration</li><li><strong>TTL Authority</strong>: Expiration SHOULD be enforced by backend server time when natively available (e.g., Redis TIME). For backends without native server time (e.g., Firestore), use client time with documented skew tolerance and NTP synchronization recommended.</li><li><strong>Contention Behavior</strong>: Return <code>{ ok: false, reason: &quot;locked&quot; }</code> when lock is held by another process. No fairness or ordering guarantees.</li><li><strong>Error Distinction</strong>: Contention returns <code>AcquireResult</code>, system errors throw <code>LockError</code></li><li><strong>Fencing Tokens</strong>: Backends that support fencing MUST always generate fence tokens. Fence tokens MUST be atomically persisted with acquisition and be strictly increasing per key (no repeats, no decreases), even across restarts</li><li><strong>Monotonicity Guarantee</strong>: <code>fence</code> values MUST increase for each successful acquisition of the same key, surviving backend restarts</li><li><strong>API Format</strong>: Fence values MUST be returned as exactly 15-digit zero-padded decimal strings (format: <code>String(n).padStart(15, &#39;0&#39;)</code>). For Lua implementations, use <code>string.format(&quot;%015d&quot;, redis.call(&#39;INCR&#39;, fenceKey))</code> to format immediately.</li><li><strong>Storage Flexibility</strong>: Backends MAY store fence values as numbers internally but MUST preserve full precision and convert to 15-digit zero-padded strings at API boundary</li><li><strong>Overflow Enforcement</strong>: Backends MUST parse/validate returned fence values and throw <code>LockError(&quot;Internal&quot;)</code> if fence &gt; <code>FENCE_THRESHOLDS.MAX</code>; backends MUST log warnings via the shared <code>logFenceWarning()</code> utility when fence &gt; <code>FENCE_THRESHOLDS.WARN</code> for early operational signals. Canonical values in <code>common/constants.ts</code>.</li><li><strong>Validation</strong>: <code>ttlMs</code> MUST be a positive integer (ms); otherwise throw <code>LockError(&quot;InvalidArgument&quot;)</code>. Helper functions MAY apply defaults before calling backend operations.</li><li><strong>Storage Key Limits</strong>: Backends MUST document their effective storage-key byte limits after prefixing/namespacing. If user key + prefix exceeds the backend&#39;s storage limit, backend MUST apply standardized hash-truncation as defined in <a href="#storage-key-generation">Standardized Storage Key Generation</a>. Backends MAY throw <code>LockError(&quot;InvalidArgument&quot;)</code> only if even the truncated form exceeds the backend&#39;s absolute limit (e.g., prefix too long). All backends MUST enforce the common 512-byte user key limit first.</li><li><strong>Performance</strong>: Fast indexed lookups are the target; backends SHOULD document expected performance characteristics</li></ul><h3 id="acquire-operation-rationale-notes" tabindex="-1">Acquire Operation Rationale &amp; Notes <a class="header-anchor" href="#acquire-operation-rationale-notes" aria-label="Permalink to “Acquire Operation Rationale &amp; Notes”">​</a></h3><p><strong>Why CSPRNG</strong>: Prevents lockId prediction attacks. Ensures uniqueness even with high acquisition rates.</p><p><strong>Why format validation</strong>: Fail fast on invalid input. Prevents expensive storage lookups with malformed keys.</p><p><strong>Why contention as result</strong>: Normal operation outcome, not exceptional. Allows graceful handling without try/catch.</p><p><strong>Why fence overflow enforcement</strong>: Prevents silent wraparound. Operations continue to work until explicit limit, then fail safely. See ADR-004 for overflow rationale.</p><hr><h3 id="release-operation-requirements" tabindex="-1">Release Operation Requirements <a class="header-anchor" href="#release-operation-requirements" aria-label="Permalink to “Release Operation Requirements”">​</a></h3><ul><li><strong>TOCTOU Protection</strong>: MUST follow the CRITICAL TOCTOU Protection requirement above - all three steps (resolve mapping, validate state, perform mutation) MUST be atomic within a single transaction/script</li><li><strong>Ownership Verification</strong>: MUST verify lock existence and validity before release via the lockId→key reverse mapping</li><li><strong>Ownership Binding</strong>: At acquisition, the backend MUST bind <code>lockId → key</code> and store this mapping for the lock&#39;s lifetime. <code>release</code> MUST atomically load the key from <code>lockId</code> and verify that the lock still exists and is not expired.</li><li><strong>Return Value</strong>: Return <code>{ ok: true }</code> when the mutation was applied. Return <code>{ ok: false }</code> otherwise. System/validation/auth/transport failures MUST throw <code>LockError</code>; domain outcomes use <code>ReleaseResult</code>.</li><li><strong>Telemetry</strong>: Emit <code>release-failed</code> events with detailed <code>reason</code> (&quot;expired&quot; | &quot;not-found&quot;) for operational monitoring while keeping public API simple.</li><li><strong>LockId-Only Semantics</strong>: Since release operates via <code>lockId</code> with reverse mapping to find the key, ownership conflicts are eliminated in normal operation. However, backends MAY transiently observe ownership mismatches due to stale indices (cleanup race conditions, TTL drift, etc.).</li><li><strong>At-most-once effect</strong>: Only one <code>release</code> may succeed. Concurrent or repeated <code>release(lockId)</code> calls for the same lock MUST NOT delete any other owner&#39;s lock and MUST return <code>{ ok: false }</code> once the lock is gone. The telemetry decorator MAY emit detailed reasons (&quot;expired&quot; | &quot;not-found&quot;) via events for operational monitoring.</li></ul><h3 id="release-operation-rationale-notes" tabindex="-1">Release Operation Rationale &amp; Notes <a class="header-anchor" href="#release-operation-rationale-notes" aria-label="Permalink to “Release Operation Rationale &amp; Notes”">​</a></h3><p><strong>Why TOCTOU protection</strong>: Without atomicity, another process could acquire a new lock between lookup and delete, causing wrong-lock deletion.</p><p><strong>Why simplified result</strong>: Public API focuses on success/failure. Internal reasons available for telemetry when enabled.</p><p><strong>Why at-most-once</strong>: Idempotency guarantee. Safe to retry release operations without fear of affecting unrelated locks.</p><hr><h3 id="extend-operation-requirements" tabindex="-1">Extend Operation Requirements <a class="header-anchor" href="#extend-operation-requirements" aria-label="Permalink to “Extend Operation Requirements”">​</a></h3><ul><li><strong>TOCTOU Protection</strong>: MUST follow the CRITICAL TOCTOU Protection requirement above - all three steps (resolve mapping, validate state, perform mutation) MUST be atomic within a single transaction/script</li><li><strong>Ownership Verification</strong>: MUST verify lock existence and validity before extending via the lockId→key reverse mapping</li><li><strong>Ownership Binding</strong>: Same requirement as release - MUST atomically load the key from <code>lockId</code> and verify that the lock still exists and is not expired</li><li><strong>No Resurrection</strong>: <code>extend</code> MUST NOT recreate an expired lock. Extend operations MUST succeed only if <code>current_server_time &lt; stored_expiresAt_server</code>, checked atomically within the same transaction/script.</li><li><strong>TTL Update Semantics</strong>: <code>extend(ttlMs)</code> resets the expiration to <strong>now + ttlMs</strong> (replaces remaining TTL, does NOT add). Implementations MUST set new expiry to <code>current_server_time + ttlMs</code> atomically.</li><li><strong>TTL Update</strong>: Update expiration time atomically</li><li><strong>Return Value</strong>: Return <code>{ ok: true, expiresAtMs: number }</code> when the mutation was applied (includes new server-based expiry time for heartbeat scheduling). Return <code>{ ok: false }</code> otherwise.</li><li><strong>Telemetry</strong>: Emit <code>extend-failed</code> events with detailed <code>reason</code> (&quot;expired&quot; | &quot;not-found&quot;) for operational monitoring while keeping public API simple.</li><li><strong>LockId-Only Semantics</strong>: Since extend operates via <code>lockId</code> with reverse mapping to find the key, ownership conflicts are eliminated in normal operation.</li><li><strong>Validation</strong>: <code>ttlMs</code> MUST be a positive integer number of milliseconds; otherwise throw <code>LockError(&quot;InvalidArgument&quot;)</code></li></ul><h3 id="extend-operation-rationale-notes" tabindex="-1">Extend Operation Rationale &amp; Notes <a class="header-anchor" href="#extend-operation-rationale-notes" aria-label="Permalink to “Extend Operation Rationale &amp; Notes”">​</a></h3><p><strong>Why no resurrection</strong>: Expired locks should stay expired. Prevents confusion and maintains clear lifecycle semantics.</p><p><strong>Why reset (not add)</strong>: Simpler mental model. Caller specifies desired total lifetime, not incremental extension.</p><p><strong>Why include expiresAtMs</strong>: Critical for heartbeat scheduling. Callers need exact expiry to schedule next extend operation safely.</p><hr><h3 id="islocked-operation-requirements" tabindex="-1">IsLocked Operation Requirements <a class="header-anchor" href="#islocked-operation-requirements" aria-label="Permalink to “IsLocked Operation Requirements”">​</a></h3><ul><li><strong>Use Case</strong>: Simple boolean checks for control flow (prefer <code>lookup()</code> when you need diagnostic context)</li><li><strong>Performance</strong>: Target fast indexed lookups where possible</li><li><strong>Read-Only Expectation</strong>: Users expect <code>isLocked()</code> to be a pure read operation with no side effects. To honor this expectation, cleanup is <strong>disabled by default</strong>.</li><li><strong>Optional Cleanup</strong>: Backends MAY support opt-in cleanup via configuration (e.g., <code>cleanupInIsLocked: true</code>). When enabled: <ul><li>MUST NOT affect the return value of the current call</li><li>MUST NOT block, affect, or modify live locks in any way</li><li>MUST NOT perform any writes that could alter live lock TTL or timestamps</li><li>MAY perform best-effort, non-blocking cleanup of expired locks as fire-and-forget operations with rate limiting</li><li><strong>CRITICAL: Fence Counter Protection</strong>: Cleanup operations MUST ONLY delete lock data (main lock keys/documents and reverse index keys/documents), NEVER fence counter keys/documents</li><li><strong>Configuration Validation</strong>: Backends MUST validate cleanup configuration at initialization time and throw <code>LockError(&quot;InvalidArgument&quot;)</code> if misconfiguration could result in fence counter deletion</li><li><strong>Cleanup Safety Guard</strong>: MUST use safety guards to prevent race conditions with concurrent extend operations: <ul><li><strong>Server Time Backends (Redis)</strong>: Only delete when <code>server_time_ms - stored_expiresAtMs &gt; guard_ms</code> where <code>guard_ms &gt;= 2000ms</code></li><li><strong>Client-Skew Backends (Firestore)</strong>: Only delete when <code>Date.now() - stored_expiresAtMs &gt; (skew_tolerance_ms + guard_ms)</code> where <code>guard_ms &gt;= 1000ms</code></li></ul></li><li><strong>Documentation</strong>: Backends that support cleanup MUST clearly document the trade-offs and testing implications</li></ul></li><li><strong>Return Value</strong>: <code>true</code> if actively locked, <code>false</code> otherwise</li><li><strong>Security</strong>: MUST NOT leak lockId or owner identity information</li><li><strong>TTL Constraints</strong>: MUST NOT indirectly prolong lock lifetime (e.g., via touched/updated timestamps or triggers)</li></ul><h3 id="islocked-operation-rationale-notes" tabindex="-1">IsLocked Operation Rationale &amp; Notes <a class="header-anchor" href="#islocked-operation-rationale-notes" aria-label="Permalink to “IsLocked Operation Rationale &amp; Notes”">​</a></h3><p><strong>Why read-only by default</strong>: Users expect <code>isLocked()</code> to be a pure query with no side effects. Automatic cleanup violates this expectation.</p><p><strong>Why optional cleanup</strong>: Some deployments may benefit from opportunistic cleanup to reduce storage bloat. Opt-in preserves predictability.</p><p><strong>Why fence counter protection</strong>: Deleting fence counters breaks monotonicity guarantees and fencing safety. Cleanup must be surgical.</p><p><strong>Why safety guards</strong>: Prevents race conditions where cleanup deletes a lock that&#39;s being extended concurrently. Conservative buffer provides safety margin.</p><hr><h3 id="lookup-operation-requirements-required" tabindex="-1">Lookup Operation Requirements (Required) <a class="header-anchor" href="#lookup-operation-requirements-required" aria-label="Permalink to “Lookup Operation Requirements (Required)”">​</a></h3><h4 id="lookup-modes-guarantees" tabindex="-1">Lookup Modes &amp; Guarantees <a class="header-anchor" href="#lookup-modes-guarantees" aria-label="Permalink to “Lookup Modes &amp; Guarantees”">​</a></h4><p><strong>Key Mode</strong> (<code>{ key }</code>):</p><ul><li><strong>Complexity</strong>: O(1) direct access (single operation)</li><li><strong>Atomicity</strong>: Not applicable (inherently atomic read)</li><li><strong>Use case</strong>: &quot;Is this resource currently locked?&quot;</li><li><strong>Performance</strong>: Fast indexed lookups, single backend operation</li></ul><p><strong>Ownership Mode</strong> (<code>{ lockId }</code>):</p><ul><li><strong>Complexity</strong>: Multi-step (reverse mapping + verification)</li><li><strong>Atomicity</strong>: SHOULD be atomic for stores requiring multi-key reads (e.g., Redis via Lua script). MAY use a single indexed query with post-read ownership verification for indexed stores (e.g., Firestore), as lookup is diagnostic-only and does not provide TOCTOU protection for mutations.</li><li><strong>Use case</strong>: &quot;Do I still own this lock?&quot;</li><li><strong>Performance</strong>: Index traversal + verification overhead</li></ul><h4 id="implementation-requirements" tabindex="-1">Implementation Requirements <a class="header-anchor" href="#implementation-requirements" aria-label="Permalink to “Implementation Requirements”">​</a></h4><ul><li><strong>Dual Lookup</strong>: Discriminated overloads provide compile-time safety and better IntelliSense</li><li><strong>Runtime Validation</strong>: MUST validate inputs before any I/O operations: <ul><li>Key mode: Call <code>normalizeAndValidateKey(key)</code> and fail fast on invalid keys</li><li>LockId mode: Call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li></ul></li><li><strong>Key Lookup</strong>: Return the live lock for the specified key via direct access</li><li><strong>LockId Lookup</strong>: Return the live lock associated with the specified lockId (enables ownership checking)</li><li><strong>Ownership Verification</strong>: When looking up by <code>lockId</code> via index-based reverse mapping (e.g., Firestore), implementations MUST verify <code>data.lockId === lockId</code> after document retrieval; return <code>null</code> if verification fails.</li><li><strong>Atomicity Requirement</strong>: Backends that require multi-key reads (e.g., Redis lockId lookup) SHOULD implement lookup atomically via scripts or transactions. Backends with indexed queries and post-read verification (e.g., Firestore) MAY use non-atomic reads, as lookup is diagnostic-only and does not provide TOCTOU protection for mutations.</li><li><strong>Null Semantics</strong>: Return <code>null</code> if the lock does not exist or is expired; do not attempt to infer distinction between expired vs not-found</li><li><strong>Read-Only</strong>: MUST be read-only and MUST NOT mutate TTL, timestamps, or any lock state</li><li><strong>Diagnostic Purpose</strong>: ⚠️ Intended for ownership checking, diagnostics, UI, and monitoring ONLY. Lookup is NOT a correctness guard—NEVER use it to gate release/extend operations (use their built-in atomic verification instead). See <a href="#ownership-checking">Ownership Checking</a> for proper usage patterns.</li><li><strong>Performance</strong>: Key lookup SHOULD be optimized for direct access; lockId lookup MAY be slower but SHOULD be reasonably fast</li><li><strong>Security</strong>: <code>lookup()</code> always returns sanitized data (no raw keys/lockIds). Use <code>getByKeyRaw()</code>/<code>getByIdRaw()</code> helpers for raw data access when debugging.</li></ul><h3 id="lookup-operation-rationale-notes" tabindex="-1">Lookup Operation Rationale &amp; Notes <a class="header-anchor" href="#lookup-operation-rationale-notes" aria-label="Permalink to “Lookup Operation Rationale &amp; Notes”">​</a></h3><p><strong>Why required</strong>: Essential for ownership checking and operational diagnostics. Not optional functionality.</p><p><strong>Why dual modes</strong>: Key lookup for resource status, lockId lookup for ownership checking. Different use cases, different performance characteristics.</p><p><strong>Why sanitized by default</strong>: Prevents accidental logging of sensitive identifiers. Security-first design.</p><p><strong>Why atomicity for lockId</strong>: Multi-step operations need TOCTOU protection. Single atomic operation prevents race conditions.</p><hr><h2 id="first-class-diagnostic-helpers" tabindex="-1">First-Class Diagnostic Helpers <a class="header-anchor" href="#first-class-diagnostic-helpers" aria-label="Permalink to “First-Class Diagnostic Helpers”">​</a></h2><p><strong>Developer Experience</strong>: SyncGuard provides these diagnostic functions as <strong>first-class exports</strong> and the <strong>recommended API</strong> for lock diagnostics. While <code>backend.lookup()</code> remains available as a lower-level primitive, developers should prefer these helpers for better discoverability and clearer intent.</p><h3 id="requirements-12" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-12" aria-label="Permalink to “Requirements”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Lookup lock by key (direct O(1) access) - returns sanitized data</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getByKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Lookup lock by lockId (reverse lookup + verification) - returns sanitized data</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Lookup lock by key with raw data (for debugging)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getByKeyRaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfoDebug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Lookup lock by lockId with raw data (for debugging)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getByIdRaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LockInfoDebug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Quick ownership check - returns boolean</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * ⚠️ WARNING: This is for DIAGNOSTIC/UI purposes only, NOT a correctness guard!</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Never use \`owns() → mutate\` patterns. Correctness relies on atomic release/extend</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * with explicit ownership verification (ADR-003).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> owns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span></code></pre></div><h3 id="rationale-notes-12" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-12" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why explicit helpers</strong>: Discoverable. Explicit verbs appear in IDE autocomplete. Better developer experience than overloaded method.</p><p><strong>Why minimal core API</strong>: <code>LockBackend</code> interface stays lean with one method. Helpers provide convenience without bloating interface.</p><p><strong>Why owns() warning</strong>: Prevents TOCTOU anti-pattern. Ownership checks are for diagnostics, not pre-mutation guards.</p><hr><h2 id="ownership-checking" tabindex="-1">Ownership Checking <a class="header-anchor" href="#ownership-checking" aria-label="Permalink to “Ownership Checking”">​</a></h2><blockquote><p>⚠️ <strong>CRITICAL: Diagnostic Use Only</strong> Ownership checks (<code>owns()</code> and <code>lookup({ lockId })</code>) are for <strong>diagnostics, UI, and monitoring</strong> — NOT for correctness guarantees before mutations. Correctness relies on the atomic ownership verification built into <code>release()</code> and <code>extend()</code> operations (ADR-003). Never use <code>lookup() → mutate</code> patterns as pre-guards.</p></blockquote><h3 id="requirements-13" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-13" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>✅ Official Ownership Check Methods:</strong></p><p><strong>Recommended: Use the explicit helper function:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { owns } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;syncguard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> owned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> owns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend, lockId);</span></span></code></pre></div><p><strong>Alternative: Direct method for advanced cases:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> owned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ lockId }));</span></span></code></pre></div><p><strong>Idempotent Operations:</strong></p><p><code>extend()</code> and <code>release()</code> are idempotent and safe to call without ownership:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Safe to call even if not owned - operations are idempotent</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> extendResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">extend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ lockId, ttlMs });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">extendResult.ok) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Handle not-owned case: lock was absent (expired or never existed)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> releaseResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ lockId });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">releaseResult.ok) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Handle not-owned case: lock was absent (expired or never existed)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="❌-do-not-extend-for-ownership-anti-pattern" tabindex="-1">❌ DO NOT: Extend-for-Ownership Anti-Pattern <a class="header-anchor" href="#❌-do-not-extend-for-ownership-anti-pattern" aria-label="Permalink to “❌ DO NOT: Extend-for-Ownership Anti-Pattern”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WRONG: This mutates TTL and has side effects!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> owned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">extend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ lockId, ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })).ok; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ DON&#39;T DO THIS</span></span></code></pre></div><p><strong>Why the anti-pattern is dangerous:</strong></p><ul><li>Unintended side effects (TTL mutation when you wanted read-only check)</li><li>Could accidentally shorten lock lifetime</li><li>Semantically incorrect (extend ≠ ownership check)</li><li>Race conditions with other code expecting unchanged TTL</li></ul><h3 id="rationale-notes-13" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-13" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why diagnostic only</strong>: Read-only checks can&#39;t provide correctness guarantees due to TOCTOU. Atomic operations provide authoritative state.</p><p><strong>Why idempotent</strong>: Safe to call without pre-checking. Structured responses for debugging. No risk of accidental damage.</p><p><strong>Why explicit warning</strong>: Prevents common TOCTOU mistake where developers check ownership then mutate, creating race window.</p><hr><h2 id="recommended-configuration-getting-started" tabindex="-1">Recommended Configuration (Getting Started) <a class="header-anchor" href="#recommended-configuration-getting-started" aria-label="Permalink to “Recommended Configuration (Getting Started)”">​</a></h2><p>For most applications, use these recommended defaults that provide robust behavior out of the box:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Recommended: Exponential backoff with equal jitter</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;resource:123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 30 seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  acquisition: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    maxRetries: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Retry up to 10 times</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    retryDelayMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Start with 100ms</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    backoff: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;exponential&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Double delay each attempt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    jitter: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;equal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Add 50% random jitter</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    timeoutMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Give up after 5 seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>Why these defaults work well:</strong></p><ul><li><strong>Exponential backoff</strong>: Quickly backs off from contention</li><li><strong>Equal jitter</strong>: Prevents thundering herd while maintaining predictable timing</li><li><strong>Reasonable timeout</strong>: Balances responsiveness with persistence</li></ul><hr><h2 id="performance-requirements" tabindex="-1">Performance Requirements <a class="header-anchor" href="#performance-requirements" aria-label="Permalink to “Performance Requirements”">​</a></h2><h3 id="requirements-14" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-14" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>MUST implement</strong>: AbortSignal support for cancellation</p><ul><li>All backend operations (acquire, release, extend, isLocked, lookup) MUST accept optional <code>signal?: AbortSignal</code> parameter</li><li><strong>Redis backend</strong>: Check <code>signal.aborted</code> before issuing commands and throw <code>LockError(&quot;Aborted&quot;)</code> if aborted. After dispatch, mid-flight abort cannot be guaranteed—ioredis does not accept AbortSignal parameters. Best-effort cancellation only.</li><li><strong>Firestore backend</strong>: Manual cancellation checks via <code>checkAborted()</code> helper at strategic points (before reads, after reads, before writes)</li><li>Operations MUST throw <code>LockError(&quot;Aborted&quot;)</code> when signal is aborted</li><li>See backend-specific specs for detailed implementation patterns</li></ul><p><strong>Guidance</strong> (target latencies, not requirements):</p><ul><li><strong>Acquire/IsLocked</strong>: &lt; 10ms local, &lt; 50ms remote</li><li><strong>Release/Extend</strong>: &lt; 20ms acceptable</li><li><strong>Redis</strong>: 1000+ ops/sec, <strong>Firestore</strong>: 100-500 ops/sec</li></ul><p><strong>MUST optimize</strong>: Memory usage (&lt; 1KB per active lock), efficient connection pooling</p><p><strong>No fairness guarantees</strong>: Lock acquisition order is not specified. Clients MUST handle arbitrary patterns.</p><h3 id="diagnostic-interface-requirements" tabindex="-1">Diagnostic Interface Requirements <a class="header-anchor" href="#diagnostic-interface-requirements" aria-label="Permalink to “Diagnostic Interface Requirements”">​</a></h3><ul><li><strong>lookup SLA</strong>: Core <code>lookup()</code> always returns sanitized data (hash IDs only); use <code>getByKeyRaw()</code>/<code>getByIdRaw()</code> helpers for raw key/lockId access; MUST include 15-digit <code>fence</code> when <code>backend.capabilities.supportsFencing === true</code>; response is eventually consistent</li><li><strong>Read-only</strong>: <code>lookup</code> MUST be read-only and MUST NOT mutate TTL or update timestamps</li><li><strong>Performance</strong>: lookup operations SHOULD be fast but MAY be slower than core lock operations</li><li><strong>Availability</strong>: Required interface - all backends MUST implement this functionality for operability</li><li><strong>Dual Lookup</strong>: MUST support both key-based and lockId-based queries for ownership checking</li><li><strong>Consistency Model</strong>: Redis achieves intra-lookup consistency via atomic scripts; Firestore prevents wrong-doc returns via post-read lockId verification; both eliminate races within lookup operations while maintaining eventually consistent semantics across the system</li></ul><h3 id="rationale-notes-14" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-14" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why AbortSignal</strong>: Enables responsive cancellation. Prevents wasted work when client no longer needs result.</p><p><strong>Why guidance not requirements</strong>: Performance varies by deployment, network, hardware. Targets guide optimization without creating artificial constraints.</p><p><strong>Why no fairness</strong>: Fairness adds complexity and overhead. Applications that need fairness can implement queuing at higher level.</p><hr><h2 id="backend-implementation-checklist" tabindex="-1">Backend Implementation Checklist <a class="header-anchor" href="#backend-implementation-checklist" aria-label="Permalink to “Backend Implementation Checklist”">​</a></h2><p>When implementing a new backend, ensure:</p><ul><li>[ ] All four LockBackend operations implemented</li><li>[ ] Required lookup operation implemented with key and lockId lookup support</li><li>[ ] Atomic operations used for all mutations</li><li>[ ] <strong>CRITICAL: TOCTOU protection implemented</strong> - release/extend operations execute resolve mapping, validate state, and perform mutation atomically within single transaction/script</li><li>[ ] <strong>CRITICAL: Explicit ownership verification</strong> - after reverse mapping lookup, MUST verify <code>data.lockId === lockId</code> for defense-in-depth (ADR-003: prevents wrong-lock mutations via explicit verification)</li><li>[ ] <strong>CRITICAL: Unified liveness predicate</strong> - MUST import and use <code>isLive()</code> from <code>common/time-predicates.ts</code> with appropriate time source - custom time logic is FORBIDDEN</li><li>[ ] <strong>LockId validation implemented</strong> - validate format <code>^[A-Za-z0-9_-]{22}$</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> for malformed input</li><li>[ ] <strong>Cleanup safety guards implemented</strong> - if cleanup in isLocked, use safety buffer to prevent race conditions with extend operations</li><li>[ ] Proper error classification using exact strings from ErrorMappingStandard</li><li>[ ] TTL-based expiration handling with consistent Liveness Predicate</li><li>[ ] Ownership verification in release/extend via lockId→key reverse mapping</li><li>[ ] Required indexes/performance optimizations for fast lookups (e.g., Firestore lockId index, Redis script caching)</li><li>[ ] <strong>Idempotency documented</strong> - extend/release operations clearly documented as safe to call without ownership</li><li>[ ] <strong>validateLockId() helper provided</strong> - public utility function for client-side validation and better DX</li><li>[ ] <strong>Behavioral compliance testing</strong> - tests MUST verify backend uses <code>isLive()</code> with appropriate time source and declared tolerance</li><li>[ ] <strong>Tolerance constant enforcement</strong> - tests MUST fail if backend hard-codes any tolerance value other than <code>TIME_TOLERANCE_MS</code> from <code>common/time-predicates.ts</code></li><li>[ ] <strong>Cross-backend consistency</strong> - integration tests MUST verify identical API outcomes (ignoring telemetry differences)</li><li>[ ] <strong>Lookup consistency test</strong> - cross-backend test MUST verify <code>lookup({ lockId })</code> returns <code>null</code> consistently for expired locks (ensures portability without over-testing atomicity races, per ADR-011)</li><li>[ ] Comprehensive unit and integration tests</li><li>[ ] Backend-specific configuration options documented</li><li>[ ] Storage key limits documented with examples</li><li>[ ] <strong>Fence format standardized</strong> - if fencing tokens supported, MUST return 15-digit zero-padded decimal strings; tests verify monotonicity and lexicographic ordering</li><li>[ ] <strong>Fence overflow enforcement</strong> - MUST parse/validate fence values and throw <code>LockError(&quot;Internal&quot;)</code> when fence &gt; <code>FENCE_THRESHOLDS.MAX</code>; MUST log warnings via <code>logFenceWarning()</code> when fence &gt; <code>FENCE_THRESHOLDS.WARN</code> (see <code>common/constants.ts</code>)</li><li>[ ] <strong>Consistent hashing</strong> - MUST use <code>hashKey()</code> from common utilities for all sanitized output</li><li>[ ] Clear documentation of backend-specific requirements</li></ul><hr><h2 id="security-considerations" tabindex="-1">Security Considerations <a class="header-anchor" href="#security-considerations" aria-label="Permalink to “Security Considerations”">​</a></h2><h3 id="requirements-15" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-15" aria-label="Permalink to “Requirements”">​</a></h3><p><strong>Lock ID Security and Ownership:</strong></p><ul><li>lockId MUST be cryptographically strong (128+ bits entropy)</li><li>lockId MUST be unique per acquisition (never reused)</li><li>lockId MUST be verified atomically against stored owner</li><li>lockId MUST NOT be predictable or sequential</li><li>Use 16 bytes from a CSPRNG encoded as base64url (22 chars)</li></ul><p><strong>Fencing Tokens:</strong></p><ul><li>All v1 backends (Redis, PostgreSQL, Firestore) MUST always include monotonic <code>fence</code> tokens in acquire results</li><li>Fencing tokens provide protection against stale owner problems</li><li>Applications SHOULD validate fence tokens when accessing guarded resources</li><li>Higher fence numbers indicate more recent acquisitions</li><li>All backends MUST return exactly 15-digit zero-padded decimal strings for fence values</li><li>Backends SHOULD emit warnings when fence values approach <code>FENCE_THRESHOLDS.MAX</code> to provide early operational signals (via <code>logFenceWarning()</code> when fence &gt; <code>FENCE_THRESHOLDS.WARN</code>)</li><li>Consider key namespace rotation if approaching the theoretical limit</li></ul><p><strong>Key Namespace Best Practices:</strong></p><ul><li>Stored keys SHOULD be namespaced (e.g., <code>syncguard:{env}:{key}</code>) to avoid cross-app collisions</li><li>Use environment-specific prefixes for multi-environment deployments</li><li>Consider versioning in key names for schema evolution</li><li>Avoid user-controlled content in key names to prevent injection attacks</li><li>Backends MUST normalize keys to a canonical form and reject keys above 512 bytes to avoid DOS via huge keys</li><li>Key length limits apply to the <strong>byte length</strong> of the normalized key</li></ul><p><strong>TTL and Heartbeat Guidance:</strong></p><ul><li><code>ttlMs</code> should be <strong>short</strong> (e.g., 10-60 seconds) to minimize impact of failed releases</li><li>For long-running tasks, consider implementing periodic <code>extend()</code> calls rather than very long TTLs</li><li>Future versions MAY provide <code>autoExtend: boolean</code> helper mode for automatic heartbeating</li></ul><p><strong>Access Control:</strong></p><ul><li>Backends SHOULD support authentication/authorization</li><li>Document security best practices for each backend</li><li>Validate user-provided configuration for security issues</li><li>Backends MAY honor <code>signal</code> to cancel in-flight RPCs; helpers SHOULD pass it through</li></ul><p><strong>Data Protection:</strong></p><ul><li>Never log sensitive information (credentials, user data)</li><li>Use secure communication channels (TLS) for remote backends</li><li>Follow principle of least privilege for backend permissions</li></ul><h3 id="rationale-notes-15" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-15" aria-label="Permalink to “Rationale &amp; Notes”">​</a></h3><p><strong>Why CSPRNG</strong>: Prevents lockId prediction attacks. Ensures uniqueness even with high acquisition rates.</p><p><strong>Why 128+ bits</strong>: Collision probability negligible for practical use. Industry standard for unique identifiers.</p><p><strong>Why namespacing</strong>: Prevents accidental collisions across applications or environments. Operational safety.</p><p><strong>Why short TTLs</strong>: Failed releases leave locks orphaned. Short TTLs minimize impact. Heartbeats allow long-running tasks.</p><p><strong>Why 15-digit fence format</strong>: Guarantees full safety within Lua&#39;s 53-bit precision. Provides 10^15 capacity = ~31.7 years at 1M locks/sec. See ADR-004.</p><hr><h2 id="architecture-decision-records" tabindex="-1">Architecture Decision Records <a class="header-anchor" href="#architecture-decision-records" aria-label="Permalink to “Architecture Decision Records”">​</a></h2><p>See <a href="./../adr/">ADRs</a> for architectural decisions and design rationale.</p>`,410)])])}const g=i(t,[["render",l]]);export{c as __pageData,g as default};
