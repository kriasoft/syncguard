import{_ as e,c as a,o as s,aj as t}from"./chunks/framework.Bbpi2Fiw.js";const k=JSON.parse('{"title":"ADR-003 Explicit Ownership Re-Verification in Mutations","description":"","frontmatter":{},"headers":[],"relativePath":"adr/003-explicit-ownership-verification.md","filePath":"adr/003-explicit-ownership-verification.md","lastUpdated":1764705171000}'),n={name:"adr/003-explicit-ownership-verification.md"};function r(o,i,l,p,c,h){return s(),a("div",null,[...i[0]||(i[0]=[t(`<h1 id="adr-003-explicit-ownership-re-verification-in-mutations" tabindex="-1">ADR-003 Explicit Ownership Re-Verification in Mutations <a class="header-anchor" href="#adr-003-explicit-ownership-re-verification-in-mutations" aria-label="Permalink to “ADR-003 Explicit Ownership Re-Verification in Mutations”">​</a></h1><p><strong>Status:</strong> Accepted <strong>Date:</strong> 2025-09 <strong>Tags:</strong> security, toctou, mutations</p><h2 id="problem" tabindex="-1">Problem <a class="header-anchor" href="#problem" aria-label="Permalink to “Problem”">​</a></h2><p>Backend implementations perform release/extend operations by reverse mapping <code>lockId → key</code> then querying/mutating the lock. While the atomic transaction/script pattern already provides TOCTOU protection, explicit ownership verification adds defense-in-depth.</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>ALL backends MUST perform explicit ownership verification after reverse mapping lookup:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After fetching document via reverse mapping</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data?.lockId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, reason: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;not-found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This provides:</p><ul><li><strong>Defense-in-depth</strong>: Additional safety layer with negligible performance cost</li><li><strong>Cross-backend consistency</strong>: Ensures Redis and Firestore implement identical ownership checking</li><li><strong>TOCTOU protection</strong>: Guards against edge cases in the atomic resolve→validate→mutate flow</li><li><strong>Code clarity</strong>: Makes ownership verification explicit rather than implicit</li></ul><h2 id="alternatives-brief" tabindex="-1">Alternatives (brief) <a class="header-anchor" href="#alternatives-brief" aria-label="Permalink to “Alternatives (brief)”">​</a></h2><ul><li>Trust index lookup alone — insufficient defense-in-depth against edge cases</li><li>Transaction-only protection — doesn&#39;t make ownership check explicit in code</li></ul><h2 id="impact" tabindex="-1">Impact <a class="header-anchor" href="#impact" aria-label="Permalink to “Impact”">​</a></h2><ul><li>Positive: Protection against rare but catastrophic wrong-lock mutations; cross-backend consistency</li><li>Negative/Risks: Negligible—single field comparison has no measurable overhead</li></ul><h2 id="links" tabindex="-1">Links <a class="header-anchor" href="#links" aria-label="Permalink to “Links”">​</a></h2><ul><li>Code/Docs: <code>redis/scripts.ts</code>, <code>firestore/operations/*.ts</code>, <code>postgres/operations/*.ts</code></li><li>Related ADRs: ADR-013 (index retrieval pattern)</li></ul>`,15)])])}const g=e(n,[["render",r]]);export{k as __pageData,g as default};
