<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Firestore Backend Specification | üîí SyncGuard</title>
    <meta name="description" content="TypeScript distributed lock library that prevents race conditions across services. Because nobody wants their payment processed twice! üí∏">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/syncguard/assets/style.CxwpygyH.css" as="style">
    <link rel="preload stylesheet" href="/syncguard/vp-icons.css" as="style">
    
    <script type="module" src="/syncguard/assets/app.BAg3_ACq.js"></script>
    <link rel="preload" href="/syncguard/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/syncguard/assets/chunks/theme.DQPWWtTz.js">
    <link rel="modulepreload" href="/syncguard/assets/chunks/framework.Bbpi2Fiw.js">
    <link rel="modulepreload" href="/syncguard/assets/specs_firestore-backend.md.DBnmDxlp.lean.js">
    <link rel="icon" href="/syncguard/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="SyncGuard | Distributed Locks for TypeScript">
    <meta property="og:site_name" content="SyncGuard">
    <meta property="og:url" content="https://kriasoft.com/syncguard/">
    <meta property="og:image" content="https://kriasoft.com/syncguard/og-image.webp">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle has-sidebar" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/syncguard/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>üîí SyncGuard</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/what-is-syncguard" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/redis" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Backends</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/api" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Reference</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/EnbEa7Gsxg" aria-label="discord" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/syncguard" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/EnbEa7Gsxg" aria-label="discord" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/syncguard" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-db738f89><span class="vpi-align-left menu-icon" data-v-db738f89></span><span class="menu-text" data-v-db738f89>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-af661f50><div class="curtain" data-v-af661f50></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af661f50><span class="visually-hidden" id="sidebar-aria-label" data-v-af661f50> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Guide</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/what-is-syncguard" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>What is SyncGuard?</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/getting-started" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Getting Started</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/core-concepts" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Core Concepts</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/fencing" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Fencing Tokens</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Backends</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/redis" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Redis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/postgres" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>PostgreSQL</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/firestore" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Firestore</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>API</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/api" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>API Reference</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>For Developers</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/tree/main/docs/specs" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Specifications</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/tree/main/docs/adr" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Architecture Decisions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/blob/main/.github/CONTRIBUTING.md" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Contributing</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/blob/main/.github/SECURITY.md" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Security Policy</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/sponsors/koistya" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Sponsor</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-sidebar has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _syncguard_specs_firestore-backend" data-v-7011f0d8><div><h1 id="firestore-backend-specification" tabindex="-1">Firestore Backend Specification <a class="header-anchor" href="#firestore-backend-specification" aria-label="Permalink to ‚ÄúFirestore Backend Specification‚Äù">‚Äã</a></h1><p>This document defines Firestore-specific implementation requirements that extend the <a href="./interface">common interface specification</a>.</p><hr><blockquote><p>üö´ <strong>CRITICAL: Never Delete Fence Counters</strong></p><p>Fence counter documents in the <code>fence_counters</code> collection MUST NEVER be deleted. Deleting fence counters breaks monotonicity guarantees and violates fencing safety. Cleanup operations MUST only target lock documents in the <code>locks</code> collection, never fence counter documents.</p></blockquote><hr><h2 id="document-structure" tabindex="-1">Document Structure <a class="header-anchor" href="#document-structure" aria-label="Permalink to ‚ÄúDocument Structure‚Äù">‚Äã</a></h2><p>This specification uses a <strong>normative vs rationale</strong> pattern:</p><ul><li><strong>Requirements</strong> sections contain MUST/SHOULD/MAY/NEVER statements defining the contract</li><li><strong>Rationale &amp; Notes</strong> sections provide background, design decisions, and operational guidance</li></ul><hr><h2 id="document-storage-strategy" tabindex="-1">Document Storage Strategy <a class="header-anchor" href="#document-storage-strategy" aria-label="Permalink to ‚ÄúDocument Storage Strategy‚Äù">‚Äã</a></h2><h3 id="lock-documents-requirements" tabindex="-1">Lock Documents Requirements <a class="header-anchor" href="#lock-documents-requirements" aria-label="Permalink to ‚ÄúLock Documents Requirements‚Äù">‚Äã</a></h3><ul><li><p><strong>Document ID</strong>: MUST use <code>makeStorageKey()</code> from common utilities (see <a href="./interface#storage-key-generation">Storage Key Generation</a>)</p></li><li><p><strong>Backend-specific limit</strong>: 1500 bytes (Firestore document ID limit)</p></li><li><p><strong>Reserve Bytes Requirement</strong>: Firestore operations MUST use 0 reserve bytes when calling <code>makeStorageKey()</code></p><ul><li>Formula: <code>0 bytes</code> (no derived keys requiring suffixes)</li><li>Purpose: Firestore uses independent document IDs for all key types</li></ul></li><li><p><strong>Collection</strong>: Default <code>&quot;locks&quot;</code>, configurable via <code>collection</code> option</p></li><li><p><strong>Document Schema</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockDocument</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// For ownership verification</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Expiration timestamp (ms)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  acquiredAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Acquisition timestamp (ms)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Lock key</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Current fence value (15-digit zero-padded string)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><h3 id="lock-documents-rationale-notes" tabindex="-1">Lock Documents Rationale &amp; Notes <a class="header-anchor" href="#lock-documents-rationale-notes" aria-label="Permalink to ‚ÄúLock Documents Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why independent document IDs</strong>: Unlike Redis, Firestore doesn&#39;t need suffix space for derived keys. Each key type gets its own document with independent ID.</p><p><strong>Why 0 reserve bytes</strong>: Firestore document IDs are completely independent. Lock documents, fence counter documents, and any other metadata use separate IDs without string concatenation.</p><hr><h3 id="fence-counter-documents-requirements" tabindex="-1">Fence Counter Documents Requirements <a class="header-anchor" href="#fence-counter-documents-requirements" aria-label="Permalink to ‚ÄúFence Counter Documents Requirements‚Äù">‚Äã</a></h3><ul><li><p><strong>Document ID</strong>: Generated using <a href="./interface#fence-key-derivation">Two-Step Fence Key Derivation Pattern</a> for consistent hash mapping (ADR-006)</p></li><li><p><strong>Collection</strong>: Default <code>&quot;fence_counters&quot;</code>, configurable via <code>fenceCollection</code> option</p></li><li><p><strong>Document Schema</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FenceCounterDocument</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Monotonic counter (15-digit zero-padded string)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  keyDebug</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Original key for debugging (optional)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><p><strong>Critical Requirements</strong>:</p><ul><li><p><strong>Lifecycle Independence</strong>: Fence counters MUST be independent of lock lifecycle. Cleanup operations delete only lock documents; counter documents are NEVER deleted</p></li><li><p><strong>‚ö†Ô∏è CRITICAL: Fence counters are intentionally persistent</strong> and MUST NOT be deleted:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå NEVER do this - breaks monotonicity guarantee</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceCounterDoc.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Violates fencing safety</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceCounterDoc.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* add TTL */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Violates fencing safety</span></span></code></pre></div></li><li><p><strong>Fence Document ID Generation</strong>: MUST follow two-step pattern:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> baseKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, normalizedKey, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fenceDocId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`fence:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li>Reserve: 0 bytes (Firestore document IDs are independent)</li></ul></li></ul><h3 id="fence-counter-documents-rationale-notes" tabindex="-1">Fence Counter Documents Rationale &amp; Notes <a class="header-anchor" href="#fence-counter-documents-rationale-notes" aria-label="Permalink to ‚ÄúFence Counter Documents Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why lifecycle independence</strong>: Monotonicity guarantee requires persistent counters. Deleting fence counter would allow reuse, violating safety guarantees.</p><p><strong>Why separate collection</strong>: Isolation prevents accidental deletion during cleanup. Configuration validation ensures collections remain distinct.</p><p><strong>Why two-step derivation</strong>: Ensures 1:1 mapping between user keys and fence counters. When truncation occurs, both lock and fence keys hash identically. See interface.md for complete rationale.</p><p><strong>Critical for correctness</strong>:</p><ul><li><strong>Monotonicity guarantee</strong>: Deleting counters breaks strictly increasing fence token requirement</li><li><strong>Cross-backend consistency</strong>: Firestore must match Redis&#39;s fence counter persistence behavior</li><li><strong>Fencing safety</strong>: Counter reset would allow fence token reuse, violating safety guarantees</li></ul><hr><h2 id="configuration-and-validation" tabindex="-1">Configuration and Validation <a class="header-anchor" href="#configuration-and-validation" aria-label="Permalink to ‚ÄúConfiguration and Validation‚Äù">‚Äã</a></h2><h3 id="requirements" tabindex="-1">Requirements <a class="header-anchor" href="#requirements" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FirestoreBackendConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  collection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Lock documents collection, default: &quot;locks&quot;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  fenceCollection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fence counter collection, default: &quot;fence_counters&quot;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  cleanupInIsLocked</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Enable cleanup in isLocked, default: false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... other config options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>CRITICAL: Configuration Validation Requirements</strong></p><p>Backend MUST validate configuration at initialization time and throw <code>LockError(&quot;InvalidArgument&quot;)</code> if:</p><ol><li><strong>Collection Overlap</strong>: <code>fenceCollection === collection</code> (prevents accidental fence counter deletion)</li><li><strong>Collection Naming</strong>: Either collection name is empty or contains invalid Firestore path characters</li><li><strong>Cleanup Safety</strong>: When <code>cleanupInIsLocked: true</code>, verify cleanup queries cannot accidentally target fence counter collection</li></ol><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// At backend initialization</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (config.fenceCollection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config.collection) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;InvalidArgument&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Fence counter collection must differ from lock collection&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Consistent behavior with unified tolerance</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> firestoreBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createFirestoreBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses TIME_TOLERANCE_MS</span></span></code></pre></div><h3 id="rationale-notes" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why validate at initialization</strong>: Fail-fast principle. Configuration errors should be caught before any operations occur.</p><p><strong>Why require distinct collections</strong>: Prevents catastrophic bugs where cleanup accidentally deletes fence counters, breaking monotonicity.</p><p><strong>Why validate cleanup config</strong>: When cleanup enabled, ensure implementation cannot accidentally target fence counter collection through misconfigured queries.</p><hr><h2 id="time-authority-liveness-predicate" tabindex="-1">Time Authority &amp; Liveness Predicate <a class="header-anchor" href="#time-authority-liveness-predicate" aria-label="Permalink to ‚ÄúTime Authority &amp; Liveness Predicate‚Äù">‚Äã</a></h2><h3 id="requirements-1" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-1" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>MUST use <a href="./interface#time-authority">unified liveness predicate</a></strong> from <code>common/time-predicates.ts</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> live</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(storedExpiresAtMs, nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>Time Authority Model</strong>: Firestore uses <strong>client time</strong> (<code>Date.now()</code>) with tolerance per <code>TIME_TOLERANCE_MS</code> in interface.md (ADR-005).</p><p><strong>Production Requirements</strong>:</p><ul><li><strong>MUST</strong>: Deploy NTP synchronization on ALL clients</li><li><strong>MUST</strong>: Implement NTP sync monitoring in deployment pipeline</li><li><strong>MUST</strong>: Add application-level health checks that detect and alert on clock skew</li><li><strong>SHOULD</strong>: Monitor client clock drift via system metrics or health checks</li><li><strong>SHOULD</strong>: Use Redis backend instead if reliable time sync cannot be guaranteed across all clients</li></ul><p><strong>Clock Synchronization Policy</strong>: See <a href="#firestore-clock-sync-requirements">Firestore Clock Synchronization Requirements</a> below for the normative operational policy ladder and its relationship to TIME_TOLERANCE_MS</p><p><strong>Unified Tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> in interface.md for normative tolerance specification.</p><h3 id="rationale-notes-1" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-1" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why client time</strong>: Firestore has no native server time command like Redis. Each client uses local clock with NTP synchronization.</p><p><strong>Why MANDATORY NTP</strong>: Client time authority only works safely with synchronized clocks. Without NTP, clock skew &gt;1000ms causes safety violations.</p><p><strong>Multi-Client Clock Skew Handling</strong>:</p><ul><li><strong>Race condition risk</strong>: Client A may see lock as expired while Client B sees it as live</li><li><strong>Mitigation 1</strong>: Enforce NTP sync monitoring in deployment pipeline (see <a href="#firestore-clock-sync-requirements">Clock Synchronization Requirements</a>)</li><li><strong>Mitigation 2</strong>: Use Redis backend for environments where client time sync is unreliable</li><li><strong>Mitigation 3</strong>: Add application-level health checks that detect and alert on clock skew</li></ul><p><strong>Operational Guidance</strong>: See <a href="./interface#time-authority-tradeoffs">Time Authority Tradeoffs</a> for:</p><ul><li>When to choose Firestore vs Redis based on time authority requirements</li><li>Pre-production checklists including MANDATORY NTP requirements</li><li>Production monitoring guidance for client clock drift</li><li>Failure scenarios and mitigation strategies for client time authority</li><li>When to switch to Redis backend for centralized time authority</li></ul><hr><h2 id="firestore-clock-sync-requirements" tabindex="-1">Firestore Clock Synchronization Requirements <a class="header-anchor" href="#firestore-clock-sync-requirements" aria-label="Permalink to ‚ÄúFirestore Clock Synchronization Requirements‚Äù">‚Äã</a></h2><h3 id="requirements-2" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-2" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>Operational Policy Ladder</strong> (graduated clock drift thresholds):</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Target:  ‚â§ ¬±100 ms  ‚Üí Optimal operational target for production systems</span></span>
<span class="line"><span>Warn:    ‚â• ¬±200 ms  ‚Üí Trigger alerts, investigate clock sync issues</span></span>
<span class="line"><span>Block:   ‚â• ¬±500 ms  ‚Üí Fail deployment, prevent unsafe operations</span></span></code></pre></div><p><strong>Relationship to TIME_TOLERANCE_MS (1000 ms)</strong>:</p><ul><li><code>TIME_TOLERANCE_MS = 1000 ms</code> is the <strong>library&#39;s internal safety margin</strong> that accommodates clock skew up to the operational limits</li><li>The operational policy ladder (100/200/500) defines <strong>deployment and monitoring SLOs</strong> within this safety margin</li><li>The safety margin (1000 ms) is intentionally larger than the block threshold (500 ms) to provide operational buffer</li></ul><p><strong>Operational Implementation</strong>:</p><ul><li><strong>MUST</strong>: Configure deployment pipeline to block deployments when client clock drift ‚â• ¬±500 ms</li><li><strong>MUST</strong>: Configure monitoring to alert when client clock drift ‚â• ¬±200 ms (early warning)</li><li><strong>SHOULD</strong>: Target ‚â§ ¬±100 ms clock accuracy for optimal behavior and safety margin</li></ul><h3 id="rationale-notes-2" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-2" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why graduated policy</strong>: Provides clear operational stages (target/warn/block) for different severity levels, following industry best practices for alert escalation.</p><p><strong>Why 1000 ms safety margin</strong>: Accommodates the operational policy ladder (up to 500 ms block threshold) while providing additional buffer for transient clock skew during NTP resync events.</p><p><strong>Why these specific thresholds</strong>:</p><ul><li><strong>100 ms target</strong>: Matches typical NTP sync accuracy, provides comfortable safety margin</li><li><strong>200 ms warning</strong>: Early signal to investigate before reaching block threshold</li><li><strong>500 ms block</strong>: Conservative deployment safety limit within TIME_TOLERANCE_MS buffer</li></ul><hr><h2 id="backend-capabilities-and-type-safety" tabindex="-1">Backend Capabilities and Type Safety <a class="header-anchor" href="#backend-capabilities-and-type-safety" aria-label="Permalink to ‚ÄúBackend Capabilities and Type Safety‚Äù">‚Äã</a></h2><h3 id="requirements-3" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-3" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p>Firestore backends MUST declare their specific capabilities for enhanced type safety:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FirestoreCapabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;firestore&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backend type discriminant</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  supportsFencing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Firestore always provides fencing tokens</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  timeAuthority</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;client&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses client time with unified tolerance</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> firestoreBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FirestoreCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  createFirestoreBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(config);</span></span></code></pre></div><h3 id="rationale-notes-3" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-3" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Ergonomic Usage</strong>: Firestore always provides fencing tokens with compile-time guarantees:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createFirestoreBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(config);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;resource&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // No assertions or type guards needed!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Fence:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result.fence);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Direct comparison works</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastKnownFence) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, result.fence);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Type discriminant benefits</strong>: Enables pattern matching and type-safe backend switching in generic code.</p><hr><h2 id="fencing-token-implementation" tabindex="-1">Fencing Token Implementation <a class="header-anchor" href="#fencing-token-implementation" aria-label="Permalink to ‚ÄúFencing Token Implementation‚Äù">‚Äã</a></h2><p><strong>NORMATIVE IMPLEMENTATION</strong>: See <code>firestore/operations/acquire.ts</code> for canonical transaction pattern with inline documentation.</p><h3 id="required-characteristics" tabindex="-1">Required Characteristics <a class="header-anchor" href="#required-characteristics" aria-label="Permalink to ‚ÄúRequired Characteristics‚Äù">‚Äã</a></h3><ul><li><strong>Dual Document Pattern</strong>: Fence counters in separate collection (<code>fence_counters</code>) from lock documents (<code>locks</code>)</li><li><strong>Fence Document ID Generation</strong>: MUST use <a href="./interface#fence-key-derivation">Two-Step Fence Key Derivation Pattern</a></li><li><strong>Lifecycle Independence</strong>: Counter documents persist indefinitely; cleanup operations MUST NOT delete counter documents</li><li><strong>Atomicity</strong>: Fence increment and lock creation MUST occur within same <code>runTransaction()</code></li><li><strong>Transaction Pattern</strong>: All reads MUST occur before writes (Firestore requirement)</li><li><strong>Precision Safety</strong>: Use BigInt arithmetic to prevent JavaScript precision loss beyond 2^53-1</li><li><strong>Persistence</strong>: Counter values survive Firestore restarts and lock cleanup operations</li><li><strong>Monotonicity</strong>: Each successful <code>acquire()</code> increments counter, ensuring strict ordering per key</li><li><strong>Initialization</strong>: Start counter at &quot;000000000000000&quot; (15 digits)</li><li><strong>Storage Format</strong>: Store counters as <code>string</code> in counter documents and copy to lock documents</li><li><strong>Format</strong>: Return 15-digit zero-padded decimal strings for lexicographic ordering</li><li><strong>Overflow Enforcement (ADR-004)</strong>: Backend MUST validate fence value and throw <code>LockError(&quot;Internal&quot;)</code> if fence &gt; <code>FENCE_THRESHOLDS.MAX</code>; MUST log warnings via <code>logFenceWarning()</code> when fence &gt; <code>FENCE_THRESHOLDS.WARN</code>. Canonical threshold values defined in <code>common/constants.ts</code>.</li><li><strong>Collection Configuration</strong>: Both lock and fence counter collections MUST be configurable</li><li><strong>Time Authority (ADR-010)</strong>: MUST capture <code>Date.now()</code> inside transaction for authoritative client-time expiresAtMs</li></ul><h3 id="rationale-notes-4" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-4" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why BigInt</strong>: JavaScript numbers lose precision beyond 2^53-1. BigInt handles 15-digit fence values without precision loss.</p><p><strong>Why read-then-write</strong>: Firestore transactions require all reads before any writes. Violating this causes transaction failures.</p><p><strong>Why copy fence to lock document</strong>: Convenience. Allows lock info retrieval without secondary counter document lookup.</p><p><strong>See implementation</strong>: <code>firestore/operations/acquire.ts</code> contains complete transaction logic with defensive guards and error handling.</p><hr><h2 id="explicit-ownership-verification-adr-003" tabindex="-1">Explicit Ownership Verification (ADR-003) <a class="header-anchor" href="#explicit-ownership-verification-adr-003" aria-label="Permalink to ‚ÄúExplicit Ownership Verification (ADR-003)‚Äù">‚Äã</a></h2><h3 id="requirements-4" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-4" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>CRITICAL SECURITY REQUIREMENT</strong>: All release/extend operations MUST include explicit ownership verification after index lookup:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data?.lockId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This verification is MANDATORY even when using atomic transactions.</p><h3 id="rationale-notes-5" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-5" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why required despite atomicity</strong>: Defense-in-depth. While atomic transactions prevent most race conditions, explicit verification guards against:</p><ul><li><strong>Defense-in-depth</strong>: Additional safety layer with negligible performance cost</li><li><strong>Cross-backend consistency</strong>: Ensures Firestore matches Redis&#39;s explicit ownership checking</li><li><strong>TOCTOU protection</strong>: Guards against edge cases in atomic resolve‚Üívalidate‚Üímutate flow</li><li><strong>Code clarity</strong>: Makes ownership verification explicit in transaction logic</li></ul><p><strong>See ADR-003</strong> for complete rationale and cross-backend consistency requirements.</p><hr><h2 id="required-index" tabindex="-1">Required Index <a class="header-anchor" href="#required-index" aria-label="Permalink to ‚ÄúRequired Index‚Äù">‚Äã</a></h2><h3 id="requirements-5" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-5" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p>MUST ensure single-field index on <code>lockId</code> is available for release/extend/lookup performance.</p><ul><li>Firestore typically auto-manages single-field indexes for equality queries</li><li>If index management is customized, create index explicitly</li><li>This is a MUST requirement for all Firestore backends</li></ul><h3 id="rationale-notes-6" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-6" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why lockId index required</strong>: Release/extend operations query by lockId. Without index, these operations would require full collection scans.</p><p><strong>Performance impact</strong>: Indexed queries: ~5-10ms. Full collection scan: 100ms-1000ms+.</p><hr><h2 id="defensive-duplicate-lockid-detection" tabindex="-1">Defensive Duplicate LockId Detection <a class="header-anchor" href="#defensive-duplicate-lockid-detection" aria-label="Permalink to ‚ÄúDefensive Duplicate LockId Detection‚Äù">‚Äã</a></h2><h3 id="requirements-6" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-6" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>SHOULD Requirements for Operations Querying by LockId</strong> (release, extend, lookup):</p><ul><li>Operations SHOULD omit <code>.limit(1)</code> from lockId queries to enable duplicate detection (ADR-014)</li><li>Operations SHOULD detect and handle duplicate lockId documents defensively</li><li>When duplicates detected: log warning, optionally cleanup expired duplicates, fail-safe on live duplicates</li></ul><p><strong>Implementation guidance</strong>: See JSDoc comments in <code>firestore/operations/*.ts</code> for detection patterns and cleanup strategies.</p><h3 id="rationale-notes-7" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-7" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why SHOULD not MUST</strong>: Defensive feature for operational resilience, not a correctness requirement.</p><p><strong>Why remove .limit(1)</strong>: Firestore&#39;s <code>.limit(1)</code> caps results at 1 document, preventing duplicate detection.</p><p><strong>See ADR-014</strong> for complete rationale and design decisions.</p><hr><h2 id="operation-specific-behavior" tabindex="-1">Operation-Specific Behavior <a class="header-anchor" href="#operation-specific-behavior" aria-label="Permalink to ‚ÄúOperation-Specific Behavior‚Äù">‚Äã</a></h2><h3 id="acquire-operation-requirements" tabindex="-1">Acquire Operation Requirements <a class="header-anchor" href="#acquire-operation-requirements" aria-label="Permalink to ‚ÄúAcquire Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>MUST return authoritative expiresAtMs</strong>: Computed from client time authority (<code>Date.now()</code>) to ensure consistency and accurate heartbeat scheduling. No approximation allowed (see ADR-010).</li><li><strong>MUST compute <code>expiresAtMs</code> inside the transaction using <code>Date.now()</code> captured there; NEVER pre-compute outside the transaction.</strong></li><li>Use <code>db.runTransaction()</code> for atomicity</li><li>Direct document access: <code>collection.doc(key).get()</code></li><li><strong>Time Authority</strong>: MUST use <code>isLive()</code> from <code>common/time-predicates.ts</code> with client time source and <code>TIME_TOLERANCE_MS</code></li><li>Overwrite expired locks atomically with <code>trx.set()</code> after expiry check</li><li><strong>Contention</strong>: Return <code>{ ok: false, reason: &quot;locked&quot; }</code> when lock is held</li><li><strong>System Errors</strong>: Throw <code>LockError</code> with appropriate error code</li><li><strong>Fencing Tokens</strong>: Always include monotonic fence token in successful results</li><li><strong>Storage Key Generation</strong>: MUST call <code>makeStorageKey()</code> from common utilities (see <a href="./interface#storage-key-generation">Storage Key Generation</a>)</li><li><strong>Single-attempt operations</strong>: Firestore backends perform single attempts from API perspective; retry logic handled by <code>lock()</code> helper</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points (before reads, after reads, before writes)</li></ul><h3 id="acquire-operation-rationale-notes" tabindex="-1">Acquire Operation Rationale &amp; Notes <a class="header-anchor" href="#acquire-operation-rationale-notes" aria-label="Permalink to ‚ÄúAcquire Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why runTransaction</strong>: Firestore&#39;s atomic operation primitive. Provides ACID guarantees with automatic retry on conflicts.</p><p><strong>Why direct document access</strong>: O(1) lookup by key. Fastest possible access pattern.</p><p><strong>Internal retries (ADR-009)</strong>: Firestore&#39;s <code>runTransaction()</code> may retry internally for atomicity (platform behavior), but this is transparent to backend API contract.</p><hr><h3 id="release-operation-requirements" tabindex="-1">Release Operation Requirements <a class="header-anchor" href="#release-operation-requirements" aria-label="Permalink to ‚ÄúRelease Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>LockId Validation</strong>: MUST call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li><li><strong>Defensive Duplicate Detection</strong>: SHOULD implement duplicate lockId detection per <a href="#defensive-duplicate-lockid-detection">Defensive Duplicate LockId Detection</a> section (ADR-014)</li><li><strong>MUST implement <a href="./interface#storage-requirements">TOCTOU Protection</a></strong> via Firestore transactions:</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">trx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Query by lockId index (no .limit(1) to enable duplicate detection per ADR-014)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> querySnapshot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(collection.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lockId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;==&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, lockId));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> doc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> querySnapshot.docs[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> doc?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Check conditions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> documentExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">querySnapshot.empty;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ownershipValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data?.lockId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isLockLive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.expiresAtMs, nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Simplified public API result</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLockLive) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Atomically delete the document</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(doc.ref);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>System Errors</strong>: Throw <code>LockError</code> for transaction failures</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points</li></ul><h3 id="release-operation-rationale-notes" tabindex="-1">Release Operation Rationale &amp; Notes <a class="header-anchor" href="#release-operation-rationale-notes" aria-label="Permalink to ‚ÄúRelease Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why query by lockId</strong>: Enables keyless API. Caller doesn&#39;t need to track which key corresponds to which lockId.</p><p><strong>Why explicit ownership verification</strong>: Defense-in-depth. See ADR-003 rationale.</p><hr><h3 id="extend-operation-requirements" tabindex="-1">Extend Operation Requirements <a class="header-anchor" href="#extend-operation-requirements" aria-label="Permalink to ‚ÄúExtend Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>LockId Validation</strong>: MUST call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li><li><strong>Defensive Duplicate Detection</strong>: SHOULD implement duplicate lockId detection per <a href="#defensive-duplicate-lockid-detection">Defensive Duplicate LockId Detection</a> section (ADR-014)</li><li><strong>MUST return authoritative expiresAtMs</strong>: Computed from client time authority (<code>Date.now()</code>) to ensure consistency and accurate heartbeat scheduling. No approximation allowed (see ADR-010).</li><li><strong>MUST compute <code>expiresAtMs</code> inside the transaction using <code>Date.now()</code> captured there; NEVER pre-compute outside the transaction.</strong></li><li><strong>MUST implement <a href="./interface#storage-requirements">TOCTOU Protection</a></strong> via Firestore transactions:</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">trx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // MUST capture nowMs inside transaction for authoritative client-time (ADR-010)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Query by lockId index (no .limit(1) to enable duplicate detection per ADR-014)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> querySnapshot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(collection.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lockId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;==&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, lockId));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> doc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> querySnapshot.docs[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> doc?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Check conditions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> documentExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">querySnapshot.empty;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ownershipValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data?.lockId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isLockLive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.expiresAtMs, nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Simplified public API result</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLockLive) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Compute new expiresAtMs from authoritative time captured inside transaction</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newExpiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nowMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ttlMs;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Atomically update TTL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(doc.ref, { expiresAtMs: newExpiresAtMs });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, expiresAtMs: newExpiresAtMs };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>System Errors</strong>: Throw <code>LockError</code> for transaction failures</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points</li></ul><h3 id="extend-operation-rationale-notes" tabindex="-1">Extend Operation Rationale &amp; Notes <a class="header-anchor" href="#extend-operation-rationale-notes" aria-label="Permalink to ‚ÄúExtend Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why return expiresAtMs</strong>: Critical for heartbeat scheduling. Caller needs exact expiry to schedule next extend operation safely.</p><p><strong>Why reset (not add)</strong>: Simpler mental model. Caller specifies desired total lifetime, not incremental extension.</p><hr><h3 id="islocked-operation-requirements" tabindex="-1">IsLocked Operation Requirements <a class="header-anchor" href="#islocked-operation-requirements" aria-label="Permalink to ‚ÄúIsLocked Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>Use Case</strong>: Simple boolean checks (prefer <code>lookup()</code> for diagnostics)</li><li>Direct document access by key: <code>collection.doc(key).get()</code></li><li><strong>Read-Only by Default</strong>: Cleanup disabled by default to maintain pure read semantics</li><li><strong>Optional Cleanup</strong>: When <code>cleanupInIsLocked: true</code> configured, MAY perform fire-and-forget cleanup following common spec guidelines</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper before and after read operations</li></ul><h3 id="islocked-operation-rationale-notes" tabindex="-1">IsLocked Operation Rationale &amp; Notes <a class="header-anchor" href="#islocked-operation-rationale-notes" aria-label="Permalink to ‚ÄúIsLocked Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why read-only by default</strong>: Users expect <code>isLocked()</code> to be pure query with no side effects. Automatic cleanup violates this expectation.</p><p><strong>Why optional cleanup</strong>: Some deployments may benefit from opportunistic cleanup to reduce storage bloat. Opt-in preserves predictability.</p><hr><h3 id="lookup-operation-requirements" tabindex="-1">Lookup Operation Requirements <a class="header-anchor" href="#lookup-operation-requirements" aria-label="Permalink to ‚ÄúLookup Operation Requirements‚Äù">‚Äã</a></h3><p><strong>Runtime Validation</strong>: MUST validate inputs before any I/O operations:</p><ul><li><strong>Key mode</strong>: Call <code>normalizeAndValidateKey(key)</code> and fail fast on invalid keys</li><li><strong>LockId mode</strong>: Call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li></ul><p><strong>Key Lookup Mode</strong>:</p><ul><li><strong>Implementation</strong>: Direct document access by key: <code>collection.doc(key).get()</code></li><li><strong>Complexity</strong>: O(1) direct access</li><li><strong>Atomicity</strong>: Single document read (inherently atomic)</li><li><strong>Performance</strong>: Direct document access, consistently fast</li></ul><p><strong>LockId Lookup Mode</strong>:</p><ul><li><strong>Implementation</strong>: Query by lockId index: <code>collection.where(&#39;lockId&#39;, &#39;==&#39;, lockId).get()</code> (no <code>.limit(1)</code> per ADR-014)</li><li><strong>Defensive Duplicate Detection</strong>: SHOULD implement duplicate lockId detection per <a href="#defensive-duplicate-lockid-detection">Defensive Duplicate LockId Detection</a> section (ADR-014)</li><li><strong>Complexity</strong>: Index traversal + verification</li><li><strong>Atomicity</strong>: Single indexed query (non-atomic is acceptable per interface.md, as lookup is diagnostic-only; release/extend use transactions for full TOCTOU safety)</li><li><strong>Performance</strong>: Indexed equality query, requires lockId field index</li></ul><p><strong>Common Requirements</strong>:</p><ul><li><strong>Ownership Verification</strong>: For lockId lookup, MUST verify <code>data.lockId === lockId</code> after document retrieval; return <code>null</code> if verification fails</li><li><strong>TOCTOU Safety</strong>: Firestore lookups are inherently safe for diagnostic use - single document/query operations with post-read verification. Per interface.md, non-atomic lookup is acceptable because lookup is diagnostic-only; release/extend operations use transactions for full TOCTOU protection against mutations.</li><li><strong>Expiry Check</strong>: MUST use <code>isLive()</code> from <code>common/time-predicates.ts</code> with <code>Date.now()</code> and <code>TIME_TOLERANCE_MS</code></li><li><strong>Data Transformation Requirement</strong>: TypeScript lookup method MUST compute keyHash and lockIdHash using <code>hashKey()</code>, and return sanitized <code>LockInfo&lt;C&gt;</code></li><li><strong>Return Value</strong>: Return <code>null</code> if document doesn&#39;t exist or is expired; return <code>LockInfo&lt;C&gt;</code> for live locks (MUST include <code>fence</code>)</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper before and after read operations</li></ul><h3 id="lookup-operation-rationale-notes" tabindex="-1">Lookup Operation Rationale &amp; Notes <a class="header-anchor" href="#lookup-operation-rationale-notes" aria-label="Permalink to ‚ÄúLookup Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why ownership verification</strong>: Defense-in-depth. Ensures returned lock actually matches requested lockId, even when using indexed queries.</p><p><strong>Why sanitize in TypeScript</strong>: Firestore retrieves raw data. TypeScript layer sanitizes for security before returning.</p><hr><h2 id="abortsignal-requirements" tabindex="-1">AbortSignal Requirements <a class="header-anchor" href="#abortsignal-requirements" aria-label="Permalink to ‚ÄúAbortSignal Requirements‚Äù">‚Äã</a></h2><h3 id="requirements-7" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-7" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p>Since <code>@google-cloud/firestore</code> does not natively support AbortSignal, backend MUST implement manual cancellation checks using <code>checkAborted()</code> helper from <code>common/helpers.ts</code>.</p><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { checkAborted } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../../common/helpers.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In acquire/release/extend operations using transactions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">trx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before transaction work</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> doc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(docRef);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After reads</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Process data...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before writes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(docRef, data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In isLocked/lookup operations without transactions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> doc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> collection.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After read</span></span></code></pre></div><p><strong>Required Cancellation Points</strong>:</p><ol><li><strong>Before transaction work</strong>: Check immediately upon entering transaction to fail fast</li><li><strong>After reads</strong>: Check after Firestore read operations complete</li><li><strong>Before writes</strong>: Check before performing Firestore write operations</li></ol><p><strong>Error Handling</strong>:</p><ul><li><code>checkAborted(signal)</code> throws <code>LockError(&quot;Aborted&quot;, &quot;Operation aborted by signal&quot;)</code> when signal is aborted</li><li>Provides consistent error semantics across operations</li></ul><p><strong>Testing Requirements</strong>:</p><ul><li>Integration tests MUST verify all operations respect AbortSignal</li><li>Tests MUST verify <code>LockError(&quot;Aborted&quot;)</code> is thrown when signal is aborted</li><li>Tests SHOULD verify operations fail quickly when aborted (&lt; 500ms from abort)</li></ul><h3 id="rationale-notes-8" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-8" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why manual checks</strong>: Firestore&#39;s <code>runTransaction()</code> doesn&#39;t support AbortSignal natively. Manual checks provide reasonable cancellation granularity.</p><p><strong>Why multiple check points</strong>: Provides responsive cancellation without excessive overhead. Strategic placement balances performance and responsiveness.</p><p><strong>Minimal overhead</strong>: Simple boolean checks. No significant performance impact.</p><p><strong>Consistent with Redis</strong>: Redis backend passes signal to ioredis (native support). Firestore manual checks achieve equivalent behavior.</p><hr><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to ‚ÄúError Handling‚Äù">‚Äã</a></h2><h3 id="requirements-8" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-8" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>MUST follow <a href="./interface#centralized-error-mapping">common spec ErrorMappingStandard</a></strong>.</p><p><strong>Key Firestore mappings</strong>:</p><ul><li><strong>ServiceUnavailable</strong>: <code>UNAVAILABLE</code>, <code>INTERNAL</code>, <code>ABORTED</code> (transaction conflicts)</li><li><strong>NetworkTimeout</strong>: <code>DEADLINE_EXCEEDED</code></li><li><strong>AuthFailed</strong>: <code>PERMISSION_DENIED</code>, <code>UNAUTHENTICATED</code></li><li><strong>InvalidArgument</strong>: <code>INVALID_ARGUMENT</code>, <code>FAILED_PRECONDITION</code></li><li><strong>RateLimited</strong>: <code>RESOURCE_EXHAUSTED</code></li><li><strong>Aborted</strong>: Operation cancelled via AbortSignal</li></ul><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Determine conditions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> documentExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">querySnapshot.empty;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ownershipValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data?.lockId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isLockLive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.expiresAtMs, nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Public API: simplified boolean result</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> success</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLockLive;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Internal detail tracking (best-effort, for decorator if telemetry enabled)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> detail</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;not-found&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;expired&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: success };</span></span></code></pre></div><h3 id="rationale-notes-9" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-9" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why map Firestore codes</strong>: Ensures consistent error codes across backends. Users get predictable error handling.</p><p><strong>Why track internal details</strong>: Enables rich telemetry when decorator enabled, without cluttering public API.</p><p><strong>Key Observations</strong>:</p><ul><li><code>!querySnapshot.empty</code> ‚Üí document exists check</li><li><code>data?.lockId === lockId</code> ‚Üí ownership verification (ADR-003)</li><li><code>isLive(...)</code> ‚Üí expiry check using unified liveness predicate</li></ul><hr><h2 id="performance-characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#performance-characteristics" aria-label="Permalink to ‚ÄúPerformance Characteristics‚Äù">‚Äã</a></h2><h3 id="requirements-9" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-9" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><ul><li><strong>Direct document access</strong>: Fast document lookups for acquire and isLocked operations</li><li><strong>Indexed equality queries</strong>: Fast indexed lookups for release and extend operations (requires lockId index)</li><li><strong>Transaction overhead</strong>: ~2-5ms per operation depending on Firestore latency</li><li><strong>Expected throughput</strong>: 100-500 ops/sec depending on region and network</li><li><strong>Single-attempt operations</strong>: Firestore backends perform single attempts only; retry logic handled by <code>lock()</code> helper</li></ul><h3 id="rationale-notes-10" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-10" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Performance targets</strong>: Guide optimization without creating artificial constraints. Actual performance varies by deployment, network, hardware.</p><p><strong>Why lower than Redis</strong>: Network latency to Firestore service + transaction overhead. Redis is typically local or same datacenter.</p><p><strong>Throughput considerations</strong>: Firestore has per-document write limits. High-contention scenarios may require rate limiting.</p><hr><h2 id="configuration-and-testing" tabindex="-1">Configuration and Testing <a class="header-anchor" href="#configuration-and-testing" aria-label="Permalink to ‚ÄúConfiguration and Testing‚Äù">‚Äã</a></h2><h3 id="backend-configuration-requirements" tabindex="-1">Backend Configuration Requirements <a class="header-anchor" href="#backend-configuration-requirements" aria-label="Permalink to ‚ÄúBackend Configuration Requirements‚Äù">‚Äã</a></h3><ul><li><strong>Unified tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> in interface.md for normative specification</li><li><strong>Lock collection</strong>: Configurable via <code>collection</code> option (default: &quot;locks&quot;)</li><li><strong>Fence counter collection</strong>: Configurable via <code>fenceCollection</code> option (default: &quot;fence_counters&quot;)</li><li><strong>Configuration Validation</strong>: Backend MUST validate at initialization: <ul><li><code>fenceCollection !== collection</code></li><li>Both collection names are valid Firestore paths</li><li>When cleanup enabled, verify cleanup operations cannot target fence counter collection</li><li>Throw <code>LockError(&quot;InvalidArgument&quot;)</code> with descriptive message on validation failure</li></ul></li><li><strong>Index requirement</strong>: Single-field ascending index on <code>lockId</code> field (required for release/extend/lookup by lockId)</li><li><strong>Cleanup Configuration</strong>: Optional <code>cleanupInIsLocked: boolean</code> (default: <code>false</code>) <ul><li><strong>CRITICAL</strong>: Cleanup MUST ONLY delete lock documents, NEVER fence counter documents</li></ul></li><li><strong>lookup Implementation</strong>: Required - supports both key and lockId lookup patterns</li></ul><h3 id="backend-configuration-rationale-notes" tabindex="-1">Backend Configuration Rationale &amp; Notes <a class="header-anchor" href="#backend-configuration-rationale-notes" aria-label="Permalink to ‚ÄúBackend Configuration Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why separate collections</strong>: Prevents accidental fence counter deletion. Validation ensures this separation is maintained.</p><p><strong>Why index requirement</strong>: Without index, lockId queries require full collection scans. Performance degrades catastrophically at scale.</p><hr><h3 id="testing-strategy-requirements" tabindex="-1">Testing Strategy Requirements <a class="header-anchor" href="#testing-strategy-requirements" aria-label="Permalink to ‚ÄúTesting Strategy Requirements‚Äù">‚Äã</a></h3><ul><li><strong>Unit tests</strong>: Mock Firestore with in-memory transactions, no external dependencies</li><li><strong>Integration tests</strong>: Real Firestore instance, validates transaction behavior and indexing</li><li><strong>Performance tests</strong>: Measures transaction latency and throughput under load</li><li><strong>Index validation</strong>: Ensures required lockId index exists and performs correctly</li><li><strong>Behavioral compliance testing</strong>: Unit tests MUST verify backend imports and uses <code>isLive()</code> from <code>common/time-predicates.ts</code></li><li><strong>Cross-backend consistency</strong>: Integration tests MUST verify identical outcomes given same tolerance values between Firestore and other backends</li></ul><h3 id="testing-strategy-rationale-notes" tabindex="-1">Testing Strategy Rationale &amp; Notes <a class="header-anchor" href="#testing-strategy-rationale-notes" aria-label="Permalink to ‚ÄúTesting Strategy Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why unit tests with mocks</strong>: Fast feedback loop. No external dependencies for basic correctness checks.</p><p><strong>Why integration tests with real Firestore</strong>: Validates transaction behavior, index performance, actual atomicity guarantees under production-like conditions.</p><p><strong>Why cross-backend tests</strong>: Ensures API consistency. Users should get identical behavior regardless of backend choice (accounting for time authority differences).</p></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kriasoft/syncguard/edit/main/docs/specs/firestore-backend.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-3c637f39>Last updated: <time datetime="2025-12-02T19:52:51.000Z" data-v-3c637f39></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><!----></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/syncguard/what-is-syncguard" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>What is SyncGuard?</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-1df9f90f data-v-c3855bb3><div class="container" data-v-c3855bb3><p class="message" data-v-c3855bb3>Released under the <a href="https://github.com/kriasoft/syncguard/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-c3855bb3>Copyright ¬© 2025-present <a href="https://kriasoft.com" target="_self">Kriasoft</a> ¬∑ Created by <a href="https://github.com/koistya">Konstantin Tarkus</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"adr_000-template.md\":\"BYd1H7EV\",\"adr_003-explicit-ownership-verification.md\":\"CrOAT8nL\",\"adr_004-lexicographic-fence-comparison.md\":\"Drck3Sbp\",\"adr_005-unified-time-tolerance.md\":\"DMCQGcIM\",\"adr_006-mandatory-key-truncation.md\":\"kqKSzXr4\",\"adr_007-opt-in-telemetry.md\":\"Dru7k4_S\",\"adr_008-compile-time-fencing.md\":\"Hx6BUudm\",\"adr_009-retries-in-helpers.md\":\"5jQqlnHS\",\"adr_010-authoritative-expiresat.md\":\"DlswW7wl\",\"adr_011-relaxed-lookup-atomicity.md\":\"DTxMiTJg\",\"adr_012-backend-restatement-pattern.md\":\"BGXQZJVs\",\"adr_013-full-storage-key-in-index.md\":\"4EljCf2Q\",\"adr_014-firestore-duplicate-detection.md\":\"DwrqhQz8\",\"adr_015-async-raii-locks.md\":\"OnHFH4dq\",\"adr_016-disposal-timeout.md\":\"BVohCKfn\",\"adr_index.md\":\"luaogR7b\",\"api.md\":\"DvLLVzpl\",\"core-concepts.md\":\"CG2Uz1mC\",\"fencing.md\":\"DH7hxlo1\",\"firestore.md\":\"CG_nAcqJ\",\"getting-started.md\":\"mjF2b5ww\",\"index.md\":\"CU0V5iVn\",\"issues_time-tolerance.local.md\":\"DrKuAaw8\",\"postgres.md\":\"wOj7Pm3f\",\"redis.md\":\"vVFQZA9N\",\"reference.md\":\"atnObe8h\",\"specs_firestore-backend.md\":\"DBnmDxlp\",\"specs_interface.md\":\"DOQTAngr\",\"specs_postgres-backend.md\":\"DsTdd-iS\",\"specs_readme.md\":\"D1p1hkn_\",\"specs_redis-backend.md\":\"C1GS07Xf\",\"what-is-syncguard.md\":\"BLAjahmf\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"üîí SyncGuard\",\"description\":\"TypeScript distributed lock library that prevents race conditions across services. Because nobody wants their payment processed twice! üí∏\",\"base\":\"/syncguard/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Guide\",\"link\":\"/what-is-syncguard\"},{\"text\":\"Backends\",\"link\":\"/redis\"},{\"text\":\"Reference\",\"link\":\"/api\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/kriasoft/syncguard/edit/main/docs/:path\",\"text\":\"Edit this page on GitHub\"},\"sidebar\":[{\"text\":\"Guide\",\"items\":[{\"text\":\"What is SyncGuard?\",\"link\":\"/what-is-syncguard\"},{\"text\":\"Getting Started\",\"link\":\"/getting-started\"},{\"text\":\"Core Concepts\",\"link\":\"/core-concepts\"},{\"text\":\"Fencing Tokens\",\"link\":\"/fencing\"}]},{\"text\":\"Backends\",\"items\":[{\"text\":\"Redis\",\"link\":\"/redis\"},{\"text\":\"PostgreSQL\",\"link\":\"/postgres\"},{\"text\":\"Firestore\",\"link\":\"/firestore\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API Reference\",\"link\":\"/api\"}]},{\"text\":\"For Developers\",\"items\":[{\"text\":\"Specifications\",\"link\":\"https://github.com/kriasoft/syncguard/tree/main/docs/specs\"},{\"text\":\"Architecture Decisions\",\"link\":\"https://github.com/kriasoft/syncguard/tree/main/docs/adr\"},{\"text\":\"Contributing\",\"link\":\"https://github.com/kriasoft/syncguard/blob/main/.github/CONTRIBUTING.md\"},{\"text\":\"Security Policy\",\"link\":\"https://github.com/kriasoft/syncguard/blob/main/.github/SECURITY.md\"},{\"text\":\"Sponsor\",\"link\":\"https://github.com/sponsors/koistya\"}]}],\"socialLinks\":[{\"icon\":\"x\",\"link\":\"https://x.com/kriasoft\"},{\"icon\":\"discord\",\"link\":\"https://discord.gg/EnbEa7Gsxg\"},{\"icon\":\"github\",\"link\":\"https://github.com/kriasoft/syncguard\"}],\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/kriasoft/syncguard/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright ¬© 2025-present <a href=\\\"https://kriasoft.com\\\" target=\\\"_self\\\">Kriasoft</a> ¬∑ Created by <a href=\\\"https://github.com/koistya\\\">Konstantin Tarkus</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>