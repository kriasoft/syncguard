<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PostgreSQL Backend Specification | üîí SyncGuard</title>
    <meta name="description" content="TypeScript distributed lock library that prevents race conditions across services. Because nobody wants their payment processed twice! üí∏">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/syncguard/assets/style.CxwpygyH.css" as="style">
    <link rel="preload stylesheet" href="/syncguard/vp-icons.css" as="style">
    
    <script type="module" src="/syncguard/assets/app.BAg3_ACq.js"></script>
    <link rel="preload" href="/syncguard/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/syncguard/assets/chunks/theme.DQPWWtTz.js">
    <link rel="modulepreload" href="/syncguard/assets/chunks/framework.Bbpi2Fiw.js">
    <link rel="modulepreload" href="/syncguard/assets/specs_postgres-backend.md.DsTdd-iS.lean.js">
    <link rel="icon" href="/syncguard/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="SyncGuard | Distributed Locks for TypeScript">
    <meta property="og:site_name" content="SyncGuard">
    <meta property="og:url" content="https://kriasoft.com/syncguard/">
    <meta property="og:image" content="https://kriasoft.com/syncguard/og-image.webp">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle has-sidebar" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/syncguard/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>üîí SyncGuard</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/what-is-syncguard" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/redis" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Backends</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/api" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Reference</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/EnbEa7Gsxg" aria-label="discord" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/syncguard" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/EnbEa7Gsxg" aria-label="discord" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/syncguard" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-db738f89><span class="vpi-align-left menu-icon" data-v-db738f89></span><span class="menu-text" data-v-db738f89>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-af661f50><div class="curtain" data-v-af661f50></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af661f50><span class="visually-hidden" id="sidebar-aria-label" data-v-af661f50> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Guide</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/what-is-syncguard" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>What is SyncGuard?</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/getting-started" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Getting Started</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/core-concepts" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Core Concepts</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/fencing" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Fencing Tokens</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Backends</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/redis" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Redis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/postgres" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>PostgreSQL</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/firestore" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Firestore</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>API</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/api" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>API Reference</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>For Developers</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/tree/main/docs/specs" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Specifications</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/tree/main/docs/adr" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Architecture Decisions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/blob/main/.github/CONTRIBUTING.md" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Contributing</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/blob/main/.github/SECURITY.md" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Security Policy</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/sponsors/koistya" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Sponsor</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-sidebar has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _syncguard_specs_postgres-backend" data-v-7011f0d8><div><h1 id="postgresql-backend-specification" tabindex="-1">PostgreSQL Backend Specification <a class="header-anchor" href="#postgresql-backend-specification" aria-label="Permalink to ‚ÄúPostgreSQL Backend Specification‚Äù">‚Äã</a></h1><p>This document defines PostgreSQL-specific implementation requirements that extend the <a href="./interface">common interface specification</a>.</p><hr><blockquote><p>üö´ <strong>CRITICAL: Never Delete Fence Counters</strong></p><p>Fence counter records in the fence table MUST NEVER be deleted. Deleting fence counters breaks monotonicity guarantees and violates fencing safety. Cleanup operations MUST only target lock records in the lock table, never fence counter records.</p></blockquote><hr><h2 id="document-structure" tabindex="-1">Document Structure <a class="header-anchor" href="#document-structure" aria-label="Permalink to ‚ÄúDocument Structure‚Äù">‚Äã</a></h2><p>This specification uses a <strong>normative vs rationale</strong> pattern:</p><ul><li><strong>Requirements</strong> sections contain MUST/SHOULD/MAY/NEVER statements defining the contract</li><li><strong>Rationale &amp; Notes</strong> sections provide background, design decisions, and operational guidance</li></ul><hr><h2 id="table-based-storage-pattern" tabindex="-1">Table-Based Storage Pattern <a class="header-anchor" href="#table-based-storage-pattern" aria-label="Permalink to ‚ÄúTable-Based Storage Pattern‚Äù">‚Äã</a></h2><h3 id="lock-table-requirements" tabindex="-1">Lock Table Requirements <a class="header-anchor" href="#lock-table-requirements" aria-label="Permalink to ‚ÄúLock Table Requirements‚Äù">‚Äã</a></h3><ul><li><p><strong>Table Name</strong>: Default <code>&quot;syncguard_locks&quot;</code>, configurable via <code>tableName</code> option</p></li><li><p><strong>Primary Key</strong>: <code>key</code> column (TEXT) - storage key generated via <code>makeStorageKey()</code></p></li><li><p><strong>Required Indexes</strong>:</p><ul><li>UNIQUE B-tree index on <code>lock_id</code> (TEXT) for reverse lookup and uniqueness enforcement</li><li>B-tree index on <code>expires_at_ms</code> (BIGINT) for efficient cleanup and monitoring</li></ul></li><li><p><strong>Backend-specific limit</strong>: 1700 bytes (see <code>BACKEND_LIMITS.POSTGRES</code> in <code>common/constants.ts</code>)</p><ul><li><strong>Rationale</strong>: Based on PostgreSQL B-tree index tuple size limits (~2704 bytes theoretical maximum per 8KB page), with conservative margin for tuple header overhead, multi-column indexes, and UTF-8 encoding variations</li><li><strong>NOT related to</strong>: PostgreSQL identifier limit (63 bytes) which applies only to schema object names (tables, columns), not row data</li></ul></li><li><p><strong>Reserve Bytes Requirement</strong>: PostgreSQL operations MUST use 0 reserve bytes when calling <code>makeStorageKey()</code></p><ul><li>Formula: <code>0 bytes</code> (no derived keys requiring suffixes; see <code>RESERVE_BYTES.POSTGRES</code>)</li><li>Purpose: PostgreSQL uses separate tables with independent primary keys</li></ul></li><li><p><strong>Table Schema</strong>:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> syncguard_locks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TEXT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  lock_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  expires_at_ms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BIGINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  acquired_at_ms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BIGINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UNIQUE INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_syncguard_locks_lock_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> syncguard_locks(lock_id);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INDEX</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> idx_syncguard_locks_expires</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> syncguard_locks(expires_at_ms);</span></span></code></pre></div></li></ul><h3 id="lock-table-rationale-notes" tabindex="-1">Lock Table Rationale &amp; Notes <a class="header-anchor" href="#lock-table-rationale-notes" aria-label="Permalink to ‚ÄúLock Table Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why primary key on key</strong>: O(1) lookups for acquire/isLocked operations. Fastest possible access pattern for key-based operations.</p><p><strong>Why UNIQUE index on lock_id</strong>:</p><ul><li><strong>Reverse lookup</strong>: Enables efficient release/extend/lookup operations by lockId</li><li><strong>Uniqueness enforcement</strong>: Enforces invariant that each lockId appears at most once in the table</li><li><strong>Correctness guarantee</strong>: Catches implementation bugs where lockIds might be accidentally reused</li><li><strong>Query optimization</strong>: PostgreSQL optimizer knows exactly 0 or 1 row matches, enabling faster lookups</li><li><strong>Negligible overhead</strong>: Same index traversal cost as non-unique, constraint check is O(1)</li><li><strong>Defense-in-depth</strong>: Database enforces what should be cryptographically impossible (lockId collision probability ~2^-128)</li></ul><p><strong>Why index on expires_at_ms</strong>: Enables efficient cleanup queries and operational monitoring. Allows fast queries like <code>SELECT * FROM locks WHERE expires_at_ms &lt; NOW()</code> for cleanup operations and <code>SELECT COUNT(*) WHERE expires_at_ms &gt; NOW()</code> for active lock counting.</p><p><strong>Why 0 reserve bytes</strong>: PostgreSQL tables are completely independent. Lock records, fence counter records, and any other metadata use separate tables without key concatenation.</p><p><strong>Why user_key column</strong>: Preserves original user key for diagnostics and <code>LockInfo</code> sanitization. Storage key may be truncated/hashed.</p><hr><h3 id="fence-counter-table-requirements" tabindex="-1">Fence Counter Table Requirements <a class="header-anchor" href="#fence-counter-table-requirements" aria-label="Permalink to ‚ÄúFence Counter Table Requirements‚Äù">‚Äã</a></h3><ul><li><p><strong>Table Name</strong>: Default <code>&quot;syncguard_fence_counters&quot;</code>, configurable via <code>fenceTableName</code> option</p></li><li><p><strong>Primary Key</strong>: Generated using <a href="./interface#fence-key-derivation">Two-Step Fence Key Derivation Pattern</a> for consistent hash mapping (ADR-006)</p></li><li><p><strong>Table Schema</strong>:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> syncguard_fence_counters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fence_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BIGINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul><p><strong>Critical Requirements</strong>:</p><ul><li><p><strong>Lifecycle Independence</strong>: Fence counters MUST be independent of lock lifecycle. Cleanup operations delete only lock records; counter records are NEVER deleted</p></li><li><p><strong>‚ö†Ô∏è CRITICAL: Fence counters are intentionally persistent</strong> and MUST NOT be deleted:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ‚ùå NEVER do this - breaks monotonicity guarantee</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DELETE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> syncguard_fence_counters </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Violates fencing safety</span></span></code></pre></div></li><li><p><strong>Fence Key Generation</strong>: MUST follow two-step pattern:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { BACKEND_LIMITS, RESERVE_BYTES } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/constants.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> baseKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  normalizedKey,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  BACKEND_LIMITS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">POSTGRES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  RESERVE_BYTES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">POSTGRES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fenceKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `fence:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  BACKEND_LIMITS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">POSTGRES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  RESERVE_BYTES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">POSTGRES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li>Reserve: 0 bytes (PostgreSQL tables are independent; see <code>RESERVE_BYTES.POSTGRES</code>)</li></ul></li><li><p><strong>Storage Format</strong>: Counter stored as <code>BIGINT</code> for efficient atomic increment. Converted to 15-digit zero-padded string in application layer.</p></li></ul><h3 id="fence-counter-table-rationale-notes" tabindex="-1">Fence Counter Table Rationale &amp; Notes <a class="header-anchor" href="#fence-counter-table-rationale-notes" aria-label="Permalink to ‚ÄúFence Counter Table Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why lifecycle independence</strong>: Monotonicity guarantee requires persistent counters. Deleting fence counter would allow reuse, violating safety guarantees.</p><p><strong>Why separate table</strong>: Isolation prevents accidental deletion during cleanup. Configuration validation ensures tables remain distinct.</p><p><strong>Why two-step derivation</strong>: Ensures 1:1 mapping between user keys and fence counters. When truncation occurs, both lock and fence keys hash identically. See interface.md for complete rationale.</p><p><strong>Why BIGINT in counter table</strong>: PostgreSQL&#39;s BIGINT supports 64-bit integers natively for efficient atomic increment (<code>fence + 1</code>). Conversion to string happens once at API boundary.</p><p><strong>Why TEXT in locks table</strong>: API requires fence as 15-digit zero-padded string. No SQL-level fence comparisons needed (all comparison happens in application layer), so storing as TEXT simplifies read operations.</p><p><strong>Critical for correctness</strong>:</p><ul><li><strong>Monotonicity guarantee</strong>: Deleting counters breaks strictly increasing fence token requirement</li><li><strong>Cross-backend consistency</strong>: PostgreSQL must match Redis and Firestore&#39;s fence counter persistence behavior</li><li><strong>Fencing safety</strong>: Counter reset would allow fence token reuse, violating safety guarantees</li></ul><hr><h2 id="configuration-and-validation" tabindex="-1">Configuration and Validation <a class="header-anchor" href="#configuration-and-validation" aria-label="Permalink to ‚ÄúConfiguration and Validation‚Äù">‚Äã</a></h2><h3 id="requirements" tabindex="-1">Requirements <a class="header-anchor" href="#requirements" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostgresBackendOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  tableName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Lock table, default: &quot;syncguard_locks&quot;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  fenceTableName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fence counter table, default: &quot;syncguard_fence_counters&quot;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  cleanupInIsLocked</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Enable cleanup in isLocked, default: false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Schema Setup</strong>: Applications MUST call <code>setupSchema(sql, options?)</code> once during initialization to create required tables and indexes. This is separate from backend creation:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { setupSchema, createPostgresBackend } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;syncguard/postgres&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Setup phase (once, during initialization)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setupSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tableName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app_locks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fenceTableName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app_fence_counters&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Usage phase (synchronous, can be called multiple times)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPostgresBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tableName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app_locks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fenceTableName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app_fence_counters&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>CRITICAL: Configuration Validation Requirements</strong></p><p>Backend MUST validate configuration at initialization time and throw <code>LockError(&quot;InvalidArgument&quot;)</code> if:</p><ol><li><strong>Table Overlap</strong>: <code>fenceTableName === tableName</code> (prevents accidental fence counter deletion)</li><li><strong>Table Naming</strong>: Either table name is empty or contains invalid SQL identifier characters</li><li><strong>SQL Injection Safety</strong>: Table names MUST be validated against SQL injection patterns</li></ol><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// At backend initialization</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (config.fenceTableName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config.tableName) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;InvalidArgument&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;Fence counter table must differ from lock table&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Consistent behavior with unified tolerance</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> postgresBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPostgresBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses TIME_TOLERANCE_MS</span></span></code></pre></div><h3 id="rationale-notes" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why validate at initialization</strong>: Fail-fast principle. Configuration errors should be caught before any operations occur.</p><p><strong>Why require distinct tables</strong>: Prevents catastrophic bugs where cleanup accidentally deletes fence counters, breaking monotonicity.</p><p><strong>Why SQL safety validation</strong>: PostgreSQL table names are used in dynamic SQL. Validation prevents SQL injection vulnerabilities.</p><hr><h2 id="time-authority-liveness-predicate" tabindex="-1">Time Authority &amp; Liveness Predicate <a class="header-anchor" href="#time-authority-liveness-predicate" aria-label="Permalink to ‚ÄúTime Authority &amp; Liveness Predicate‚Äù">‚Äã</a></h2><h3 id="requirements-1" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-1" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>MUST use <a href="./interface#time-authority">unified liveness predicate</a></strong> from <code>common/time-predicates.ts</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> serverTimeMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].now_ms));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> live</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(storedExpiresAtMs, serverTimeMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>Time Authority Model</strong>: PostgreSQL uses <strong>server time</strong> via <code>EXTRACT(EPOCH FROM NOW()) * 1000</code> (ADR-005).</p><p><strong>Server Time Reliability</strong>:</p><ul><li><strong>Single source of truth</strong>: All operations query PostgreSQL server time for consistency</li><li><strong>No NTP requirements</strong>: Client clock accuracy is irrelevant for lock operations</li><li><strong>Predictable behavior</strong>: Lock liveness checks are deterministic across all clients</li><li><strong>High consistency</strong>: Eliminates race conditions caused by multi-client clock skew</li></ul><p><strong>Unified Tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> in interface.md for normative tolerance specification.</p><h3 id="rationale-notes-1" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-1" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why server time</strong>: PostgreSQL&#39;s <code>NOW()</code> function provides authoritative time source, eliminating client clock skew issues (same model as Redis).</p><p><strong>Multi-Client Clock Skew Handling</strong>: All clients use same PostgreSQL server time, preventing race conditions from client clock differences.</p><p><strong>Operational Guidance</strong>: See <a href="./interface#time-authority-tradeoffs">Time Authority Tradeoffs</a> for:</p><ul><li>When to choose PostgreSQL vs Redis/Firestore based on time authority requirements</li><li>Pre-production checklists and production monitoring guidance</li><li>Failure scenarios and mitigation strategies for server time authority</li><li>When PostgreSQL server time might fail (e.g., clock jumps, NTP sync issues)</li></ul><hr><h2 id="backend-capabilities-and-type-safety" tabindex="-1">Backend Capabilities and Type Safety <a class="header-anchor" href="#backend-capabilities-and-type-safety" aria-label="Permalink to ‚ÄúBackend Capabilities and Type Safety‚Äù">‚Äã</a></h2><h3 id="requirements-2" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-2" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p>PostgreSQL backends MUST declare their specific capabilities for enhanced type safety:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PostgresCapabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;postgres&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backend type discriminant</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  supportsFencing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PostgreSQL always provides fencing tokens</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  timeAuthority</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses PostgreSQL server time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> postgresBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PostgresCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  createPostgresBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql);</span></span></code></pre></div><h3 id="rationale-notes-2" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-2" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Ergonomic Usage</strong>: PostgreSQL always provides fencing tokens with compile-time guarantees:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPostgresBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;resource&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // No assertions or type guards needed!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Fence:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result.fence);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Direct comparison works</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastKnownFence) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, result.fence);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Type discriminant benefits</strong>: Enables pattern matching and type-safe backend switching in generic code.</p><hr><h2 id="transaction-based-atomicity" tabindex="-1">Transaction-Based Atomicity <a class="header-anchor" href="#transaction-based-atomicity" aria-label="Permalink to ‚ÄúTransaction-Based Atomicity‚Äù">‚Äã</a></h2><h3 id="requirements-3" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-3" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>ALL mutating operations MUST use postgres.js transactions</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. Capture server time inside transaction</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT EXTRACT(EPOCH FROM NOW()) * 1000 AS now_ms`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].now_ms,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. Read with row-level locks using FOR UPDATE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT * FROM locks WHERE key = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} FOR UPDATE`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. Process data and check conditions</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. Perform atomic mutations</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`INSERT ... ON CONFLICT ... DO UPDATE ...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Required Transaction Characteristics</strong>:</p><ul><li><strong>Isolation Level</strong>: READ COMMITTED (postgres.js default) is sufficient</li><li><strong>Row-Level Locking</strong>: Use <code>FOR UPDATE</code> clause to prevent TOCTOU races</li><li><strong>Time Authority</strong>: MUST capture <code>NOW()</code> inside transaction for authoritative timestamps</li><li><strong>Automatic Rollback</strong>: postgres.js automatically rolls back on errors</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points</li></ul><h3 id="rationale-notes-3" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-3" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why sql.begin()</strong>: Provides ACID guarantees with automatic rollback on errors. PostgreSQL&#39;s transaction model is well-proven for distributed systems.</p><p><strong>Why FOR UPDATE</strong>: Prevents other transactions from modifying locked rows. Essential for TOCTOU protection in release/extend operations.</p><p><strong>Why capture time in transaction</strong>: Ensures authoritative timestamp consistent with transaction isolation. Prevents clock skew between time capture and data mutation.</p><hr><h2 id="explicit-ownership-verification-adr-003" tabindex="-1">Explicit Ownership Verification (ADR-003) <a class="header-anchor" href="#explicit-ownership-verification-adr-003" aria-label="Permalink to ‚ÄúExplicit Ownership Verification (ADR-003)‚Äù">‚Äã</a></h2><h3 id="requirements-4" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-4" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>CRITICAL SECURITY REQUIREMENT</strong>: All release/extend operations MUST include explicit ownership verification after row fetch:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data?.lock_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This verification is MANDATORY even when using FOR UPDATE row locks.</p><h3 id="rationale-notes-4" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-4" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why required despite row locks</strong>: Defense-in-depth. While FOR UPDATE prevents most race conditions, explicit verification guards against:</p><ul><li><strong>Defense-in-depth</strong>: Additional safety layer with negligible performance cost</li><li><strong>Cross-backend consistency</strong>: Ensures PostgreSQL matches Redis and Firestore&#39;s explicit ownership checking</li><li><strong>TOCTOU protection</strong>: Guards against edge cases in atomic read‚Üívalidate‚Üímutate flow</li><li><strong>Code clarity</strong>: Makes ownership verification explicit in transaction logic</li></ul><p><strong>See ADR-003</strong> for complete rationale and cross-backend consistency requirements.</p><hr><h2 id="fencing-token-implementation" tabindex="-1">Fencing Token Implementation <a class="header-anchor" href="#fencing-token-implementation" aria-label="Permalink to ‚ÄúFencing Token Implementation‚Äù">‚Äã</a></h2><p><strong>NORMATIVE IMPLEMENTATION</strong>: See <code>postgres/operations/acquire.ts</code> for canonical transaction pattern with inline documentation.</p><h3 id="required-characteristics" tabindex="-1">Required Characteristics <a class="header-anchor" href="#required-characteristics" aria-label="Permalink to ‚ÄúRequired Characteristics‚Äù">‚Äã</a></h3><ul><li><strong>Dual Table Pattern</strong>: Fence counters in separate table (<code>fence_counters</code>) from lock records (<code>locks</code>)</li><li><strong>Fence Key Generation</strong>: MUST use <a href="./interface#fence-key-derivation">Two-Step Fence Key Derivation Pattern</a></li><li><strong>Lifecycle Independence</strong>: Counter records persist indefinitely; cleanup operations MUST NOT delete counter records</li><li><strong>Atomicity</strong>: Fence increment and lock creation MUST occur within same <code>sql.begin()</code> transaction</li><li><strong>Server Time Authority</strong>: MUST capture <code>EXTRACT(EPOCH FROM NOW()) * 1000</code> inside transaction</li><li><strong>Persistence</strong>: Counter values survive PostgreSQL restarts and lock cleanup operations</li><li><strong>Monotonicity</strong>: Each successful <code>acquire()</code> increments counter atomically using two-step pattern (see Canonical Fence Increment Pattern below)</li><li><strong>Absent-Row Race Protection</strong>: MUST use canonical pattern to prevent duplicate fence values when counter row doesn&#39;t exist</li><li><strong>Initialization</strong>: Start counter at 0, first acquire returns &quot;000000000000001&quot;</li><li><strong>Storage Format</strong>: Store as <code>BIGINT</code> in counter table, convert to 15-digit zero-padded string for API</li><li><strong>Format</strong>: Return 15-digit zero-padded decimal strings for lexicographic ordering</li><li><strong>Overflow Enforcement (ADR-004)</strong>: Backend MUST validate fence value and throw <code>LockError(&quot;Internal&quot;)</code> if fence &gt; <code>FENCE_THRESHOLDS.MAX</code>; MUST log warnings via <code>logFenceWarning()</code> when fence &gt; <code>FENCE_THRESHOLDS.WARN</code>. Canonical threshold values defined in <code>common/constants.ts</code>.</li><li><strong>Table Configuration</strong>: Both lock and fence counter tables MUST be configurable</li></ul><h3 id="canonical-fence-increment-pattern" tabindex="-1">Canonical Fence Increment Pattern <a class="header-anchor" href="#canonical-fence-increment-pattern" aria-label="Permalink to ‚ÄúCanonical Fence Increment Pattern‚Äù">‚Äã</a></h3><p><strong>CRITICAL: Absent-Row Race Protection</strong></p><p>When the fence counter row does not exist, a naive <code>INSERT ... ON CONFLICT ... DO UPDATE</code> allows concurrent transactions to both see &quot;row absent&quot; and both INSERT with fence=1, causing duplicate fence tokens.</p><p><strong>REQUIRED Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Inside sql.begin() transaction</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Step 0: Acquire advisory lock on storage key (serializes concurrent acquires)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT pg_advisory_xact_lock(hashtext(${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">storageKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}))`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Step 1: Ensure row exists (idempotent initialization)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  INSERT INTO ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fenceTableName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} (fence_key, fence, key_debug)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  VALUES (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fenceKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}, 0, ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">normalizedKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">})</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ON CONFLICT (fence_key) DO NOTHING</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Step 2: Increment with implicit row lock (serializes concurrent updates)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fenceResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  UPDATE ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fenceTableName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  SET fence = fence + 1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  WHERE fence_key = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fenceKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  RETURNING fence</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>Why this works</strong>:</p><ol><li><strong>Advisory lock</strong>: <code>pg_advisory_xact_lock()</code> serializes all concurrent transactions working on the same storage key. Transaction-scoped lock is automatically released on commit/rollback.</li><li><strong>INSERT with DO NOTHING</strong>: Ensures row exists. Multiple concurrent INSERTs are safe - winner creates row with fence=0, losers do nothing.</li><li><strong>UPDATE with implicit lock</strong>: PostgreSQL&#39;s UPDATE acquires row-level lock, serializing all concurrent increments. Each transaction waits its turn and gets unique fence value.</li><li><strong>Correctness guarantee</strong>: Even when row is initially absent, all concurrent acquires receive monotonically increasing fence tokens and only one acquires the lock.</li></ol><p><strong>Alternative patterns that are INCORRECT</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå WRONG: Race on absent row</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">INSERT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (${fenceKey}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ON</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CONFLICT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (fence_key) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UPDATE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">RETURNING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Problem: Both see absent row, both INSERT fence=1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå WRONG: FOR UPDATE on absent row</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence_counters </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ${fenceKey} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FOR</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Then INSERT or UPDATE</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Problem: FOR UPDATE returns empty set for absent row, doesn&#39;t block</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå WRONG: No advisory lock</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Without pg_advisory_xact_lock(), even with two-step pattern, concurrent</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// transactions can all succeed at incrementing fence but then race on</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// INSERT ... ON CONFLICT DO UPDATE for the lock record itself</span></span></code></pre></div><h3 id="rationale-notes-5" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-5" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why BIGINT</strong>: PostgreSQL&#39;s BIGINT supports 64-bit integers without precision loss. No need for string-based arithmetic.</p><p><strong>Why convert to string at API boundary</strong>: JavaScript numbers lose precision beyond 2^53-1. String representation preserves full 15-digit values.</p><p><strong>Why advisory lock + two-step pattern</strong>: Prevents both absent-row race condition AND concurrent lock acquisition. Advisory lock serializes entire acquire operation per storage key. Two-step INSERT+UPDATE pattern ensures monotonic fence increments. Together they guarantee exactly one winner even under high concurrency.</p><p><strong>See implementation</strong>: <code>postgres/operations/acquire.ts</code> contains complete transaction logic with defensive guards and error handling.</p><hr><h2 id="operation-specific-behavior" tabindex="-1">Operation-Specific Behavior <a class="header-anchor" href="#operation-specific-behavior" aria-label="Permalink to ‚ÄúOperation-Specific Behavior‚Äù">‚Äã</a></h2><h3 id="acquire-operation-requirements" tabindex="-1">Acquire Operation Requirements <a class="header-anchor" href="#acquire-operation-requirements" aria-label="Permalink to ‚ÄúAcquire Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>MUST return authoritative expiresAtMs</strong>: Computed from PostgreSQL server time authority to ensure consistency and accurate heartbeat scheduling. No approximation allowed (see ADR-010).</li><li><strong>MUST compute <code>expiresAtMs</code> inside the transaction using <code>NOW()</code> captured there; NEVER pre-compute outside the transaction.</strong></li><li>Use <code>sql.begin()</code> for atomicity</li><li>Row-level locking: <code>FOR UPDATE</code> when checking existing locks</li><li><strong>Time Authority</strong>: MUST use <code>isLive()</code> from <code>common/time-predicates.ts</code> with server time and <code>TIME_TOLERANCE_MS</code></li><li>Overwrite expired locks atomically with <code>INSERT ... ON CONFLICT ... DO UPDATE</code></li><li><strong>Contention</strong>: Return <code>{ ok: false, reason: &quot;locked&quot; }</code> when lock is held</li><li><strong>System Errors</strong>: Throw <code>LockError</code> with appropriate error code</li><li><strong>Fencing Tokens</strong>: Always include monotonic fence token in successful results</li><li><strong>Storage Key Generation</strong>: MUST call <code>makeStorageKey()</code> from common utilities (see <a href="./interface#storage-key-generation">Storage Key Generation</a>)</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points (before transaction, after reads, before writes)</li></ul><h3 id="acquire-operation-rationale-notes" tabindex="-1">Acquire Operation Rationale &amp; Notes <a class="header-anchor" href="#acquire-operation-rationale-notes" aria-label="Permalink to ‚ÄúAcquire Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why sql.begin()</strong>: PostgreSQL&#39;s transaction primitive. Provides ACID guarantees with automatic rollback on connection errors.</p><p><strong>Why FOR UPDATE</strong>: Locks row during expiry check. Prevents race where two clients simultaneously see expired lock and both try to acquire.</p><hr><h3 id="release-operation-requirements" tabindex="-1">Release Operation Requirements <a class="header-anchor" href="#release-operation-requirements" aria-label="Permalink to ‚ÄúRelease Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>LockId Validation</strong>: MUST call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li><li><strong>MUST implement <a href="./interface#storage-requirements">TOCTOU Protection</a></strong> via PostgreSQL transactions:</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT EXTRACT(EPOCH FROM NOW()) * 1000 AS now_ms`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].now_ms,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Query by lock_id index with row lock</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    SELECT * FROM ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tableName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    WHERE lock_id = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lockId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    FOR UPDATE</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Check conditions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> documentExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ownershipValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data?.lock_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isLockLive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.expires_at_ms), nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLockLive) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Atomically delete the record</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`DELETE FROM ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tableName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} WHERE key = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>System Errors</strong>: Throw <code>LockError</code> for transaction failures</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points</li></ul><h3 id="release-operation-rationale-notes" tabindex="-1">Release Operation Rationale &amp; Notes <a class="header-anchor" href="#release-operation-rationale-notes" aria-label="Permalink to ‚ÄúRelease Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why query by lock_id</strong>: Enables keyless API. Caller doesn&#39;t need to track which key corresponds to which lockId.</p><p><strong>Why explicit ownership verification</strong>: Defense-in-depth. See ADR-003 rationale.</p><hr><h3 id="extend-operation-requirements" tabindex="-1">Extend Operation Requirements <a class="header-anchor" href="#extend-operation-requirements" aria-label="Permalink to ‚ÄúExtend Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>LockId Validation</strong>: MUST call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li><li><strong>MUST return authoritative expiresAtMs</strong>: Computed from PostgreSQL server time authority to ensure consistency and accurate heartbeat scheduling. No approximation allowed (see ADR-010).</li><li><strong>MUST compute <code>expiresAtMs</code> inside the transaction using <code>NOW()</code> captured there; NEVER pre-compute outside the transaction.</strong></li><li><strong>MUST implement <a href="./interface#storage-requirements">TOCTOU Protection</a></strong> via PostgreSQL transactions:</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT EXTRACT(EPOCH FROM NOW()) * 1000 AS now_ms`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].now_ms,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Query by lock_id index with row lock</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    SELECT * FROM ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tableName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    WHERE lock_id = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lockId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    FOR UPDATE</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Check conditions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> documentExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ownershipValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data?.lock_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isLockLive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.expires_at_ms), nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLockLive) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Compute new expiresAtMs from authoritative time captured inside transaction</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newExpiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nowMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ttlMs;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Atomically update TTL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    UPDATE ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tableName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    SET expires_at_ms = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">newExpiresAtMs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    WHERE key = ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, expiresAtMs: newExpiresAtMs };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>System Errors</strong>: Throw <code>LockError</code> for transaction failures</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper at strategic points</li></ul><h3 id="extend-operation-rationale-notes" tabindex="-1">Extend Operation Rationale &amp; Notes <a class="header-anchor" href="#extend-operation-rationale-notes" aria-label="Permalink to ‚ÄúExtend Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why return expiresAtMs</strong>: Critical for heartbeat scheduling. Caller needs exact expiry to schedule next extend operation safely.</p><p><strong>Why reset (not add)</strong>: Simpler mental model. Caller specifies desired total lifetime, not incremental extension.</p><hr><h3 id="islocked-operation-requirements" tabindex="-1">IsLocked Operation Requirements <a class="header-anchor" href="#islocked-operation-requirements" aria-label="Permalink to ‚ÄúIsLocked Operation Requirements‚Äù">‚Äã</a></h3><ul><li><strong>Use Case</strong>: Simple boolean checks (prefer <code>lookup()</code> for diagnostics)</li><li>Direct row access by key: <code>SELECT expires_at_ms FROM locks WHERE key = $1</code></li><li><strong>Read-Only by Default</strong>: Cleanup disabled by default to maintain pure read semantics</li><li><strong>Optional Cleanup</strong>: When <code>cleanupInIsLocked: true</code> configured, MAY perform fire-and-forget cleanup following common spec guidelines</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper before and after read operations</li></ul><h3 id="islocked-operation-rationale-notes" tabindex="-1">IsLocked Operation Rationale &amp; Notes <a class="header-anchor" href="#islocked-operation-rationale-notes" aria-label="Permalink to ‚ÄúIsLocked Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why read-only by default</strong>: Users expect <code>isLocked()</code> to be pure query with no side effects. Automatic cleanup violates this expectation.</p><p><strong>Why optional cleanup</strong>: Some deployments may benefit from opportunistic cleanup to reduce table bloat. Opt-in preserves predictability.</p><hr><h3 id="lookup-operation-requirements" tabindex="-1">Lookup Operation Requirements <a class="header-anchor" href="#lookup-operation-requirements" aria-label="Permalink to ‚ÄúLookup Operation Requirements‚Äù">‚Äã</a></h3><p><strong>Runtime Validation</strong>: MUST validate inputs before any I/O operations:</p><ul><li><strong>Key mode</strong>: Call <code>normalizeAndValidateKey(key)</code> and fail fast on invalid keys</li><li><strong>LockId mode</strong>: Call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li></ul><p><strong>Key Lookup Mode</strong>:</p><ul><li><strong>Implementation</strong>: Direct row access by primary key: <code>SELECT * FROM locks WHERE key = $1</code></li><li><strong>Complexity</strong>: O(1) direct access via primary key</li><li><strong>Atomicity</strong>: Single row read (inherently atomic)</li><li><strong>Performance</strong>: Primary key lookup, consistently fast</li></ul><p><strong>LockId Lookup Mode</strong>:</p><ul><li><strong>Implementation</strong>: Query by lock_id index: <code>SELECT * FROM locks WHERE lock_id = $1</code></li><li><strong>Complexity</strong>: Index traversal + verification</li><li><strong>Atomicity</strong>: Single indexed query (non-atomic is acceptable per interface.md, as lookup is diagnostic-only; release/extend use transactions for full TOCTOU safety)</li><li><strong>Performance</strong>: Indexed equality query, requires lock_id index</li></ul><p><strong>Common Requirements</strong>:</p><ul><li><strong>Ownership Verification</strong>: For lockId lookup, MUST verify <code>data.lock_id === lockId</code> after row retrieval; return <code>null</code> if verification fails</li><li><strong>TOCTOU Safety</strong>: PostgreSQL lookups are inherently safe for diagnostic use - single row/query operations with post-read verification. Per interface.md, non-atomic lookup is acceptable because lookup is diagnostic-only; release/extend operations use transactions for full TOCTOU protection against mutations.</li><li><strong>Expiry Check</strong>: MUST use <code>isLive()</code> from <code>common/time-predicates.ts</code> with server time and <code>TIME_TOLERANCE_MS</code></li><li><strong>Data Transformation Requirement</strong>: TypeScript lookup method MUST compute keyHash and lockIdHash using <code>hashKey()</code>, and return sanitized <code>LockInfo&lt;C&gt;</code></li><li><strong>Return Value</strong>: Return <code>null</code> if row doesn&#39;t exist or is expired; return <code>LockInfo&lt;C&gt;</code> for live locks (MUST include <code>fence</code>)</li><li><strong>AbortSignal Support</strong>: MUST check <code>signal.aborted</code> via <code>checkAborted()</code> helper before and after read operations</li></ul><h3 id="lookup-operation-rationale-notes" tabindex="-1">Lookup Operation Rationale &amp; Notes <a class="header-anchor" href="#lookup-operation-rationale-notes" aria-label="Permalink to ‚ÄúLookup Operation Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why ownership verification</strong>: Defense-in-depth. Ensures returned lock actually matches requested lockId, even when using indexed queries.</p><p><strong>Why sanitize in TypeScript</strong>: PostgreSQL retrieves raw data. TypeScript layer sanitizes for security before returning.</p><hr><h2 id="abortsignal-requirements" tabindex="-1">AbortSignal Requirements <a class="header-anchor" href="#abortsignal-requirements" aria-label="Permalink to ‚ÄúAbortSignal Requirements‚Äù">‚Äã</a></h2><h3 id="requirements-5" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-5" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p>Since <code>postgres</code> library does not natively support AbortSignal, backend MUST implement manual cancellation checks using <code>checkAborted()</code> helper from <code>common/helpers.ts</code>.</p><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { checkAborted } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../../common/helpers.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In acquire/release/extend operations using transactions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before transaction work</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT ...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After reads</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Process data...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before writes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`INSERT ...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In isLocked/lookup operations without transactions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rows</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sql</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`SELECT ...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkAborted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.signal); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After read</span></span></code></pre></div><p><strong>Required Cancellation Points</strong>:</p><ol><li><strong>Before transaction work</strong>: Check immediately upon entering transaction to fail fast</li><li><strong>After reads</strong>: Check after PostgreSQL read operations complete</li><li><strong>Before writes</strong>: Check before performing PostgreSQL write operations</li></ol><p><strong>Error Handling</strong>:</p><ul><li><code>checkAborted(signal)</code> throws <code>LockError(&quot;Aborted&quot;, &quot;Operation aborted by signal&quot;)</code> when signal is aborted</li><li>Provides consistent error semantics across operations</li></ul><p><strong>Testing Requirements</strong>:</p><ul><li>Integration tests MUST verify all operations respect AbortSignal</li><li>Tests MUST verify <code>LockError(&quot;Aborted&quot;)</code> is thrown when signal is aborted</li><li>Tests SHOULD verify operations fail quickly when aborted (&lt; 500ms from abort)</li></ul><h3 id="rationale-notes-6" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-6" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why manual checks</strong>: postgres.js doesn&#39;t support AbortSignal natively. Manual checks provide reasonable cancellation granularity.</p><p><strong>Why multiple check points</strong>: Provides responsive cancellation without excessive overhead. Strategic placement balances performance and responsiveness.</p><p><strong>Minimal overhead</strong>: Simple boolean checks. No significant performance impact.</p><p><strong>Consistent with other backends</strong>: Redis and Firestore backends use same approach where native support unavailable.</p><hr><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to ‚ÄúError Handling‚Äù">‚Äã</a></h2><h3 id="requirements-6" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-6" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><p><strong>MUST follow <a href="./interface#centralized-error-mapping">common spec ErrorMappingStandard</a></strong>.</p><p><strong>Key PostgreSQL mappings</strong>:</p><ul><li><strong>ServiceUnavailable</strong>: Connection errors (<code>ECONNREFUSED</code>, <code>ECONNRESET</code>), <code>53000</code> (insufficient resources)</li><li><strong>NetworkTimeout</strong>: Connection timeouts, query timeouts</li><li><strong>AuthFailed</strong>: <code>28000</code> (invalid authorization), <code>28P01</code> (invalid password)</li><li><strong>InvalidArgument</strong>: <code>22000</code> (data exception), <code>23000</code> (integrity constraint violation)</li><li><strong>RateLimited</strong>: Connection pool exhaustion</li><li><strong>Aborted</strong>: Operation cancelled via AbortSignal</li></ul><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { isLive, TIME_TOLERANCE_MS } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Determine conditions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> documentExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ownershipValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data?.lock_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isLockLive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.expires_at_ms), nowMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Public API: simplified boolean result</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> success</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> documentExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ownershipValid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLockLive;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: success };</span></span></code></pre></div><h3 id="rationale-notes-7" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-7" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why map PostgreSQL error codes</strong>: Ensures consistent error codes across backends. Users get predictable error handling.</p><p><strong>Key Observations</strong>:</p><ul><li><code>rows.length &gt; 0</code> ‚Üí row exists check</li><li><code>data?.lock_id === lockId</code> ‚Üí ownership verification (ADR-003)</li><li><code>isLive(...)</code> ‚Üí expiry check using unified liveness predicate</li></ul><hr><h2 id="performance-characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#performance-characteristics" aria-label="Permalink to ‚ÄúPerformance Characteristics‚Äù">‚Äã</a></h2><h3 id="requirements-7" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-7" aria-label="Permalink to ‚ÄúRequirements‚Äù">‚Äã</a></h3><ul><li><strong>Primary key access</strong>: Fast row lookups for acquire and isLocked operations (O(1))</li><li><strong>Indexed equality queries</strong>: Fast indexed lookups for release and extend operations (requires lock_id index)</li><li><strong>Transaction overhead</strong>: ~2-5ms per operation depending on PostgreSQL configuration and load</li><li><strong>Expected throughput</strong>: 500-2000 ops/sec depending on hardware and connection pooling</li><li><strong>Connection pooling</strong>: Use postgres.js connection pooling for optimal performance</li></ul><h3 id="rationale-notes-8" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-8" aria-label="Permalink to ‚ÄúRationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Performance targets</strong>: Guide optimization without creating artificial constraints. Actual performance varies by deployment, network, hardware.</p><p><strong>Why competitive with Redis</strong>: PostgreSQL&#39;s transaction isolation and MVCC provide excellent concurrency. Local PostgreSQL instances achieve sub-millisecond latency.</p><p><strong>Why connection pooling critical</strong>: Transaction overhead amortized across pooled connections. Single connection becomes bottleneck under load.</p><hr><h2 id="configuration-and-testing" tabindex="-1">Configuration and Testing <a class="header-anchor" href="#configuration-and-testing" aria-label="Permalink to ‚ÄúConfiguration and Testing‚Äù">‚Äã</a></h2><h3 id="backend-configuration-requirements" tabindex="-1">Backend Configuration Requirements <a class="header-anchor" href="#backend-configuration-requirements" aria-label="Permalink to ‚ÄúBackend Configuration Requirements‚Äù">‚Äã</a></h3><ul><li><strong>Unified tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> in interface.md for normative specification</li><li><strong>Lock table</strong>: Configurable via <code>tableName</code> option (default: &quot;syncguard_locks&quot;)</li><li><strong>Fence counter table</strong>: Configurable via <code>fenceTableName</code> option (default: &quot;syncguard_fence_counters&quot;)</li><li><strong>Configuration Validation</strong>: Backend MUST validate at initialization: <ul><li><code>fenceTableName !== tableName</code></li><li>Both table names are valid SQL identifiers</li><li>Throw <code>LockError(&quot;InvalidArgument&quot;)</code> with descriptive message on validation failure</li></ul></li><li><strong>Index requirements</strong>: <ul><li>UNIQUE B-tree index on <code>lock_id</code> (required for release/extend/lookup by lockId, enforces uniqueness invariant)</li><li>B-tree index on <code>expires_at_ms</code> (required for efficient cleanup and monitoring queries)</li></ul></li><li><strong>Cleanup Configuration</strong>: Optional <code>cleanupInIsLocked: boolean</code> (default: <code>false</code>) <ul><li><strong>CRITICAL</strong>: Cleanup MUST ONLY delete lock records, NEVER fence counter records</li></ul></li><li><strong>Schema Setup</strong>: Applications MUST call <code>setupSchema(sql, options?)</code> once before using backend</li><li><strong>lookup Implementation</strong>: Required - supports both key and lockId lookup patterns</li></ul><h3 id="backend-configuration-rationale-notes" tabindex="-1">Backend Configuration Rationale &amp; Notes <a class="header-anchor" href="#backend-configuration-rationale-notes" aria-label="Permalink to ‚ÄúBackend Configuration Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why separate tables</strong>: Prevents accidental fence counter deletion. Validation ensures this separation is maintained.</p><p><strong>Why UNIQUE lock_id index</strong>:</p><ul><li>Without index, lock_id queries require full table scans (catastrophic at scale)</li><li>UNIQUE constraint enforces correctness: each lockId appears at most once</li><li>Query optimizer benefits: knows exactly 0 or 1 row will match</li><li>Negligible overhead: constraint check is O(1) for B-tree index</li></ul><p><strong>Why expires_at_ms index</strong>: Enables efficient cleanup queries (<code>WHERE expires_at_ms &lt; NOW()</code>) and monitoring queries (<code>COUNT(*) WHERE expires_at_ms &gt; NOW()</code>). Without index, these operations require full table scans.</p><p><strong>Why separate setup function</strong>: Proper separation of concerns. Schema operations are setup tasks that should be explicit and controllable, not hidden inside factory functions.</p><hr><h3 id="testing-strategy-requirements" tabindex="-1">Testing Strategy Requirements <a class="header-anchor" href="#testing-strategy-requirements" aria-label="Permalink to ‚ÄúTesting Strategy Requirements‚Äù">‚Äã</a></h3><ul><li><strong>Unit tests</strong>: Mock postgres.js with in-memory transactions, no external dependencies</li><li><strong>Integration tests</strong>: Real PostgreSQL instance, validates transaction behavior and indexing</li><li><strong>Performance tests</strong>: Measures transaction latency and throughput under load</li><li><strong>Index validation</strong>: Ensures required lock_id index exists and performs correctly</li><li><strong>Behavioral compliance testing</strong>: Unit tests MUST verify backend imports and uses <code>isLive()</code> from <code>common/time-predicates.ts</code></li><li><strong>Cross-backend consistency</strong>: Integration tests MUST verify identical outcomes given same tolerance values between PostgreSQL and other backends</li></ul><h3 id="testing-strategy-rationale-notes" tabindex="-1">Testing Strategy Rationale &amp; Notes <a class="header-anchor" href="#testing-strategy-rationale-notes" aria-label="Permalink to ‚ÄúTesting Strategy Rationale &amp; Notes‚Äù">‚Äã</a></h3><p><strong>Why unit tests with mocks</strong>: Fast feedback loop. No external dependencies for basic correctness checks.</p><p><strong>Why integration tests with real PostgreSQL</strong>: Validates transaction behavior, index performance, actual atomicity guarantees under production-like conditions.</p><p><strong>Why cross-backend tests</strong>: Ensures API consistency. Users should get identical behavior regardless of backend choice (accounting for time authority differences).</p></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kriasoft/syncguard/edit/main/docs/specs/postgres-backend.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-3c637f39>Last updated: <time datetime="2025-12-02T19:52:51.000Z" data-v-3c637f39></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><!----></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/syncguard/what-is-syncguard" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>What is SyncGuard?</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-1df9f90f data-v-c3855bb3><div class="container" data-v-c3855bb3><p class="message" data-v-c3855bb3>Released under the <a href="https://github.com/kriasoft/syncguard/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-c3855bb3>Copyright ¬© 2025-present <a href="https://kriasoft.com" target="_self">Kriasoft</a> ¬∑ Created by <a href="https://github.com/koistya">Konstantin Tarkus</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"adr_000-template.md\":\"BYd1H7EV\",\"adr_003-explicit-ownership-verification.md\":\"CrOAT8nL\",\"adr_004-lexicographic-fence-comparison.md\":\"Drck3Sbp\",\"adr_005-unified-time-tolerance.md\":\"DMCQGcIM\",\"adr_006-mandatory-key-truncation.md\":\"kqKSzXr4\",\"adr_007-opt-in-telemetry.md\":\"Dru7k4_S\",\"adr_008-compile-time-fencing.md\":\"Hx6BUudm\",\"adr_009-retries-in-helpers.md\":\"5jQqlnHS\",\"adr_010-authoritative-expiresat.md\":\"DlswW7wl\",\"adr_011-relaxed-lookup-atomicity.md\":\"DTxMiTJg\",\"adr_012-backend-restatement-pattern.md\":\"BGXQZJVs\",\"adr_013-full-storage-key-in-index.md\":\"4EljCf2Q\",\"adr_014-firestore-duplicate-detection.md\":\"DwrqhQz8\",\"adr_015-async-raii-locks.md\":\"OnHFH4dq\",\"adr_016-disposal-timeout.md\":\"BVohCKfn\",\"adr_index.md\":\"luaogR7b\",\"api.md\":\"DvLLVzpl\",\"core-concepts.md\":\"CG2Uz1mC\",\"fencing.md\":\"DH7hxlo1\",\"firestore.md\":\"CG_nAcqJ\",\"getting-started.md\":\"mjF2b5ww\",\"index.md\":\"CU0V5iVn\",\"issues_time-tolerance.local.md\":\"DrKuAaw8\",\"postgres.md\":\"wOj7Pm3f\",\"redis.md\":\"vVFQZA9N\",\"reference.md\":\"atnObe8h\",\"specs_firestore-backend.md\":\"DBnmDxlp\",\"specs_interface.md\":\"DOQTAngr\",\"specs_postgres-backend.md\":\"DsTdd-iS\",\"specs_readme.md\":\"D1p1hkn_\",\"specs_redis-backend.md\":\"C1GS07Xf\",\"what-is-syncguard.md\":\"BLAjahmf\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"üîí SyncGuard\",\"description\":\"TypeScript distributed lock library that prevents race conditions across services. Because nobody wants their payment processed twice! üí∏\",\"base\":\"/syncguard/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Guide\",\"link\":\"/what-is-syncguard\"},{\"text\":\"Backends\",\"link\":\"/redis\"},{\"text\":\"Reference\",\"link\":\"/api\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/kriasoft/syncguard/edit/main/docs/:path\",\"text\":\"Edit this page on GitHub\"},\"sidebar\":[{\"text\":\"Guide\",\"items\":[{\"text\":\"What is SyncGuard?\",\"link\":\"/what-is-syncguard\"},{\"text\":\"Getting Started\",\"link\":\"/getting-started\"},{\"text\":\"Core Concepts\",\"link\":\"/core-concepts\"},{\"text\":\"Fencing Tokens\",\"link\":\"/fencing\"}]},{\"text\":\"Backends\",\"items\":[{\"text\":\"Redis\",\"link\":\"/redis\"},{\"text\":\"PostgreSQL\",\"link\":\"/postgres\"},{\"text\":\"Firestore\",\"link\":\"/firestore\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API Reference\",\"link\":\"/api\"}]},{\"text\":\"For Developers\",\"items\":[{\"text\":\"Specifications\",\"link\":\"https://github.com/kriasoft/syncguard/tree/main/docs/specs\"},{\"text\":\"Architecture Decisions\",\"link\":\"https://github.com/kriasoft/syncguard/tree/main/docs/adr\"},{\"text\":\"Contributing\",\"link\":\"https://github.com/kriasoft/syncguard/blob/main/.github/CONTRIBUTING.md\"},{\"text\":\"Security Policy\",\"link\":\"https://github.com/kriasoft/syncguard/blob/main/.github/SECURITY.md\"},{\"text\":\"Sponsor\",\"link\":\"https://github.com/sponsors/koistya\"}]}],\"socialLinks\":[{\"icon\":\"x\",\"link\":\"https://x.com/kriasoft\"},{\"icon\":\"discord\",\"link\":\"https://discord.gg/EnbEa7Gsxg\"},{\"icon\":\"github\",\"link\":\"https://github.com/kriasoft/syncguard\"}],\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/kriasoft/syncguard/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright ¬© 2025-present <a href=\\\"https://kriasoft.com\\\" target=\\\"_self\\\">Kriasoft</a> ¬∑ Created by <a href=\\\"https://github.com/koistya\\\">Konstantin Tarkus</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>