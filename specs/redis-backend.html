<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis Backend Specification | ðŸ”’ SyncGuard</title>
    <meta name="description" content="TypeScript distributed lock library that prevents race conditions across services. Because nobody wants their payment processed twice! ðŸ’¸">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/syncguard/assets/style.CxwpygyH.css" as="style">
    <link rel="preload stylesheet" href="/syncguard/vp-icons.css" as="style">
    
    <script type="module" src="/syncguard/assets/app.BAg3_ACq.js"></script>
    <link rel="preload" href="/syncguard/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/syncguard/assets/chunks/theme.DQPWWtTz.js">
    <link rel="modulepreload" href="/syncguard/assets/chunks/framework.Bbpi2Fiw.js">
    <link rel="modulepreload" href="/syncguard/assets/specs_redis-backend.md.C1GS07Xf.lean.js">
    <link rel="icon" href="/syncguard/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="SyncGuard | Distributed Locks for TypeScript">
    <meta property="og:site_name" content="SyncGuard">
    <meta property="og:url" content="https://kriasoft.com/syncguard/">
    <meta property="og:image" content="https://kriasoft.com/syncguard/og-image.webp">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle has-sidebar" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/syncguard/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>ðŸ”’ SyncGuard</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/what-is-syncguard" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/redis" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Backends</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/syncguard/api" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Reference</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/EnbEa7Gsxg" aria-label="discord" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/syncguard" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/EnbEa7Gsxg" aria-label="discord" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/syncguard" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-db738f89><span class="vpi-align-left menu-icon" data-v-db738f89></span><span class="menu-text" data-v-db738f89>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-af661f50><div class="curtain" data-v-af661f50></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af661f50><span class="visually-hidden" id="sidebar-aria-label" data-v-af661f50> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Guide</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/what-is-syncguard" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>What is SyncGuard?</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/getting-started" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Getting Started</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/core-concepts" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Core Concepts</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/fencing" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Fencing Tokens</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Backends</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/redis" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Redis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/postgres" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>PostgreSQL</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/firestore" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Firestore</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>API</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/syncguard/api" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>API Reference</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>For Developers</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/tree/main/docs/specs" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Specifications</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/tree/main/docs/adr" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Architecture Decisions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/blob/main/.github/CONTRIBUTING.md" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Contributing</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/syncguard/blob/main/.github/SECURITY.md" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Security Policy</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/sponsors/koistya" target="_blank" rel="noreferrer" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Sponsor</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-sidebar has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _syncguard_specs_redis-backend" data-v-7011f0d8><div><h1 id="redis-backend-specification" tabindex="-1">Redis Backend Specification <a class="header-anchor" href="#redis-backend-specification" aria-label="Permalink to â€œRedis Backend Specificationâ€">â€‹</a></h1><p>This document defines Redis-specific implementation requirements that extend the <a href="./interface">common interface specification</a>.</p><hr><blockquote><p>ðŸš« <strong>CRITICAL: Never Delete Fence Counters</strong></p><p>Fence counter keys (<code>{prefix}:fence:{key}</code>) MUST NEVER be deleted or assigned TTL. Deleting fence counters breaks monotonicity guarantees and violates fencing safety. Cleanup operations MUST only target lock data keys (main lock and reverse index), never fence counters.</p></blockquote><hr><h2 id="document-structure" tabindex="-1">Document Structure <a class="header-anchor" href="#document-structure" aria-label="Permalink to â€œDocument Structureâ€">â€‹</a></h2><p>This specification uses a <strong>normative vs rationale</strong> pattern:</p><ul><li><strong>Requirements</strong> sections contain MUST/SHOULD/MAY/NEVER statements defining the contract</li><li><strong>Rationale &amp; Notes</strong> sections provide background, design decisions, and operational guidance</li></ul><hr><h2 id="dual-key-storage-pattern" tabindex="-1">Dual-Key Storage Pattern <a class="header-anchor" href="#dual-key-storage-pattern" aria-label="Permalink to â€œDual-Key Storage Patternâ€">â€‹</a></h2><h3 id="requirements" tabindex="-1">Requirements <a class="header-anchor" href="#requirements" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p><strong>Main lock key</strong>: <code>{keyPrefix}:{key}</code> stores JSON lock data <strong>Index key</strong>: <code>{keyPrefix}:id:{lockId}</code> stores full <code>lockKey</code> for reverse lookup (ADR-013)</p><ul><li>Both keys MUST have identical TTL for consistency</li><li>Use <code>redis.call(&#39;SET&#39;, key, data, &#39;PX&#39;, ttlMs)</code> for atomic set-with-TTL</li><li><strong>Storage Key Generation</strong>: MUST call <code>makeStorageKey()</code> from common utilities (see <a href="./interface#storage-key-generation">Storage Key Generation</a>)</li><li><strong>Backend-specific limit</strong>: <code>EFFECTIVE_KEY_BUDGET_BYTES = 1000</code> (chosen for predictable memory/ops headroom; not a Redis hard limit)</li><li><strong>Reserve Bytes Requirement</strong>: Redis operations MUST reserve 26 bytes for derived keys when calling <code>makeStorageKey()</code>: <ul><li>Formula: <code>&quot;:id:&quot; (4 bytes) + lockId (22 bytes) = 26 bytes</code></li><li>Purpose: Ensures derived keys like <code>${prefix}:id:${lockId}</code> fit within the effective budget</li></ul></li></ul><h3 id="rationale-notes" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why dual-key pattern</strong>: Enables fast reverse lookup (lockId â†’ key) required for release/extend operations. Single-key approaches would require scanning or secondary indexes.</p><p><strong>Why identical TTL</strong>: Prevents orphaned index keys. If index outlives lock, lookup returns stale data. If lock outlives index, release/extend fail incorrectly.</p><p><strong>Why 26-byte reserve</strong>: Redis constructs multiple keys from base (main lock + reverse index). Reserve ensures all derived keys fit within the effective budget when base key is at maximum length.</p><hr><h2 id="script-caching-for-performance" tabindex="-1">Script Caching for Performance <a class="header-anchor" href="#script-caching-for-performance" aria-label="Permalink to â€œScript Caching for Performanceâ€">â€‹</a></h2><h3 id="requirements-1" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-1" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><ul><li><strong>Primary approach</strong>: Use ioredis <code>defineCommand()</code> for automatic EVALSHA caching</li><li><strong>Fallback</strong>: Graceful fallback to <code>redis.eval()</code> for test mocks</li><li>Scripts defined once during backend initialization for optimal performance</li><li>ioredis handles SCRIPT LOAD + EVALSHA + NOSCRIPT error recovery automatically</li></ul><h3 id="rationale-notes-1" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-1" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why defineCommand</strong>: ioredis manages the entire caching lifecycle automatically. First call loads script via SCRIPT LOAD, subsequent calls use EVALSHA. If Redis restarts and loses scripts, ioredis automatically reloads via NOSCRIPT error handling.</p><p><strong>Why fallback to eval</strong>: Test mocks often don&#39;t implement full Redis command set. Fallback enables unit testing without external dependencies.</p><p><strong>Performance impact</strong>: EVALSHA reduces network overhead from ~1KB (full script) to ~40 bytes (SHA hash). At 10K ops/sec, saves ~9.6MB/sec network bandwidth.</p><hr><h2 id="lua-scripts-for-atomicity" tabindex="-1">Lua Scripts for Atomicity <a class="header-anchor" href="#lua-scripts-for-atomicity" aria-label="Permalink to â€œLua Scripts for Atomicityâ€">â€‹</a></h2><h3 id="requirements-2" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-2" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><ul><li>ALL mutating operations MUST use Lua scripts</li><li>Scripts centralized in <code>redis/scripts.ts</code> with descriptive comments</li><li>Use <code>cjson.decode()/cjson.encode()</code> for JSON handling in Lua</li><li>Script return codes MUST follow operation-specific semantics (see <a href="#script-implementation-patterns">Script Return Code Semantics</a> for complete mapping)</li><li>Scripts handle lock contention via return codes, backend throws LockError for Redis errors</li><li>Pass all required data as KEYS and ARGV to avoid closure issues</li></ul><h3 id="rationale-notes-2" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-2" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why Lua scripts</strong>: Redis Lua scripts execute atomically. Provides ACID guarantees without complex client-side transaction logic.</p><p><strong>Why centralized scripts</strong>: Single source of truth. Prevents script duplication and drift across operations.</p><p><strong>Why KEYS/ARGV pattern</strong>: Lua closures over external variables can cause subtle bugs. Explicit parameters make data flow visible and testable.</p><hr><h2 id="explicit-ownership-verification-adr-003" tabindex="-1">Explicit Ownership Verification (ADR-003) <a class="header-anchor" href="#explicit-ownership-verification-adr-003" aria-label="Permalink to â€œExplicit Ownership Verification (ADR-003)â€">â€‹</a></h2><h3 id="requirements-3" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-3" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p><strong>ALL Redis scripts MUST include explicit ownership verification</strong>:</p><div class="language-lua"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- After loading lock data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ~=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lockId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Ownership mismatch</span></span></code></pre></div><p>This verification is MANDATORY even when using atomic scripts.</p><h3 id="rationale-notes-3" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-3" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why required despite atomicity</strong>: Defense-in-depth. While atomic scripts prevent most race conditions, explicit verification guards against:</p><ul><li><strong>Stale reverse mappings</strong>: Cleanup race conditions where index key exists but points to wrong lock</li><li><strong>Cross-backend consistency</strong>: Both Redis and Firestore must implement identical ownership checking</li><li><strong>Security requirement</strong>: Prevents wrong-lock mutations in all scenarios (ADR-003 compliance)</li></ul><p><strong>Edge case example</strong>: Index key survives TTL cleanup due to timing window. Without explicit verification, release could affect unrelated lock that reused the same key.</p><hr><h2 id="time-authority-liveness-predicate" tabindex="-1">Time Authority &amp; Liveness Predicate <a class="header-anchor" href="#time-authority-liveness-predicate" aria-label="Permalink to â€œTime Authority &amp; Liveness Predicateâ€">â€‹</a></h2><h3 id="requirements-4" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-4" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p><strong>MUST use <a href="./interface#time-authority">unified liveness predicate</a></strong> from <code>common/time-predicates.ts</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  isLive,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  calculateRedisServerTimeMs,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  TIME_TOLERANCE_MS,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> serverTimeMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateRedisServerTimeMs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TIME&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> live</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isLive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(storedExpiresAtMs, serverTimeMs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIME_TOLERANCE_MS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>Time Authority Model</strong>: Redis uses <strong>server time</strong> via <code>redis.call(&#39;TIME&#39;)</code> (ADR-005).</p><h3 id="rationale-notes-4" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-4" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why server time</strong>: All lock operations use a single authoritative time source, eliminating client clock skew issues.</p><p><strong>Server Time Reliability</strong>:</p><ul><li><strong>Single source of truth</strong>: All clients query the same Redis server time for consistency</li><li><strong>No NTP requirements</strong>: Client clock accuracy is irrelevant for lock operations</li><li><strong>Predictable behavior</strong>: Lock liveness checks are deterministic across all clients</li><li><strong>High consistency</strong>: Eliminates race conditions caused by multi-client clock skew (unlike Firestore&#39;s client-time model)</li></ul><p><strong>Unified Tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> in interface.md for normative tolerance specification.</p><p><strong>Operational Considerations</strong>: See <a href="./interface#time-authority-tradeoffs">Time Authority Tradeoffs</a> for:</p><ul><li>When to choose Redis vs Firestore based on time authority requirements</li><li>Pre-production checklists and production monitoring guidance</li><li>Failure scenarios and mitigation strategies for server time authority</li><li>When Redis server time might fail (e.g., Redis cluster clock sync issues)</li></ul><hr><h2 id="backend-capabilities-and-type-safety" tabindex="-1">Backend Capabilities and Type Safety <a class="header-anchor" href="#backend-capabilities-and-type-safety" aria-label="Permalink to â€œBackend Capabilities and Type Safetyâ€">â€‹</a></h2><h3 id="requirements-5" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-5" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p>Redis backends MUST declare their specific capabilities for enhanced type safety:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RedisCapabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BackendCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;redis&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backend type discriminant</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  supportsFencing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Redis always provides fencing tokens</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  timeAuthority</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses Redis server time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redisBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RedisCapabilities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(config);</span></span></code></pre></div><h3 id="rationale-notes-5" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-5" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Ergonomic Usage</strong>: Since Redis always supports fencing, TypeScript provides compile-time guarantees:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisBackend.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ key: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;resource&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttlMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result.fence; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// No assertion needed - TypeScript knows this exists</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Type discriminant benefits</strong>: Enables pattern matching and type-safe backend switching in generic code.</p><hr><h2 id="script-implementation-patterns" tabindex="-1">Script Implementation Patterns <a class="header-anchor" href="#script-implementation-patterns" aria-label="Permalink to â€œScript Implementation Patternsâ€">â€‹</a></h2><p><strong>NORMATIVE IMPLEMENTATION</strong>: See <code>redis/scripts.ts</code> for canonical Lua scripts with inline documentation.</p><h3 id="script-characteristics" tabindex="-1">Script Characteristics <a class="header-anchor" href="#script-characteristics" aria-label="Permalink to â€œScript Characteristicsâ€">â€‹</a></h3><p>Scripts implement these atomic operation patterns:</p><ul><li><strong>Acquire</strong>: Expiry check â†’ fence increment â†’ dual-key write with identical TTL</li><li><strong>Release/Extend</strong>: Reverse lookup (ADR-013) â†’ ownership verification (ADR-003) â†’ mutation</li><li><strong>Lookup</strong>: Atomic multi-key read with ownership verification</li></ul><p>All scripts use:</p><ul><li>Canonical time calculation: <code>time[1] * 1000 + math.floor(time[2] / 1000)</code> (see <code>calculateRedisServerTimeMs()</code>)</li><li>Unified liveness predicate: <code>isLive()</code> pattern from <code>common/time-predicates.ts</code></li><li>15-digit fence formatting: <code>string.format(&quot;%015d&quot;, redis.call(&#39;INCR&#39;, fenceKey))</code> for Lua precision safety</li></ul><h3 id="script-return-code-semantics" tabindex="-1">Script Return Code Semantics <a class="header-anchor" href="#script-return-code-semantics" aria-label="Permalink to â€œScript Return Code Semanticsâ€">â€‹</a></h3><p>Backend operations use these standardized return codes for internal condition tracking:</p><p><strong>Acquire</strong>:</p><ul><li><code>0</code> â†’ contention (lock held by another process)</li><li><code>[1, fence, expiresAtMs]</code> â†’ success with fence token and authoritative server-time expiry</li></ul><p><strong>Release</strong>:</p><ul><li><code>1</code> â†’ success</li><li><code>0</code> â†’ ownership mismatch (ADR-003)</li><li><code>-1</code> â†’ not found</li><li><code>-2</code> â†’ expired</li></ul><p><strong>Extend</strong>:</p><ul><li><code>[1, newExpiresAtMs]</code> â†’ success with authoritative server-time expiry</li><li><code>0</code> â†’ ownership mismatch (ADR-003)</li><li><code>-1</code> â†’ not found</li><li><code>-2</code> â†’ expired</li></ul><h3 id="rationale-notes-6" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-6" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why centralized in redis/scripts.ts</strong>: Single source of truth prevents script duplication and drift. See module for KEYS/ARGV signatures and complete implementation details.</p><p><strong>Why return codes</strong>: Enables cheap internal condition tracking for telemetry without additional I/O. Public API simplifies to <code>{ ok: boolean }</code> for release/extend operations.</p><hr><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to â€œError Handlingâ€">â€‹</a></h2><h3 id="requirements-6" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-6" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p><strong>MUST follow <a href="./interface#centralized-error-mapping">common spec ErrorMappingStandard</a></strong>.</p><p><strong>Key Redis mappings</strong>:</p><ul><li><strong>ServiceUnavailable</strong>: Connection errors (<code>ECONNRESET</code>, <code>ENOTFOUND</code>, <code>ECONNREFUSED</code>)</li><li><strong>AuthFailed</strong>: <code>NOAUTH</code>, <code>WRONGPASS</code>, <code>NOPERM</code></li><li><strong>InvalidArgument</strong>: <code>WRONGTYPE</code>, <code>SYNTAX</code>, <code>INVALID</code></li><li><strong>NetworkTimeout</strong>: Client/operation timeouts</li><li><strong>Aborted</strong>: Operation cancelled via AbortSignal</li></ul><p><strong>Implementation Pattern</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  isLive,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  calculateRedisServerTimeMs,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;../common/time-predicates.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Release/extend operations use script return codes</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> scriptReturnCode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">evalsha</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* script */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Public API: simplified boolean result</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> success</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scriptReturnCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Internal detail tracking (best-effort, for decorator consumption if telemetry enabled)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> detail</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scriptReturnCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;expired&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;not-found&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ok: success };</span></span></code></pre></div><p><strong>Release/Extend Script Return Codes</strong>:</p><ul><li><code>1</code> â†’ success</li><li><code>0</code> â†’ ownership mismatch (ADR-003) â†’ internal: &quot;not-found&quot;</li><li><code>-1</code> â†’ never existed/cleaned up â†’ internal: &quot;not-found&quot;</li><li><code>-2</code> â†’ deterministically observed expired â†’ internal: &quot;expired&quot;</li></ul><h3 id="rationale-notes-7" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-7" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why return codes instead of error strings</strong>: More efficient. Numbers are cheaper to parse than strings in Lua/JSON.</p><p><strong>Why track internal details</strong>: Enables rich telemetry when decorator is enabled, without cluttering public API.</p><hr><h2 id="ttl-management" tabindex="-1">TTL Management <a class="header-anchor" href="#ttl-management" aria-label="Permalink to â€œTTL Managementâ€">â€‹</a></h2><h3 id="requirements-7" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-7" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><ul><li>Use milliseconds directly with PX: <code>ttlMs</code></li><li>Use Redis <code>PX</code> option, not separate <code>EXPIRE</code> calls</li><li><strong>Cleanup Configuration</strong>: Optional <code>cleanupInIsLocked: boolean</code> (default: <code>false</code>) - when enabled, allows fire-and-forget cleanup in isLocked operation <ul><li><strong>CRITICAL</strong>: Cleanup MUST ONLY delete lock data keys (main lock key and reverse index key), NEVER fence counter keys</li><li><strong>Configuration Validation</strong>: Backend MUST validate at initialization that <code>keyPrefix</code> configuration does not create overlap between lock data and fence counter namespaces</li><li>If misconfiguration could result in fence counter deletion, backend MUST throw <code>LockError(&quot;InvalidArgument&quot;)</code> with descriptive message</li></ul></li></ul><h3 id="rationale-notes-8" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-8" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why PX not EXPIRE</strong>: Single atomic operation. <code>SET key value PX ttl</code> is atomic; <code>SET</code> then <code>EXPIRE</code> creates race window.</p><p><strong>Why validate fence counter namespace</strong>: Prevents catastrophic bugs where cleanup accidentally deletes fence counters, breaking monotonicity guarantees.</p><hr><h2 id="operation-specific-behavior" tabindex="-1">Operation-Specific Behavior <a class="header-anchor" href="#operation-specific-behavior" aria-label="Permalink to â€œOperation-Specific Behaviorâ€">â€‹</a></h2><h3 id="acquire-operation-requirements" tabindex="-1">Acquire Operation Requirements <a class="header-anchor" href="#acquire-operation-requirements" aria-label="Permalink to â€œAcquire Operation Requirementsâ€">â€‹</a></h3><p><strong>Direct script return mapping</strong> (not semantic helper):</p><table tabindex="0"><thead><tr><th>Script Return</th><th>Backend Result</th></tr></thead><tbody><tr><td><code>0</code></td><td><code>{ ok: false, reason: &quot;locked&quot; }</code> (contention)</td></tr><tr><td><code>[1, fence, expiresAtMs]</code></td><td><code>{ ok: true, lockId, expiresAtMs, fence }</code> (success)</td></tr></tbody></table><ul><li><strong>MUST return authoritative expiresAtMs</strong>: Computed from Redis server time authority (<code>redis.call(&#39;TIME&#39;)</code>) to ensure consistency and accurate heartbeat scheduling. No client-side approximation allowed (see ADR-010).</li><li><strong>System Errors</strong>: Backend throws <code>LockError</code> for Redis connection/command failures</li><li><strong>Single-attempt operations</strong>: Redis backends perform single attempts only; retry logic is handled by the lock() helper</li></ul><h3 id="release-operation-requirements" tabindex="-1">Release Operation Requirements <a class="header-anchor" href="#release-operation-requirements" aria-label="Permalink to â€œRelease Operation Requirementsâ€">â€‹</a></h3><ul><li><strong>LockId Validation</strong>: MUST call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li><li><strong>MUST implement <a href="./interface#storage-requirements">TOCTOU Protection</a></strong> via atomic Lua scripts. Return simplified <code>{ ok: boolean }</code> results. Track internal details cheaply when available for potential telemetry decorator consumption.</li></ul><h3 id="extend-operation-requirements" tabindex="-1">Extend Operation Requirements <a class="header-anchor" href="#extend-operation-requirements" aria-label="Permalink to â€œExtend Operation Requirementsâ€">â€‹</a></h3><ul><li><strong>LockId Validation</strong>: MUST call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li><li><strong>MUST return authoritative expiresAtMs</strong>: Computed from Redis server time authority (<code>redis.call(&#39;TIME&#39;)</code>) to ensure consistency and accurate heartbeat scheduling. No client-side approximation allowed (see ADR-010).</li><li><strong>MUST implement <a href="./interface#storage-requirements">TOCTOU Protection</a></strong> via atomic Lua scripts. TTL semantics: replaces remaining TTL entirely (<code>now + ttlMs</code>).</li></ul><h3 id="islocked-operation-requirements" tabindex="-1">IsLocked Operation Requirements <a class="header-anchor" href="#islocked-operation-requirements" aria-label="Permalink to â€œIsLocked Operation Requirementsâ€">â€‹</a></h3><ul><li><strong>Use Case</strong>: Simple boolean checks (prefer <code>lookup()</code> for diagnostics)</li><li><strong>Locked/Unlocked</strong>: Backend returns <code>true</code>/<code>false</code> based on key existence and expiry</li><li><strong>Read-Only by Default</strong>: Cleanup disabled by default to maintain pure read semantics</li><li><strong>Optional Cleanup</strong>: When <code>cleanupInIsLocked: true</code> configured, MAY perform fire-and-forget cleanup following common spec guidelines</li><li><strong>System Errors</strong>: Backend throws <code>LockError</code> for Redis failures</li></ul><h3 id="lookup-operation-requirements" tabindex="-1">Lookup Operation Requirements <a class="header-anchor" href="#lookup-operation-requirements" aria-label="Permalink to â€œLookup Operation Requirementsâ€">â€‹</a></h3><p><strong>Runtime Validation</strong>: MUST validate inputs before any I/O operations:</p><ul><li><strong>Key mode</strong>: Call <code>normalizeAndValidateKey(key)</code> and fail fast on invalid keys</li><li><strong>LockId mode</strong>: Call <code>validateLockId(lockId)</code> and throw <code>LockError(&quot;InvalidArgument&quot;)</code> on malformed input</li></ul><p><strong>Key Lookup Mode</strong>:</p><ul><li><strong>Implementation</strong>: Direct access to main lock key: <code>redis.call(&#39;GET&#39;, lockKey)</code></li><li><strong>Complexity</strong>: O(1) direct access (single operation)</li><li><strong>Atomicity</strong>: Single GET operation (inherently atomic)</li><li><strong>Performance</strong>: Direct key-value access, sub-millisecond latency</li></ul><p><strong>LockId Lookup Mode</strong>:</p><ul><li><strong>Implementation</strong>: MUST use atomic Lua script that reads reverse index and main lock in single operation</li><li><strong>Complexity</strong>: Multi-step (reverse mapping + verification)</li><li><strong>Atomicity</strong>: MUST be atomic via Lua script to prevent TOCTOU races</li><li><strong>Performance</strong>: Atomic script execution, consistent sub-millisecond performance</li></ul><p><strong>Common Requirements</strong>:</p><ul><li><strong>Ownership Verification</strong>: Script MUST verify <code>data.lockId === lockId</code> after parsing lock data</li><li><strong>Expiry Check</strong>: Parse JSON and apply <code>isLive()</code> predicate using <code>calculateRedisServerTimeMs()</code> and <code>TIME_TOLERANCE_MS</code></li><li><strong>Data Transformation Requirement</strong>: Lua script returns full JSON lockData. TypeScript lookup method MUST parse, compute keyHash and lockIdHash using <code>hashKey()</code>, and return sanitized <code>LockInfo&lt;C&gt;</code></li><li><strong>âš ï¸ FORBIDDEN: Raw Data Pass-Through</strong>: TypeScript layer MUST sanitize all data before returning. Raw Lua JSON MUST NEVER surface through public API</li><li><strong>Return Value</strong>: Return <code>null</code> if key doesn&#39;t exist or is expired; return <code>LockInfo&lt;C&gt;</code> for live locks (MUST include <code>fence</code>)</li></ul><h3 id="rationale-notes-9" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-9" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why atomic lookup script</strong>: Multi-key reads need atomicity. Without script, lock could expire between reading index and reading main key.</p><p><strong>Why sanitize in TypeScript</strong>: Lua optimizes for atomicity, TypeScript optimizes for security. Clean separation of concerns.</p><hr><h2 id="implementation-architecture" tabindex="-1">Implementation Architecture <a class="header-anchor" href="#implementation-architecture" aria-label="Permalink to â€œImplementation Architectureâ€">â€‹</a></h2><h3 id="requirements-8" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-8" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><ul><li><strong>Backend creation</strong>: <code>createRedisBackend()</code> defines commands via <code>redis.defineCommand()</code></li><li><strong>Operations</strong>: Use defined commands (e.g., <code>redis.acquireLock()</code>) when available</li><li><strong>Test compatibility</strong>: Falls back to <code>redis.eval()</code> for mocked Redis instances</li><li><strong>Fence Type</strong>: Redis backend uses <code>string</code> fence type to avoid JSON precision loss beyond 2^53-1</li></ul><h3 id="performance-characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#performance-characteristics" aria-label="Permalink to â€œPerformance Characteristicsâ€">â€‹</a></h3><ul><li>Sub-millisecond latency</li><li>25k+ ops/sec with cached scripts</li><li>Direct key-value access provides consistently fast operations</li><li>lookup Implementation: Required - supports both key and lockId lookup patterns</li></ul><h3 id="rationale-notes-10" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-10" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why defineCommand at creation</strong>: ioredis caches script SHAs globally per client. Defining at initialization ensures EVALSHA available for all subsequent calls.</p><p><strong>Why string fence type</strong>: JavaScript numbers lose precision beyond 2^53-1. Strings preserve full 15-digit fence values without precision loss.</p><hr><h2 id="configuration-options" tabindex="-1">Configuration Options <a class="header-anchor" href="#configuration-options" aria-label="Permalink to â€œConfiguration Optionsâ€">â€‹</a></h2><h3 id="requirements-9" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-9" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RedisBackendConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  keyPrefix</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default: &quot;syncguard&quot;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  cleanupInIsLocked</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default: false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... other Redis-specific options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Consistent behavior with unified tolerance</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redisBackend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uses TIME_TOLERANCE_MS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Add telemetry if needed</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> observed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> withTelemetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redisBackend, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  includeRaw: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Unified tolerance</strong>: See <code>TIME_TOLERANCE_MS</code> in interface.md for normative specification</p><h3 id="rationale-notes-11" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-11" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why default prefix &quot;syncguard&quot;</strong>: Namespace collision prevention. Allows multiple libraries to coexist in same Redis instance.</p><p><strong>Why cleanupInIsLocked optional</strong>: Read-only expectation by default. Cleanup opt-in preserves predictable behavior.</p><hr><h2 id="key-naming" tabindex="-1">Key Naming <a class="header-anchor" href="#key-naming" aria-label="Permalink to â€œKey Namingâ€">â€‹</a></h2><h3 id="requirements-10" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-10" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p>All key types MUST use <code>makeStorageKey()</code> from common utilities with backend-specific effective key budget (<code>EFFECTIVE_KEY_BUDGET_BYTES = 1000</code>) and 26-byte reserve:</p><ul><li><p><strong>Main lock</strong>: <code>baseKey = makeStorageKey(config.keyPrefix, key, 1000, 26)</code></p><ul><li>Reserve: 26 bytes for derived keys (index keys)</li></ul></li><li><p><strong>Index key</strong>: <code>makeStorageKey(config.keyPrefix, </code>id:${lockId}<code>, 1000, 26)</code></p><ul><li>Reserve: 26 bytes (same reserve for consistency)</li></ul></li><li><p><strong>Fence key</strong>: MUST use <a href="./interface#fence-key-derivation">Two-Step Fence Key Derivation Pattern</a>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> baseKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(config.keyPrefix, normalizedKey, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">26</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fenceKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> makeStorageKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  config.keyPrefix,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `fence:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  26</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li>Reserve: 26 bytes (ensures fence keys don&#39;t exceed budget when derived from base)</li></ul></li><li><p><strong>Default prefix</strong>: <code>&quot;syncguard&quot;</code></p></li><li><p><strong>Reserve bytes constant</strong>: 26</p></li></ul><h3 id="rationale-notes-12" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-12" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why two-step fence derivation</strong>: Guarantees 1:1 mapping between user keys and fence counters. See interface.md for complete rationale.</p><hr><h2 id="required-lock-data-structure" tabindex="-1">Required Lock Data Structure <a class="header-anchor" href="#required-lock-data-structure" aria-label="Permalink to â€œRequired Lock Data Structureâ€">â€‹</a></h2><h3 id="requirements-11" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-11" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LockData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lockId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// For ownership verification</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  expiresAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Millisecond timestamp</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  acquiredAtMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Millisecond timestamp</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Original user key</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  fence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Monotonic fencing token (15-digit zero-padded string)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="rationale-notes-13" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-13" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why include key in lock data</strong>: Debugging and telemetry. Allows reconstruction of full lock state from main key alone.</p><p><strong>Why fence as string</strong>: Preserves precision. JavaScript/Lua number precision limits don&#39;t affect string representation.</p><hr><h2 id="fencing-token-implementation" tabindex="-1">Fencing Token Implementation <a class="header-anchor" href="#fencing-token-implementation" aria-label="Permalink to â€œFencing Token Implementationâ€">â€‹</a></h2><h3 id="requirements-12" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-12" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><div class="language-lua"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Fence Counter Increment Pattern (within acquire script):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fenceKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Pre-constructed via two-step pattern</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Format immediately as 15-digit string for guaranteed Lua precision safety</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string.format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%015d&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;INCR&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fenceKey))</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Store fence in lock data JSON and return with AcquireResult</span></span></code></pre></div><p><strong>Required Implementation Details:</strong></p><ul><li><strong>Fence Key Generation</strong>: MUST use <a href="./interface#fence-key-derivation">Two-Step Fence Key Derivation Pattern</a> from interface.md</li><li><strong>Atomicity</strong>: <code>INCR</code> MUST be called within the same Lua script as lock acquisition</li><li><strong>Persistence</strong>: Fence counters survive Redis restarts (no TTL on fence keys)</li><li><strong>Monotonicity</strong>: Each successful <code>acquire()</code> increments the counter, ensuring strict ordering</li><li><strong>Storage</strong>: Store the fence value in <code>LockData.fence</code> and return in <code>AcquireResult.fence</code></li><li><strong>Format</strong>: 15-digit zero-padded decimal strings for lexicographic ordering and JSON safety</li><li><strong>Overflow Enforcement (ADR-004)</strong>: Backend MUST parse returned fence value and throw <code>LockError(&quot;Internal&quot;)</code> if fence &gt; <code>FENCE_THRESHOLDS.MAX</code>; MUST log warnings via <code>logFenceWarning()</code> when fence &gt; <code>FENCE_THRESHOLDS.WARN</code>. Canonical threshold values defined in <code>common/constants.ts</code>.</li></ul><h3 id="rationale-notes-14" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-14" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why format in Lua</strong>: Guarantees precision safety. Lua&#39;s 53-bit precision accommodates 15-digit decimals without loss.</p><p><strong>Why no TTL on fence keys</strong>: Monotonicity requires persistence. Deleting fence counter would allow reuse, violating safety guarantees.</p><hr><h2 id="fence-key-lifecycle-and-memory-considerations" tabindex="-1">Fence Key Lifecycle and Memory Considerations <a class="header-anchor" href="#fence-key-lifecycle-and-memory-considerations" aria-label="Permalink to â€œFence Key Lifecycle and Memory Considerationsâ€">â€‹</a></h2><h3 id="requirements-13" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-13" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><p><strong>CRITICAL: Fence keys are intentionally persistent</strong> and MUST NOT have TTL or be deleted:</p><div class="language-lua"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- âŒ NEVER do this - breaks monotonicity guarantee</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;DEL&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fenceKey)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Violates fencing safety</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;EXPIRE&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fenceKey, ttl)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Violates fencing safety</span></span></code></pre></div><h3 id="rationale-notes-15" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-15" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Memory Growth</strong>: Fence counters accumulate over Redis instance lifetime. This is correct behavior for fencing safety.</p><p><strong>Bounded key spaces</strong>: Most applications use predictable lock keys â†’ minimal memory impact <strong>Unbounded key spaces</strong>: Applications generating unlimited unique keys â†’ fence keys grow indefinitely <strong>Mitigation</strong>: For unbounded scenarios, consider key normalization or application-level limits</p><p><strong>Operational Guidance</strong>:</p><ul><li>Monitor fence key count via <code>redis-cli --scan --pattern &quot;syncguard:fence:*&quot; | wc -l</code></li><li>Each fence key is ~50-100 bytes (key name + 8-byte counter)</li><li>1M fence keys â‰ˆ 50-100MB memory (typically acceptable)</li></ul><p><strong>When to be concerned</strong>: If your application generates &gt;10M unique lock keys annually, evaluate key design patterns.</p><hr><h2 id="testing-strategy" tabindex="-1">Testing Strategy <a class="header-anchor" href="#testing-strategy" aria-label="Permalink to â€œTesting Strategyâ€">â€‹</a></h2><h3 id="requirements-14" tabindex="-1">Requirements <a class="header-anchor" href="#requirements-14" aria-label="Permalink to â€œRequirementsâ€">â€‹</a></h3><ul><li><strong>Unit tests</strong>: Mock Redis with <code>eval</code> method, no external dependencies</li><li><strong>Integration tests</strong>: Real Redis instance, validates <code>defineCommand()</code> caching</li><li><strong>Performance tests</strong>: Benchmarks latency, throughput, and script caching benefits</li><li><strong>Behavioral compliance testing</strong>: Unit tests MUST verify backend imports and uses <code>isLive()</code> and <code>calculateRedisServerTimeMs()</code> from <code>common/time-predicates.ts</code></li><li><strong>Cross-backend consistency</strong>: Integration tests MUST verify identical outcomes given same tolerance values between Redis and other backends</li></ul><h3 id="rationale-notes-16" tabindex="-1">Rationale &amp; Notes <a class="header-anchor" href="#rationale-notes-16" aria-label="Permalink to â€œRationale &amp; Notesâ€">â€‹</a></h3><p><strong>Why unit tests with mocks</strong>: Fast feedback loop. No external dependencies for basic correctness checks.</p><p><strong>Why integration tests with real Redis</strong>: Validates script caching, network behavior, actual atomicity guarantees.</p><p><strong>Why cross-backend tests</strong>: Ensures API consistency. Users should get identical behavior regardless of backend choice (accounting for time authority differences).</p></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kriasoft/syncguard/edit/main/docs/specs/redis-backend.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-3c637f39>Last updated: <time datetime="2025-12-02T19:52:51.000Z" data-v-3c637f39></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><!----></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/syncguard/what-is-syncguard" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>What is SyncGuard?</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-1df9f90f data-v-c3855bb3><div class="container" data-v-c3855bb3><p class="message" data-v-c3855bb3>Released under the <a href="https://github.com/kriasoft/syncguard/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-c3855bb3>Copyright Â© 2025-present <a href="https://kriasoft.com" target="_self">Kriasoft</a> Â· Created by <a href="https://github.com/koistya">Konstantin Tarkus</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"adr_000-template.md\":\"BYd1H7EV\",\"adr_003-explicit-ownership-verification.md\":\"CrOAT8nL\",\"adr_004-lexicographic-fence-comparison.md\":\"Drck3Sbp\",\"adr_005-unified-time-tolerance.md\":\"DMCQGcIM\",\"adr_006-mandatory-key-truncation.md\":\"kqKSzXr4\",\"adr_007-opt-in-telemetry.md\":\"Dru7k4_S\",\"adr_008-compile-time-fencing.md\":\"Hx6BUudm\",\"adr_009-retries-in-helpers.md\":\"5jQqlnHS\",\"adr_010-authoritative-expiresat.md\":\"DlswW7wl\",\"adr_011-relaxed-lookup-atomicity.md\":\"DTxMiTJg\",\"adr_012-backend-restatement-pattern.md\":\"BGXQZJVs\",\"adr_013-full-storage-key-in-index.md\":\"4EljCf2Q\",\"adr_014-firestore-duplicate-detection.md\":\"DwrqhQz8\",\"adr_015-async-raii-locks.md\":\"OnHFH4dq\",\"adr_016-disposal-timeout.md\":\"BVohCKfn\",\"adr_index.md\":\"luaogR7b\",\"api.md\":\"DvLLVzpl\",\"core-concepts.md\":\"CG2Uz1mC\",\"fencing.md\":\"DH7hxlo1\",\"firestore.md\":\"CG_nAcqJ\",\"getting-started.md\":\"mjF2b5ww\",\"index.md\":\"CU0V5iVn\",\"issues_time-tolerance.local.md\":\"DrKuAaw8\",\"postgres.md\":\"wOj7Pm3f\",\"redis.md\":\"vVFQZA9N\",\"reference.md\":\"atnObe8h\",\"specs_firestore-backend.md\":\"DBnmDxlp\",\"specs_interface.md\":\"DOQTAngr\",\"specs_postgres-backend.md\":\"DsTdd-iS\",\"specs_readme.md\":\"D1p1hkn_\",\"specs_redis-backend.md\":\"C1GS07Xf\",\"what-is-syncguard.md\":\"BLAjahmf\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"ðŸ”’ SyncGuard\",\"description\":\"TypeScript distributed lock library that prevents race conditions across services. Because nobody wants their payment processed twice! ðŸ’¸\",\"base\":\"/syncguard/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Guide\",\"link\":\"/what-is-syncguard\"},{\"text\":\"Backends\",\"link\":\"/redis\"},{\"text\":\"Reference\",\"link\":\"/api\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/kriasoft/syncguard/edit/main/docs/:path\",\"text\":\"Edit this page on GitHub\"},\"sidebar\":[{\"text\":\"Guide\",\"items\":[{\"text\":\"What is SyncGuard?\",\"link\":\"/what-is-syncguard\"},{\"text\":\"Getting Started\",\"link\":\"/getting-started\"},{\"text\":\"Core Concepts\",\"link\":\"/core-concepts\"},{\"text\":\"Fencing Tokens\",\"link\":\"/fencing\"}]},{\"text\":\"Backends\",\"items\":[{\"text\":\"Redis\",\"link\":\"/redis\"},{\"text\":\"PostgreSQL\",\"link\":\"/postgres\"},{\"text\":\"Firestore\",\"link\":\"/firestore\"}]},{\"text\":\"API\",\"items\":[{\"text\":\"API Reference\",\"link\":\"/api\"}]},{\"text\":\"For Developers\",\"items\":[{\"text\":\"Specifications\",\"link\":\"https://github.com/kriasoft/syncguard/tree/main/docs/specs\"},{\"text\":\"Architecture Decisions\",\"link\":\"https://github.com/kriasoft/syncguard/tree/main/docs/adr\"},{\"text\":\"Contributing\",\"link\":\"https://github.com/kriasoft/syncguard/blob/main/.github/CONTRIBUTING.md\"},{\"text\":\"Security Policy\",\"link\":\"https://github.com/kriasoft/syncguard/blob/main/.github/SECURITY.md\"},{\"text\":\"Sponsor\",\"link\":\"https://github.com/sponsors/koistya\"}]}],\"socialLinks\":[{\"icon\":\"x\",\"link\":\"https://x.com/kriasoft\"},{\"icon\":\"discord\",\"link\":\"https://discord.gg/EnbEa7Gsxg\"},{\"icon\":\"github\",\"link\":\"https://github.com/kriasoft/syncguard\"}],\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/kriasoft/syncguard/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright Â© 2025-present <a href=\\\"https://kriasoft.com\\\" target=\\\"_self\\\">Kriasoft</a> Â· Created by <a href=\\\"https://github.com/koistya\\\">Konstantin Tarkus</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>